<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>k1lib.kop &mdash; k1lib  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> k1lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../base.html">Base module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli/index.html">k1lib.cli module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/index.html">k1lib.callbacks module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../k1a.html">k1lib._k1a module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../k1ui.html">k1lib.k1ui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../eqn.html">k1lib.eqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fmt.html">k1lib.fmt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphEqn.html">k1lib.graphEqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imports.html">k1lib.imports module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mo.html">k1lib.mo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kast.html">k1lib.kast module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kcom.html">k1lib.kcom module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../knn.html">k1lib.knn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kop.html">k1lib.kop module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kws.html">k1lib.kws module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../p5.html">k1lib.p5 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schedule.html">k1lib.schedule module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../selector.html">k1lib.selector module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../selen.html">k1lib.selen module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serpent.html">k1lib.serpent module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serve.html">k1lib.serve module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">k1lib.viz module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zircon.html">k1lib.zircon module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../monkey.html">Monkey patched classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelogs.html">Changelogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">k1lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">k1lib.kop</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for k1lib.kop</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED FILE! PLEASE DON&#39;T EDIT HERE. EDIT THE SOURCE NOTEBOOKS INSTEAD</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is for communication with hardware. This is exposed automatically with::</span>

<span class="sd">   from k1lib.imports import *</span>
<span class="sd">   kop.Rays.parallel(...) # exposed</span>

<span class="sd">A comprehensive introduction is available here: https://mlexps.com/optics/1-kop-intro/&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">k1lib</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">html</span><span class="o">,</span> <span class="nn">copy</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">k1lib</span> <span class="kn">import</span> <span class="n">cli</span><span class="p">,</span> <span class="n">p5</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Drawable&quot;</span><span class="p">,</span> <span class="s2">&quot;RandomPoints&quot;</span><span class="p">,</span> <span class="s2">&quot;Drawables&quot;</span><span class="p">,</span>
           <span class="s2">&quot;RaysFocus&quot;</span><span class="p">,</span> <span class="s2">&quot;Rays&quot;</span><span class="p">,</span> <span class="s2">&quot;Wavelengths&quot;</span><span class="p">,</span> <span class="s2">&quot;sellmeier&quot;</span><span class="p">,</span> <span class="s2">&quot;gps&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Surface&quot;</span><span class="p">,</span> <span class="s2">&quot;LineSurface&quot;</span><span class="p">,</span> <span class="s2">&quot;ArcSurface&quot;</span><span class="p">,</span> <span class="s2">&quot;polySolver&quot;</span><span class="p">,</span> <span class="s2">&quot;PolySurface&quot;</span><span class="p">,</span> <span class="s2">&quot;RaysPath&quot;</span><span class="p">,</span>
           <span class="s2">&quot;OpticElement&quot;</span><span class="p">,</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span> <span class="s2">&quot;Lens&quot;</span><span class="p">,</span> <span class="s2">&quot;OpticSystem&quot;</span><span class="p">]</span>
<span class="n">colormap_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">],[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">],[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">51</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">76</span><span class="p">],</span> <span class="p">[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="mi">26</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">105</span><span class="p">],</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">119</span><span class="p">],</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">136</span><span class="p">],</span> <span class="p">[</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">151</span><span class="p">],[</span><span class="mi">36</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">165</span><span class="p">],</span> <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">176</span><span class="p">],</span> <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">187</span><span class="p">],</span> <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">194</span><span class="p">],</span> <span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">202</span><span class="p">],</span> <span class="p">[</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">209</span><span class="p">],</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">217</span><span class="p">],</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">227</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">229</span><span class="p">],</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">233</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">237</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">237</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">242</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">244</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">244</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">244</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">244</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">242</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">242</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">239</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">236</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">236</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">232</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">229</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">227</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">218</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">214</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">209</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">205</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">194</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">193</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">189</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">182</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">177</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">172</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">165</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">159</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">153</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">147</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">140</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">134</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">131</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">126</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">124</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">122</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">118</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">118</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">116</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">114</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">113</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">112</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">111</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">109</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">107</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">107</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">108</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">99</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">96</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">97</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">94</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">88</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">81</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">77</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">71</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">68</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">60</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">52</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">43</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">33</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">84</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">98</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">111</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">124</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">137</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">151</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">162</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">173</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">186</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">198</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">211</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">221</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">227</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">237</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">240</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">1</span><span class="p">],[</span><span class="mi">242</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">245</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">248</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">251</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">252</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">254</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">254</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">253</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">253</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">254</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">254</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span> <span class="p">[</span><span class="mi">251</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">248</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="p">[</span><span class="mi">246</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">],</span> <span class="p">[</span><span class="mi">246</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">],</span> <span class="p">[</span><span class="mi">242</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span> <span class="p">[</span><span class="mi">242</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span> <span class="p">[</span><span class="mi">240</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="mi">237</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">],</span> <span class="p">[</span><span class="mi">233</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">],</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">44</span><span class="p">],</span> <span class="p">[</span><span class="mi">226</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">],</span> <span class="p">[</span><span class="mi">222</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">41</span><span class="p">],</span> <span class="p">[</span><span class="mi">218</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">39</span><span class="p">],</span> <span class="p">[</span><span class="mi">214</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">38</span><span class="p">],</span> <span class="p">[</span><span class="mi">206</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">],</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">34</span><span class="p">],</span> <span class="p">[</span><span class="mi">195</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="p">[</span><span class="mi">189</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="p">[</span><span class="mi">185</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">],</span> <span class="p">[</span><span class="mi">177</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="p">[</span><span class="mi">169</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">],</span> <span class="p">[</span><span class="mi">162</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span> <span class="p">[</span><span class="mi">152</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">],[</span><span class="mi">144</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="mi">136</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">121</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">],</span> <span class="p">[</span><span class="mi">111</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> <span class="p">[</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span> <span class="p">[</span><span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">88</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">83</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">73</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">67</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">62</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">51</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">colormap_nm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">colormap_rgb</span><span class="p">))</span> <span class="c1"># courtesy of https://stackoverflow.com/questions/71977306/how-to-convert-rgb-to-wavelength-in-python</span>
<span class="k">def</span> <span class="nf">wavelength_to_rgb</span><span class="p">(</span><span class="n">wavlgth</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">colormap_rgb</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colormap_nm</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">colormap_nm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">wavlgth</span><span class="p">))])</span> <span class="c1"># wavelength_to_rgb</span>
<div class="viewcode-block" id="Wavelengths"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Wavelengths">[docs]</a><span class="k">class</span> <span class="nc">Wavelengths</span><span class="p">:</span> <span class="c1"># vectorized version of wavelength_to_rgb                     # Wavelengths</span>
<div class="viewcode-block" id="Wavelengths.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Wavelengths.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavs</span><span class="p">:</span><span class="s2">&quot;List[int]&quot;</span><span class="p">):</span>                                        <span class="c1"># Wavelengths</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Container for wavelengths in nm. Pretty much only used to convert to rgb in vectorized way&quot;&quot;&quot;</span> <span class="c1"># Wavelengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wavs</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">())</span>                                 <span class="c1"># Wavelengths</span></div>
    <span class="k">def</span> <span class="nf">_toRgb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># Wavelengths</span>
        <span class="n">wavs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavs</span><span class="p">;</span> <span class="n">single</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>                          <span class="c1"># Wavelengths</span>
        <span class="k">if</span> <span class="n">single</span><span class="p">:</span> <span class="n">wavs</span> <span class="o">=</span> <span class="n">wavs</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>                                             <span class="c1"># Wavelengths</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">colormap_rgb</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">colormap_nm</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">wavs</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmin</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span> <span class="c1"># Wavelengths</span>
        <span class="k">return</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">single</span> <span class="k">else</span> <span class="n">ans</span>                                         <span class="c1"># Wavelengths</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Wavelengths #=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavs</span><span class="p">)</span><span class="si">}</span><span class="s2"> min=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavs</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">nm max=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavs</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">nm std=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavs</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2">nm&gt;&quot;</span> <span class="c1"># Wavelengths</span></div>
<span class="n">pi</span> <span class="o">=</span> <span class="mf">3.141592653589793</span><span class="p">;</span> <span class="n">inf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">);</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">();</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;kop&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;from k1lib.kop module, for optics-related tools&quot;</span><span class="p">);</span> <span class="c1"># Wavelengths</span>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">(),</span> <span class="s2">&quot;display settings&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;consts&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">(),</span> <span class="s2">&quot;magic constants throughout the sim. By default works pretty well, but you can tweak these if you need unrealistic setups, like super big focal length, etc&quot;</span><span class="p">)</span> <span class="c1"># Wavelengths</span>
<span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;drawable&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>                                <span class="c1"># Wavelengths</span>
                     <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;whether to add x and y axes to the sketch&quot;</span><span class="p">)</span> <span class="c1"># Wavelengths</span>
                     <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;maxWh&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="s2">&quot;when drawing a sketch, it will be rescaled so that the maximum of width and height of the final image is this number. Increase to make the sketch bigger&quot;</span><span class="p">)</span> <span class="c1"># Wavelengths</span>
                     <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;whether to add grid lines to the sketch&quot;</span><span class="p">)</span> <span class="c1"># Wavelengths</span>
                     <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;gridColor&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)),</span> <span class="s2">&quot;generic draw settings&quot;</span><span class="p">)</span> <span class="c1"># Wavelengths</span>
<div class="viewcode-block" id="Drawable"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawable">[docs]</a><span class="k">class</span> <span class="nc">Drawable</span><span class="p">:</span>                                                                  <span class="c1"># Drawable</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class to do common drawing routines&quot;&quot;&quot;</span>                               <span class="c1"># Drawable</span>
<div class="viewcode-block" id="Drawable.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawable.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># Drawable</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should return (x1, y1, x2, y2). Base classes should always implement this method&quot;&quot;&quot;</span> <span class="c1"># Drawable</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>                                                    <span class="c1"># Drawable</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="k">return</span> <span class="bp">NotImplemented</span>                               <span class="c1"># Drawable</span>
    <span class="k">def</span> <span class="nf">_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                       <span class="c1"># Drawable</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">();</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">drawable</span><span class="o">.</span><span class="n">maxWh</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="c1"># Drawable</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">:</span> <span class="n">bounds</span><span class="p">};</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">c</span><span class="p">}</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Drawables</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span> <span class="c1"># Drawable</span>
        <span class="n">p5</span><span class="o">.</span><span class="n">newSketch</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">xoff</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">yoff</span><span class="o">=</span><span class="n">ymin</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">background</span><span class="p">(</span><span class="mi">222</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">textSize</span><span class="p">(</span><span class="mi">12</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="c1"># Drawable</span>
        <span class="n">xm</span> <span class="o">=</span> <span class="n">xmin</span><span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span><span class="p">;</span> <span class="n">ym</span> <span class="o">=</span> <span class="n">ymin</span><span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span> <span class="c1"># xmin and ymin without padding           # Drawable</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">xticks</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">);</span> <span class="n">bsx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="mi">30</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># this is for when the width or height is too small to draw, then this will only draw a tick for every bsx ticks available # Drawable</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">xticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">];</span> <span class="n">bsx</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># if xmin == xmax                       # Drawable</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">yticks</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">);</span> <span class="n">bsy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="mi">30</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Drawable</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">yticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ymin</span><span class="p">];</span> <span class="n">bsy</span> <span class="o">=</span> <span class="mi">1</span>                                         <span class="c1"># Drawable</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">drawable</span><span class="o">.</span><span class="n">grid</span><span class="p">:</span>                                       <span class="c1"># Drawable</span>
            <span class="k">with</span> <span class="n">p5</span><span class="o">.</span><span class="n">context</span><span class="p">():</span>                                                   <span class="c1"># Drawable</span>
                <span class="n">p5</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">drawable</span><span class="o">.</span><span class="n">gridColor</span><span class="p">)</span>                  <span class="c1"># Drawable</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xticks</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">bsx</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ymin</span><span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ymax</span><span class="o">+</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span><span class="p">);</span> <span class="c1"># Drawable</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yticks</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">bsy</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">xmin</span><span class="o">-</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xmax</span><span class="o">+</span><span class="mi">20</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span> <span class="c1"># Drawable</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">drawable</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>                                       <span class="c1"># Drawable</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xticks</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">bsx</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ym</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">5</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">ym</span><span class="o">+</span><span class="mi">5</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="c1"># Drawable</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">yticks</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">bsy</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xm</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xm</span><span class="o">+</span><span class="mi">5</span><span class="o">/</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">5</span><span class="o">/</span><span class="n">s</span><span class="p">)</span> <span class="c1"># Drawable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>                                                       <span class="c1"># Drawable</span>
    <span class="k">def</span> <span class="nf">_repr_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>                                             <span class="c1"># Drawable</span>
    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">();</span> <span class="n">r</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_repr_extra</span><span class="p">()</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Drawable</span>
<div class="viewcode-block" id="Drawable.img"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawable.img">[docs]</a>    <span class="k">def</span> <span class="nf">img</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PIL.Image.Image&quot;</span><span class="p">:</span>                                          <span class="c1"># Drawable</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns PIL image&quot;&quot;&quot;</span>                                                  <span class="c1"># Drawable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">();</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">img</span><span class="p">()</span>                                      <span class="c1"># Drawable</span></div>
<div class="viewcode-block" id="Drawable.svg"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawable.svg">[docs]</a>    <span class="k">def</span> <span class="nf">svg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>                                                        <span class="c1"># Drawable</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns svg string&quot;&quot;&quot;</span>                                                 <span class="c1"># Drawable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess</span><span class="p">();</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>                                      <span class="c1"># Drawable</span></div></div>
<div class="viewcode-block" id="RandomPoints"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RandomPoints">[docs]</a><span class="k">class</span> <span class="nc">RandomPoints</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span> <span class="c1"># displays random points                           # RandomPoints</span>
<div class="viewcode-block" id="RandomPoints.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RandomPoints.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>                                                    <span class="c1"># RandomPoints</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Container to place random points to be graphed either alone or inside a :class:`Drawables`&quot;&quot;&quot;</span> <span class="c1"># RandomPoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toNdArray</span><span class="p">()</span>                         <span class="c1"># RandomPoints</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="p">[</span><span class="n">p5</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">];</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># RandomPoints</span>
<div class="viewcode-block" id="RandomPoints.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RandomPoints.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># RandomPoints</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">RandomPoints</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>                  <span class="c1"># RandomPoints</span></div>
<div class="viewcode-block" id="Drawables"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawables">[docs]</a><span class="k">class</span> <span class="nc">Drawables</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span> <span class="c1"># a container to just draw everything out             # Drawables</span>
<div class="viewcode-block" id="Drawables.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawables.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drawables</span><span class="p">:</span><span class="s2">&quot;List[Drawable]&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                 <span class="c1"># Drawables</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A container with multiple :class:`Drawable`s, to draw out everything possible within a single coordinate frame&quot;&quot;&quot;</span> <span class="c1"># Drawables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawables</span> <span class="o">=</span> <span class="n">drawables</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="p">{}</span>                   <span class="c1"># Drawables</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">Drawables</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawables</span><span class="p">])</span> <span class="c1"># Drawables</span>
<div class="viewcode-block" id="Drawables.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Drawables.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawables</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># Drawables</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">_draw</span><span class="p">({</span><span class="o">**</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">})</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawables</span><span class="p">];</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># Drawables</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Drawables #n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drawables</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>           <span class="c1"># Drawables</span></div>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;colorD&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rainbow&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">650</span><span class="p">],</span> <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">620</span><span class="p">,</span> <span class="mi">750</span><span class="p">],</span> <span class="s2">&quot;orange&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">590</span><span class="p">,</span> <span class="mi">620</span><span class="p">],</span> <span class="s2">&quot;yellow&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">570</span><span class="p">,</span> <span class="mi">590</span><span class="p">],</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">495</span><span class="p">,</span> <span class="mi">570</span><span class="p">],</span> <span class="s2">&quot;blue&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">450</span><span class="p">,</span> <span class="mi">495</span><span class="p">],</span> <span class="s2">&quot;purple&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">450</span><span class="p">]},</span> <span class="s2">&quot;color wavelength ranges to be used in constructing Rays&quot;</span><span class="p">)</span> <span class="c1"># Drawables</span>
<span class="k">def</span> <span class="nf">color_interpreter</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>                                                   <span class="c1"># color_interpreter</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                     <span class="c1"># color_interpreter</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">colorD</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Does not understand the color &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;. Current options are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">colorD</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. You can set your own custom colors using `settings.kop.colorD`&quot;</span><span class="p">)</span> <span class="c1"># color_interpreter</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">colorD</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">N</span><span class="p">)</span>                             <span class="c1"># color_interpreter</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">col</span>           <span class="c1"># color_interpreter</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="n">col</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># color_interpreter</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Does not understand the color/wavelength &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;. It can be a string like &#39;red&#39;, a specific wavelength in nm (450), or a list/tuple with 2 floats specifying start and end wavelengths&quot;</span><span class="p">)</span> <span class="c1"># color_interpreter</span>
<span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;rays&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;showOrigin&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;whether to add a small red dot to the beginning of the mean (x,y) of a Rays or not&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;infLength&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;length in mm to display Rays if their length is infinite&quot;</span><span class="p">),</span> <span class="s2">&quot;display settings of kop.Rays&quot;</span><span class="p">)</span> <span class="c1"># color_interpreter</span>
<div class="viewcode-block" id="RaysFocus"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RaysFocus">[docs]</a><span class="k">class</span> <span class="nc">RaysFocus</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                       <span class="c1"># RaysFocus</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">:</span><span class="s2">&quot;Rays&quot;</span><span class="p">):</span>                                             <span class="c1"># RaysFocus</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rays</span><span class="p">;</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">];</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][:,</span><span class="kc">None</span><span class="p">];</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">];</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">];</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][</span><span class="kc">None</span><span class="p">];</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span> <span class="c1"># RaysFocus</span>
        <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span> <span class="n">det</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t2</span><span class="p">));</span> <span class="bp">self</span><span class="o">.</span><span class="n">rays</span> <span class="o">=</span> <span class="n">rays</span> <span class="c1"># RaysFocus</span>
        <span class="n">invalids</span> <span class="o">=</span> <span class="n">det</span><span class="o">==</span><span class="n">inf</span><span class="p">;</span> <span class="n">det</span><span class="p">[</span><span class="n">invalids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">det</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">det</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span> <span class="n">c</span> <span class="o">=</span> <span class="n">det</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span> <span class="n">d</span> <span class="o">=</span> <span class="n">det</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="c1"># RaysFocus</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t1</span><span class="p">))[</span><span class="o">~</span><span class="n">invalids</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t1</span><span class="p">))[</span><span class="o">~</span><span class="n">invalids</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">])</span> <span class="c1"># RaysFocus</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xs</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">ymedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ys</span><span class="p">)</span> <span class="c1"># RaysFocus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="o">+</span><span class="n">xmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span><span class="o">+</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">ystd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="c1"># RaysFocus</span>
<div class="viewcode-block" id="RaysFocus.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RaysFocus.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># RaysFocus</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>                                                     <span class="c1"># RaysFocus</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">];</span> <span class="n">pointSize</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">100</span> <span class="c1"># RaysFocus</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">T</span><span class="p">:</span> <span class="n">p5</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pointSize</span><span class="p">)</span>                       <span class="c1"># RaysFocus</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># RaysFocus</span>
        <span class="n">xdigits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">ydigits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># RaysFocus</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;RaysFocus N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> xrange=(</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="n">xdigits</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmedian</span><span class="p">,</span><span class="w"> </span><span class="n">xdigits</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="n">xdigits</span><span class="p">)</span><span class="si">}</span><span class="s2">) xstd=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xstd</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s2"> yrange=(</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span><span class="w"> </span><span class="n">ydigits</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymedian</span><span class="p">,</span><span class="w"> </span><span class="n">ydigits</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span><span class="w"> </span><span class="n">ydigits</span><span class="p">)</span><span class="si">}</span><span class="s2">) ystd=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ystd</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># RaysFocus</span></div>
<div class="viewcode-block" id="Rays"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays">[docs]</a><span class="k">class</span> <span class="nc">Rays</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                            <span class="c1"># Rays</span>
<div class="viewcode-block" id="Rays.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">prevRays</span><span class="p">:</span><span class="s2">&quot;Rays&quot;</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ogSurface</span><span class="p">:</span><span class="s2">&quot;Surface&quot;</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    <span class="c1"># Rays</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents a bunch of rays, stored in a numpy array so that all</span>
<span class="sd">operations are fast</span>

<span class="sd">`data` format: array of shape (N, 6)</span>
<span class="sd">- 0) x coordinate of starting point</span>
<span class="sd">- 1) y coordinate of starting point</span>
<span class="sd">- 2) angle counter clockwise from positive x axis</span>
<span class="sd">- 3) length (inf for forever)</span>
<span class="sd">- 4) wavelength in nm</span>
<span class="sd">- 5) #transforms</span>
<span class="sd">- 6) power in Watts, defaulted to 1W</span>
<span class="sd">- 7) intersected?: used for outgoing rays exiting out of a surface. If surface._cast(prevRay) shows that it does intersect, then add that to the outgoing rays</span>

<span class="sd">The #transforms is a little complicated:</span>
<span class="sd">- Original ray is 0, then each time a glass/mirror surface does something interesting,</span>
<span class="sd">  the outgoing ray is incremented by 1. If it doesn&#39;t touch the optic element, then</span>
<span class="sd">  it keeps the same number as before</span>

<span class="sd">:param prevRays: a reference to the previous Rays object, in order to limit the length of all previous rays!</span>
<span class="sd">:param ogSurface: the surface that generates this Rays&quot;&quot;&quot;</span>                        <span class="c1"># Rays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevRays</span> <span class="o">=</span> <span class="n">prevRays</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogSurface</span> <span class="o">=</span> <span class="n">ogSurface</span>   <span class="c1"># Rays</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">Rays</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevRays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevRays</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ogSurface</span><span class="p">)</span> <span class="c1"># Rays</span>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="nf">_genElse</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">);</span> <span class="k">return</span> <span class="n">Rays</span><span class="p">(</span><span class="n">array</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">([</span><span class="n">inf</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">(</span><span class="n">color_interpreter</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">([</span><span class="n">power</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span> <span class="c1"># Rays</span>
<div class="viewcode-block" id="Rays.parallel"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.parallel">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="nf">parallel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>        <span class="c1"># Rays</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates parallel rays starting from a particular point with a particular angle</span>

<span class="sd">:param theta: angle from positive x axis counterclockwise</span>
<span class="sd">:param N: how many rays to create total?</span>
<span class="sd">:param height: the height of the parallel rays if it were to have no angle&quot;&quot;&quot;</span>    <span class="c1"># Rays</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># Rays</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">-</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>   <span class="c1"># Rays</span>
        <span class="k">return</span> <span class="n">Rays</span><span class="o">.</span><span class="n">_genElse</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span><span class="p">)]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toNdArray</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">([</span><span class="n">theta</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">)</span> <span class="c1"># Rays</span></div>
<div class="viewcode-block" id="Rays.parallelToBounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.parallelToBounds">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="nf">parallelToBounds</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">angleOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># Rays</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates parallel rays starting from a particular point to the center of some bounds.</span>
<span class="sd">The bounds should have the format (xmin, ymin, xmax, ymax). :class:`Surface`s, :class:`OpticElement`s</span>
<span class="sd">all have the .bounds() method, so you can use them</span>

<span class="sd">See also: :meth:`parallel`</span>

<span class="sd">:param coverage: number from 0 to 1. 1 meaning the parallel lines should cover the entire (rotated)</span>
<span class="sd">    height of the bounds, 0.5 means it covers only half of the height, and so on. Think of this as %height&quot;&quot;&quot;</span> <span class="c1"># Rays</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;.bounds parameter is required&quot;</span><span class="p">)</span>      <span class="c1"># Rays</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">;</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">]);</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]);</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ys</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">xs</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Rays</span>
        <span class="n">amin</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">argmin</span><span class="p">();</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">amin</span><span class="p">];</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">amin</span><span class="p">];</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">argmax</span><span class="p">();</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">amax</span><span class="p">];</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">amax</span><span class="p">]</span> <span class="c1"># Rays</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">;</span> <span class="n">mx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">;</span> <span class="n">my</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">my</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">mx</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="c1"># Rays</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">+</span><span class="n">pi</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">))</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>   <span class="c1"># Rays</span>
        <span class="k">return</span> <span class="n">Rays</span><span class="o">.</span><span class="n">parallel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">angle</span><span class="o">+</span><span class="n">angleOffset</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">h</span><span class="o">*</span><span class="n">coverage</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span> <span class="c1"># Rays</span></div>
<div class="viewcode-block" id="Rays.pointToBounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.pointToBounds">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="nf">pointToBounds</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">coverage</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">angleOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c1"># Rays</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates rays starting from a particular point to the bounds.</span>

<span class="sd">See also: :meth:`parallelToBounds`</span>

<span class="sd">:param coverage: instead of %height like :meth:`parallelToBounds`, this is the anglular coverage,</span>
<span class="sd">    1 for covering the entire object.</span>
<span class="sd">:param angleOffset: offset to the angle from the starting point to the center of the bounds&quot;&quot;&quot;</span> <span class="c1"># Rays</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;.bounds parameter is required&quot;</span><span class="p">)</span>      <span class="c1"># Rays</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">;</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">]);</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y2</span><span class="p">]);</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ys</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">xs</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="c1">#%(2*pi) # Rays</span>
        <span class="n">amin</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">argmin</span><span class="p">();</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">amin</span><span class="p">];</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">amin</span><span class="p">];</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">argmax</span><span class="p">();</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">amax</span><span class="p">];</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">amax</span><span class="p">]</span> <span class="c1"># Rays</span>
        <span class="n">startAngle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">);</span> <span class="n">endAngle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y</span><span class="p">,</span> <span class="n">x2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># Rays</span>
        <span class="k">if</span> <span class="n">endAngle</span> <span class="o">&lt;</span> <span class="n">startAngle</span><span class="p">:</span> <span class="n">endAngle</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span>                               <span class="c1"># Rays</span>
        <span class="n">angleDiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">endAngle</span> <span class="o">-</span> <span class="n">startAngle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">coverage</span><span class="p">)</span>                         <span class="c1"># Rays</span>
        <span class="k">return</span> <span class="n">Rays</span><span class="o">.</span><span class="n">_genElse</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">startAngle</span><span class="o">+</span><span class="n">angleDiff</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">angleOffset</span><span class="p">,</span> <span class="n">endAngle</span><span class="o">-</span><span class="n">angleDiff</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">angleOffset</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">power</span><span class="p">)</span> <span class="c1"># Rays</span></div>
<div class="viewcode-block" id="Rays.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># returns bounds for plotting by p5                        # Rays</span>
        <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span> <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]);</span> <span class="n">l</span><span class="p">[</span><span class="n">l</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">rays</span><span class="o">.</span><span class="n">infLength</span> <span class="c1"># Rays</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">l</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">l</span> <span class="c1"># Rays</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="c1"># Rays</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">min</span><span class="p">());</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="c1"># Rays</span>
        <span class="k">return</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span>                                            <span class="c1"># Rays</span></div>
<div class="viewcode-block" id="Rays.hitbox"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.hitbox">[docs]</a>    <span class="k">def</span> <span class="nf">hitbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spread</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxWH</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="n">intersectOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PIL.Image.Image&quot;</span><span class="p">:</span> <span class="c1"># Rays</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualizes the Ray&#39;s starting point, with colors and whatnot.</span>
<span class="sd">Example::</span>

<span class="sd">    r = Rays.parallel(theta=pi/8)</span>
<span class="sd">    r.hitbox()</span>

<span class="sd">:param spread: will color this much nearby pixels</span>
<span class="sd">:param maxWH: size of the returned image. Either width or height will be around this big, whichever is bigger</span>
<span class="sd">:param mode: several plotting modes, each with its own performance and accuracy characteristics</span>
<span class="sd">:param intersectOnly: if True (default), will only plot the hitbox of the rays that actually hits</span>
<span class="sd">    the Surface that generates the ray and not some previous surface</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># Rays</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>                                                     <span class="c1"># Rays</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No ray intersected the Surface that generates this Rays&quot;</span><span class="p">)</span> <span class="c1"># Rays</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">][:,[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]];</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Rays</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]);</span> <span class="n">xmid</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="o">+</span><span class="n">xmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span> <span class="c1"># Rays</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">ymid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span><span class="o">+</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span> <span class="c1"># Rays</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">;</span> <span class="n">dist</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="o">=</span> <span class="n">inf</span><span class="p">;</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># Rays</span>
            <span class="k">if</span> <span class="n">maxWH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">maxWH</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="n">dm</span><span class="p">,</span> <span class="n">dy</span><span class="o">/</span><span class="n">dm</span><span class="p">),</span> <span class="mi">500</span><span class="p">);</span> <span class="n">maxWH</span> <span class="c1"># number of pixels of the longest length. This is calculated automatically if user does not give a particular size # Rays</span>
            <span class="n">pixelSize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span><span class="o">/</span><span class="n">maxWH</span> <span class="c1"># how much real distance is between 2 adjacent pixels? Ideally exactly the same as dm # Rays</span>
            <span class="n">pixelH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dy</span><span class="o">/</span><span class="n">pixelSize</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span> <span class="n">pixelW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="n">pixelSize</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="c1"># Rays</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">pixelH</span><span class="p">,</span> <span class="n">pixelW</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">200</span><span class="p">;</span> <span class="n">rgb</span> <span class="o">=</span> <span class="n">Wavelengths</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toRgb</span><span class="p">()</span> <span class="c1"># Rays</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ymid</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="o">+</span><span class="n">pixelH</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span> <span class="n">xs</span> <span class="o">=</span> <span class="p">((</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xmid</span><span class="p">)</span><span class="o">/</span><span class="n">pixelSize</span><span class="o">+</span><span class="n">pixelW</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># Rays</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">spread</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">spread</span><span class="p">:</span>                               <span class="c1"># Rays</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">spread</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">spread</span><span class="p">:</span> <span class="n">im</span><span class="p">[</span><span class="n">ys</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">xs</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgb</span>      <span class="c1"># Rays</span>
            <span class="k">return</span> <span class="n">im</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toImg</span><span class="p">()</span>                                              <span class="c1"># Rays</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Currently doesn&#39;t support mode &#39;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>        <span class="c1"># Rays</span></div>
<div class="viewcode-block" id="Rays.focus"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Rays.focus">[docs]</a>    <span class="k">def</span> <span class="nf">focus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RaysFocus&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RaysFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                       <span class="c1"># Rays</span></div>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">):</span>                                                     <span class="c1"># Rays</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="n">Rays</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can only add Rays to another Rays! The other value has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Rays</span>
        <span class="k">return</span> <span class="n">Rays</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">]))</span>                      <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Rays N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> avgTheta=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">deg intersectedSurface?=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="si">}</span><span class="s2"> ogSurface=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ogSurface</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># Rays</span>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{},</span> <span class="n">ignored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                    <span class="c1"># Rays</span>
        <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]);</span> <span class="n">l</span><span class="p">[</span><span class="n">l</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">rays</span><span class="o">.</span><span class="n">infLength</span><span class="p">;</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;bounds&quot;</span><span class="p">]</span> <span class="c1"># Rays</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">l</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">l</span><span class="p">;</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span> <span class="c1"># Rays</span>
        <span class="k">with</span> <span class="n">p5</span><span class="o">.</span><span class="n">context</span><span class="p">():</span>                                                       <span class="c1"># Rays</span>
            <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">ignored</span> <span class="k">if</span> <span class="n">ignored</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">filt</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span> <span class="c1"># Rays</span>
                <span class="n">p5</span><span class="o">.</span><span class="n">stroke</span><span class="p">(</span><span class="o">*</span><span class="n">wavelength_to_rgb</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>   <span class="c1"># Rays</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">rays</span><span class="o">.</span><span class="n">showOrigin</span><span class="p">:</span> <span class="n">p5</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">noStroke</span><span class="p">();</span> <span class="n">p5</span><span class="o">.</span><span class="n">ellipse</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># Rays</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>                              <span class="c1"># Rays</span></div>
<span class="n">gps</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BK7&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.03961212</span><span class="p">,</span> <span class="mf">0.231792344</span><span class="p">,</span> <span class="mf">1.01046945</span><span class="p">,</span> <span class="mf">0.00600069867</span><span class="p">,</span> <span class="mf">0.0200179144</span><span class="p">,</span> <span class="mf">103.560653</span><span class="p">),</span> <span class="c1"># borosilicate crown glass # Rays</span>
               <span class="s2">&quot;sapphire&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.4313493</span><span class="p">,</span> <span class="mf">0.65054713</span><span class="p">,</span> <span class="mf">5.3414021</span><span class="p">,</span> <span class="mf">0.0052799261</span><span class="p">,</span> <span class="mf">0.0142382647</span><span class="p">,</span> <span class="mf">325.017834</span><span class="p">),</span> <span class="c1"># Rays</span>
               <span class="s2">&quot;fusedSilica&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.6961663</span><span class="p">,</span> <span class="mf">0.4079426</span><span class="p">,</span> <span class="mf">0.8974794</span><span class="p">,</span> <span class="mf">0.00467914826</span><span class="p">,</span> <span class="mf">0.0135120631</span><span class="p">,</span> <span class="mf">97.9340025</span><span class="p">),</span> <span class="c1"># Rays</span>
               <span class="s2">&quot;MgF&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.48755108</span><span class="p">,</span> <span class="mf">0.39875031</span><span class="p">,</span> <span class="mf">2.3120353</span><span class="p">,</span> <span class="mf">0.001882178</span><span class="p">,</span> <span class="mf">0.008951888</span><span class="p">,</span> <span class="mf">566.13559</span><span class="p">),</span> <span class="c1"># Rays</span>
               <span class="s2">&quot;air&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)}</span>                                             <span class="c1"># Rays</span>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;gps&quot;</span><span class="p">,</span> <span class="n">gps</span><span class="p">,</span> <span class="s2">&quot;All builtin glass parameters of the system. All have 6 floats, for B1,B2,B3,C1,C2,C3 parameters used in the sellmeier equation: https://en.wikipedia.org/wiki/Sellmeier_equation&quot;</span><span class="p">)</span> <span class="c1"># Rays</span>
<span class="n">_invGlassParams</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>                                                      <span class="c1"># Rays</span>
<span class="k">def</span> <span class="nf">invGlassParams</span><span class="p">():</span>                                                            <span class="c1"># invGlassParams</span>
    <span class="k">global</span> <span class="n">gps</span><span class="p">,</span> <span class="n">_invGlassParams</span>                                                  <span class="c1"># invGlassParams</span>
    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">_invGlassParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="n">gps</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">settings</span><span class="o">.</span><span class="n">gps</span><span class="p">,</span> <span class="o">**</span><span class="n">gps</span><span class="p">};</span> <span class="n">settings</span><span class="o">.</span><span class="n">gps</span> <span class="o">=</span> <span class="n">gps</span><span class="p">;</span> <span class="n">_invGlassParams</span> <span class="o">=</span> <span class="p">[{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gps</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()]</span> <span class="c1"># invGlassParams</span>
    <span class="k">return</span> <span class="n">_invGlassParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                                    <span class="c1"># invGlassParams</span>
<div class="viewcode-block" id="sellmeier"><a class="viewcode-back" href="../../kop.html#k1lib.kop.sellmeier">[docs]</a><span class="k">def</span> <span class="nf">sellmeier</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">:</span><span class="s2">&quot;np.ndarray&quot;</span><span class="p">,</span> <span class="n">glassParam</span><span class="p">):</span>                             <span class="c1"># sellmeier</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs the sellmeier equation to get the index of refraction for multiple wavelengths</span>
<span class="sd">for a particular glass material&quot;&quot;&quot;</span>                                               <span class="c1"># sellmeier</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glassParam</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">glassParam</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">))</span> <span class="c1"># sellmeier</span>
    <span class="k">else</span><span class="p">:</span>                                                                        <span class="c1"># sellmeier</span>
        <span class="n">la2</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavelengths</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">;</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span> <span class="o">=</span> <span class="n">glassParam</span>         <span class="c1"># sellmeier</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b1</span><span class="o">*</span><span class="n">la2</span><span class="o">/</span><span class="p">(</span><span class="n">la2</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span><span class="o">*</span><span class="n">la2</span><span class="o">/</span><span class="p">(</span><span class="n">la2</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span> <span class="o">+</span> <span class="n">b3</span><span class="o">*</span><span class="n">la2</span><span class="o">/</span><span class="p">(</span><span class="n">la2</span><span class="o">-</span><span class="n">c3</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>    <span class="c1"># sellmeier</span></div>
<span class="n">sellmeier</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">gps</span><span class="p">[</span><span class="s2">&quot;BK7&quot;</span><span class="p">])</span>                                 <span class="c1"># sellmeier</span>
<span class="n">_surface_autoInc</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;_surface_&quot;</span><span class="p">)</span>                       <span class="c1"># sellmeier</span>
<span class="k">def</span> <span class="nf">snell</span><span class="p">(</span><span class="n">rtheta</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span> <span class="c1"># this takes into account whether we&#39;ve encountered total internal reflection or not # snell</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="o">-</span><span class="n">ln</span><span class="p">)</span><span class="o">/</span><span class="n">n2</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">ln</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">inRange</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># snell</span>
    <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="o">-</span><span class="n">ln</span><span class="p">);</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">+</span><span class="n">f</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ln</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">+</span><span class="n">f</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ln</span><span class="p">))</span> <span class="c1"># snell</span>
    <span class="k">return</span> <span class="n">inRange</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">inRange</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span>                                         <span class="c1"># snell</span>
<span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;surface&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;showIndex&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;whether to show the index of the Surface in an OpticSystem or not&quot;</span><span class="p">),</span> <span class="s2">&quot;display settings for kop.Surface class&quot;</span><span class="p">)</span> <span class="c1"># snell</span>
<span class="n">settings</span><span class="o">.</span><span class="n">consts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;inchForward&quot;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s2">&quot;after new Rays have been built, inch forward the origin of the new Rays by a this tiny amount so that it &#39;clears&#39; the last Surface&quot;</span><span class="p">)</span> <span class="c1"># snell</span>
<div class="viewcode-block" id="Surface"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Surface">[docs]</a><span class="k">class</span> <span class="nc">Surface</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                         <span class="c1"># Surface</span>
<div class="viewcode-block" id="Surface.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Surface.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gp1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gp2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;glass&quot;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">angleStd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">opticElement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># Surface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents a geometry, like line, arc, or parabola. Rays can interact with a</span>
<span class="sd">surface, resulting in new Rays. An optic element can have multiple of these surfaces and</span>
<span class="sd">react differently to incoming rays.</span>

<span class="sd">The convension is that gp1 is the environment&#39;s glassParam, while gp2 is the Surface&#39;s</span>
<span class="sd">glassParam. A surface needs both in order to calculate the deflection angles.</span>

<span class="sd">These modes are available:</span>

<span class="sd">- glass: transparent (or semi-transparent) surface, bends incoming rays</span>
<span class="sd">- mirror: perfectly reflective (or allow some percentage of light to pass through)</span>
<span class="sd">- sensor: absorbes all incoming rays, can retrieve the image that&#39;s absorbed</span>
<span class="sd">- opaque: reflects incoming rays in a random direction outward</span>

<span class="sd">:param gp1: glass params 1, usually this is of the environment (air)</span>
<span class="sd">:param gp2: glass param 2, usually this is of the object (borosilicate glass, sapphire, water)</span>
<span class="sd">:param mode: explained above</span>
<span class="sd">:param capture: if True, captures all rays that comes in through .cast() function. Captures</span>
<span class="sd">    will stay the same across copy.copy() instances to save perf! The captures will be</span>
<span class="sd">    available at ``.captures``</span>
<span class="sd">:param angleStd: if specified, when casting outgoing rays, will add this much standard deviation</span>
<span class="sd">    in the rays&#39; angle, useful to quickly simulate a bumpy piece of glass</span>
<span class="sd">:param opticElement: the OpticElement that this Surface is a part of&quot;&quot;&quot;</span>          <span class="c1"># Surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">_surface_autoInc</span><span class="p">()</span>                                            <span class="c1"># Surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gp1</span> <span class="ow">or</span> <span class="n">gp1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gp1&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">gp1</span>            <span class="c1"># Surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gp2</span> <span class="ow">or</span> <span class="n">gp2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gp2&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">gp2</span>            <span class="c1"># Surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">or</span> <span class="n">mode</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mode</span>       <span class="c1"># Surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capture</span> <span class="o">=</span> <span class="n">capture</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">captures</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">angleStd</span> <span class="o">=</span> <span class="n">angleStd</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElement</span> <span class="o">=</span> <span class="n">opticElement</span> <span class="c1"># Surface</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">));</span> <span class="n">res</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">gp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">gp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">capture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">captures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captures</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">angleStd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angleStd</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="n">opticElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElement</span><span class="p">;</span> <span class="k">return</span> <span class="n">res</span> <span class="c1"># Surface</span>
    <span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">:</span><span class="s2">&quot;Rays&quot;</span><span class="p">):</span>                                                <span class="c1"># Surface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expected to be implemented by all subclasses.</span>
<span class="sd">Given N rays, should return these arrays:</span>
<span class="sd">- (N,) bool array: whether the rays intersect the surface or not</span>
<span class="sd">- (N,) float array: length of the previous ray if intersect. Else can be any number, but please no whacky values like inf or nan</span>
<span class="sd">- (N,) float array: angle of vector normal to the surface. Say it points up. Then top area is considered gp1, bottom area is gp2. If don&#39;t intersect then can be any number</span>

<span class="sd">This should be enough to totally and completely describe the surface properties, and the refraction</span>
<span class="sd">code only needs to be written once&quot;&quot;&quot;</span>                                            <span class="c1"># Surface</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>                                                    <span class="c1"># Surface</span>
    <span class="k">def</span> <span class="nf">_cast2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">):</span>                                                      <span class="c1"># Surface</span>
        <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>                                 <span class="c1"># Surface</span>
        <span class="n">beta</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">ln</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">beta</span><span class="p">[</span><span class="n">beta</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ln</span><span class="p">[</span><span class="n">ln</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Surface</span>
        <span class="k">return</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">ln</span>                                             <span class="c1"># Surface</span>
<div class="viewcode-block" id="Surface.castS"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Surface.castS">[docs]</a>    <span class="k">def</span> <span class="nf">castS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Rays&quot;</span><span class="p">:</span>                                             <span class="c1"># Surface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This will truncate the lengths of the incoming Rays object, and return</span>
<span class="sd">a new rays, as well as the lengths of the old rays, for easy comparison. If the</span>
<span class="sd">rays don&#39;t interact with the lens at all, then just copy the old rays over, and the</span>
<span class="sd">length is the same.&quot;&quot;&quot;</span>                                                           <span class="c1"># Surface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">captures</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rays</span><span class="p">)])</span>                 <span class="c1"># Surface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;glass&quot;</span><span class="p">:</span>                                                 <span class="c1"># Surface</span>
            <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span>                                         <span class="c1"># Surface</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gp1 not specified in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span> <span class="c1"># Surface</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gp2 not specified in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span> <span class="c1"># Surface</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">rays</span><span class="p">;</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast2</span><span class="p">(</span><span class="n">rays</span><span class="p">);</span> <span class="n">rtheta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">];</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Surface</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="n">sellmeier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span><span class="p">);</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">sellmeier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span><span class="p">)</span> <span class="c1"># index of refractions # Surface</span>
                <span class="n">lns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ln</span><span class="p">,</span> <span class="n">pi</span><span class="o">+</span><span class="n">ln</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">;</span> <span class="n">ln_version</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">rtheta</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">lns</span><span class="o">+</span><span class="n">pi</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">-</span><span class="n">pi</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmin</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># Surface</span>
                <span class="n">d1to2</span> <span class="o">=</span> <span class="n">ln_version</span> <span class="c1"># whether the ray is going from gp1 (glass param 1, top of line) to gp2. Completely coincidentally, this is exactly equal to ln_version (line normal version, either as-is, or flipped 180) # Surface</span>
                <span class="n">chosenLn</span> <span class="o">=</span> <span class="n">lns</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">ln_version</span><span class="p">]</span> <span class="c1"># actual normal that it&#39;s going to use # Surface</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">snell</span><span class="p">(</span><span class="n">rtheta</span><span class="p">,</span> <span class="n">chosenLn</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">);</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">snell</span><span class="p">(</span><span class="n">rtheta</span><span class="p">,</span> <span class="n">chosenLn</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span> <span class="c1"># Surface</span>
                <span class="n">rthetap</span> <span class="o">=</span> <span class="n">d1to2</span><span class="o">*</span><span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">d1to2</span><span class="p">)</span><span class="o">*</span><span class="n">t2</span><span class="p">;</span> <span class="n">intersections</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">+</span><span class="mf">1e-8</span><span class="p">)]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toNdArray</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="c1"># Surface</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mirror&quot;</span><span class="p">:</span>                                              <span class="c1"># Surface</span>
            <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span>                                         <span class="c1"># Surface</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">rays</span><span class="p">;</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cast2</span><span class="p">(</span><span class="n">rays</span><span class="p">);</span> <span class="n">rtheta</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">];</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">);</span> <span class="n">lns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ln</span><span class="p">,</span> <span class="n">pi</span><span class="o">+</span><span class="n">ln</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># Surface</span>
                <span class="n">angleDiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtheta</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">-</span><span class="n">lns</span><span class="o">+</span><span class="n">pi</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">-</span><span class="n">pi</span><span class="p">;</span> <span class="n">ln_version</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angleDiff</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmin</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># Surface</span>
                <span class="n">f</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angleDiff</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">ln_version</span><span class="p">])</span> <span class="c1"># factor to multiply the normal vector by # Surface</span>
                <span class="n">chosenLn</span> <span class="o">=</span> <span class="n">lns</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">1</span><span class="o">-</span><span class="n">ln_version</span><span class="p">]</span> <span class="c1"># actual normal that it&#39;s going to use # Surface</span>
                <span class="n">rthetap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">+</span><span class="n">f</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">chosenLn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">+</span><span class="n">f</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">chosenLn</span><span class="p">))</span> <span class="c1"># Surface</span>
                <span class="n">intersections</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mf">1e-8</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mf">1e-8</span><span class="p">)]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toNdArray</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="c1"># Surface</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Doesn&#39;t support mode &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&#39; yet&quot;</span><span class="p">)</span>         <span class="c1"># Surface</span>
        <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span> <span class="c1"># make sure intersected, intersections, rthetap variables are defined upon reaching this part # Surface</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angleStd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-11</span><span class="p">:</span> <span class="n">rthetap</span> <span class="o">=</span> <span class="n">rthetap</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">rthetap</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">angleStd</span> <span class="c1"># adding variations # Surface</span>
            <span class="n">intersections</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rthetap</span><span class="p">)</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">consts</span><span class="o">.</span><span class="n">inchForward</span><span class="p">;</span> <span class="n">intersections</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rthetap</span><span class="p">)</span><span class="o">*</span><span class="n">settings</span><span class="o">.</span><span class="n">consts</span><span class="o">.</span><span class="n">inchForward</span> <span class="c1"># inch forward a little to clear the last surface # Surface</span>
            <span class="n">outr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">intersections</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insertColumn</span><span class="p">(</span><span class="n">rthetap</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:]],</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># has not corrected for whether it has intersected the line # Surface</span>
            <span class="n">outr</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">]);</span> <span class="n">outr</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">);</span> <span class="n">outr</span><span class="p">[</span><span class="n">intersected</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">intersected</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">outr</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span> <span class="n">outr</span><span class="p">[:,</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">intersected</span><span class="p">;</span> <span class="n">outr</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="n">outr</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> <span class="c1"># Surface</span>
            <span class="c1"># tries to limit the length of previous rays                         # Surface</span>
            <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">intersected</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">intersected</span><span class="p">))</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">newR</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">prevRays</span> <span class="c1"># Surface</span>
            <span class="k">while</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># for the rays that does not have its depth incremented, set the prevLength to this lengths # Surface</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">newR</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">;</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newR</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span><span class="mi">3</span><span class="p">];</span> <span class="n">newR</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">prevRays</span> <span class="c1"># Surface</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">captures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">outr</span><span class="p">))</span>           <span class="c1"># Surface</span>
        <span class="k">return</span> <span class="n">outr</span>                                                              <span class="c1"># Surface</span></div>
<div class="viewcode-block" id="Surface.cast"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Surface.cast">[docs]</a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RaysPath&quot;</span><span class="p">:</span> <span class="c1"># convenience function, not core mechanism # Surface</span>
        <span class="k">return</span> <span class="n">OpticSystem</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                      <span class="c1"># Surface</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>                                                     <span class="c1"># Surface</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">showIndex</span> <span class="ow">and</span> <span class="s2">&quot;surfaceIdx2Id&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>     <span class="c1"># Surface</span>
            <span class="k">with</span> <span class="n">p5</span><span class="o">.</span><span class="n">context</span><span class="p">():</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">();</span> <span class="n">p5</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">noStroke</span><span class="p">();</span> <span class="n">p5</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;surfaceIdx2Id&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">xmin</span><span class="o">+</span><span class="n">xmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ymin</span><span class="o">+</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Surface</span>
    <span class="k">def</span> <span class="nf">_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># helper sections at the end of every surface               # Surface</span>
        <span class="n">gp1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; gp1=None&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; gp1=&#39;</span><span class="si">{</span><span class="n">invGlassParams</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">gp1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp1</span> <span class="ow">in</span> <span class="n">invGlassParams</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Surface</span>
        <span class="n">gp2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; gp2=None&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; gp2=&#39;</span><span class="si">{</span><span class="n">invGlassParams</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">gp2</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp2</span> <span class="ow">in</span> <span class="n">invGlassParams</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Surface</span>
        <span class="n">oe</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElement</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; opticElement=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">opticElement</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Surface</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gp1</span><span class="si">}{</span><span class="n">gp2</span><span class="si">}{</span><span class="s1">&#39; capture=True&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">oe</span><span class="si">}</span><span class="s2">&quot;</span>        <span class="c1"># Surface</span></div>
<span class="k">def</span> <span class="nf">ray_intersection</span><span class="p">(</span><span class="n">line</span><span class="p">:</span><span class="s2">&quot;list[float]&quot;</span><span class="p">,</span> <span class="n">rays</span><span class="p">:</span><span class="n">Rays</span><span class="p">):</span>                             <span class="c1"># ray_intersection</span>
    <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span>                                                 <span class="c1"># ray_intersection</span>
        <span class="n">lx1</span><span class="p">,</span> <span class="n">ly1</span><span class="p">,</span> <span class="n">lx2</span><span class="p">,</span> <span class="n">ly2</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span> <span class="n">dlx</span> <span class="o">=</span> <span class="n">lx2</span> <span class="o">-</span> <span class="n">lx1</span><span class="p">;</span> <span class="n">dly</span> <span class="o">=</span> <span class="n">ly2</span> <span class="o">-</span> <span class="n">ly1</span>              <span class="c1"># ray_intersection</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dlx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-11</span><span class="p">:</span> <span class="n">dlx</span> <span class="o">+=</span> <span class="mf">1e-10</span> <span class="c1"># surprisingly, it still works for such tiny numbers! # ray_intersection</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">dly</span><span class="o">/</span><span class="n">dlx</span><span class="p">;</span> <span class="n">rx</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">ry</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">];</span> <span class="n">rtheta</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># ray_intersection</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">ry</span><span class="o">-</span><span class="n">ly1</span><span class="o">+</span><span class="n">R</span><span class="o">*</span><span class="p">(</span><span class="n">lx1</span><span class="o">-</span><span class="n">rx</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">*</span><span class="n">R</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">))</span> <span class="c1"># vector length of ray # ray_intersection</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span><span class="o">+</span><span class="n">beta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span><span class="o">-</span><span class="n">lx1</span><span class="p">)</span><span class="o">/</span><span class="n">dlx</span><span class="p">;</span> <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="c1"># vector length in line surface # ray_intersection</span>
<div class="viewcode-block" id="LineSurface"><a class="viewcode-back" href="../../kop.html#k1lib.kop.LineSurface">[docs]</a><span class="k">class</span> <span class="nc">LineSurface</span><span class="p">(</span><span class="n">Surface</span><span class="p">):</span>                                                      <span class="c1"># LineSurface</span>
<div class="viewcode-block" id="LineSurface.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.LineSurface.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                                <span class="c1"># LineSurface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Surface defined using a straight line.</span>

<span class="sd">If x1,y1 is on the left, x2,y2 on the right, then gp1 (glass param) is on top, gp2 is</span>
<span class="sd">at the bottom.&quot;&quot;&quot;</span>                                                                <span class="c1"># LineSurface</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_superAlreadyInit&quot;</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    <span class="c1"># LineSurface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span>                   <span class="c1"># LineSurface</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__copy__</span><span class="p">();</span> <span class="n">res</span><span class="o">.</span><span class="n">_superAlreadyInit</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">);</span> <span class="k">return</span> <span class="n">res</span> <span class="c1"># LineSurface</span>
    <span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">):</span>                                                       <span class="c1"># LineSurface</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">ray_intersection</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">y2</span><span class="p">],</span> <span class="n">rays</span><span class="p">)</span> <span class="c1"># LineSurface</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">y2</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">x2</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># line normal angle # LineSurface</span>
        <span class="n">intersected</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="k">return</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">*</span><span class="n">ln</span> <span class="c1"># LineSurface</span>
<div class="viewcode-block" id="LineSurface.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.LineSurface.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">)</span> <span class="c1"># LineSurface</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">);</span> <span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">);</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># LineSurface</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Line(Surface) (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_repr</span><span class="p">()</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># LineSurface</span></div>
<div class="viewcode-block" id="ArcSurface"><a class="viewcode-back" href="../../kop.html#k1lib.kop.ArcSurface">[docs]</a><span class="k">class</span> <span class="nc">ArcSurface</span><span class="p">(</span><span class="n">Surface</span><span class="p">):</span>                                                       <span class="c1"># ArcSurface</span>
<div class="viewcode-block" id="ArcSurface.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.ArcSurface.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">startAngle</span><span class="p">,</span> <span class="n">endAngle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                 <span class="c1"># ArcSurface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Surface defined using a circular arc&quot;&quot;&quot;</span>                               <span class="c1"># ArcSurface</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_superAlreadyInit&quot;</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    <span class="c1"># ArcSurface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>                                       <span class="c1"># ArcSurface</span>
        <span class="n">startAngle</span> <span class="o">=</span> <span class="n">startAngle</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">);</span> <span class="n">endAngle</span> <span class="o">=</span> <span class="n">endAngle</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span> <span class="c1"># ensuring startAngle is always positive, and endAngle is always greater than startAngle. This defines the angle sweeped counterclockwise from startAngle to endAngle # ArcSurface</span>
        <span class="k">while</span> <span class="n">endAngle</span> <span class="o">&lt;</span> <span class="n">startAngle</span><span class="p">:</span> <span class="n">endAngle</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span>                            <span class="c1"># ArcSurface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span> <span class="o">=</span> <span class="n">startAngle</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span> <span class="o">=</span> <span class="n">endAngle</span>                   <span class="c1"># ArcSurface</span></div>
<div class="viewcode-block" id="ArcSurface.from2Points"><a class="viewcode-back" href="../../kop.html#k1lib.kop.ArcSurface.from2Points">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># ArcSurface</span>
    <span class="k">def</span> <span class="nf">from2Points</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ArcSurface&quot;</span><span class="p">:</span>                <span class="c1"># ArcSurface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an :class:`ArcSurface` from 2 points and a radius.</span>
<span class="sd">Example::</span>

<span class="sd">    kop.ArcSurface.from2Points(1, 2, 3, 4, 10)</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># ArcSurface</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">;</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span>                              <span class="c1"># ArcSurface</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">;</span> <span class="n">my</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">;</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">);</span> <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">-</span><span class="n">dist</span><span class="o">*</span><span class="n">dist</span><span class="o">/</span><span class="mi">4</span> <span class="c1"># ArcSurface</span>
        <span class="k">if</span> <span class="n">h2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arc radius </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> too small. No arc will pass through both of the specified points&quot;</span><span class="p">)</span> <span class="c1"># ArcSurface</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2</span><span class="p">);</span> <span class="n">cx</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">my</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="k">return</span> <span class="n">ArcSurface</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">cy</span><span class="p">,</span> <span class="n">x2</span><span class="o">-</span><span class="n">cx</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">cy</span><span class="p">,</span> <span class="n">x1</span><span class="o">-</span><span class="n">cx</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># ArcSurface</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__copy__</span><span class="p">();</span> <span class="n">res</span><span class="o">.</span><span class="n">_superAlreadyInit</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="p">);</span> <span class="k">return</span> <span class="n">res</span> <span class="c1"># ArcSurface</span>
    <span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">):</span>                                                       <span class="c1"># ArcSurface</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rtheta</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">);</span> <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">;</span> <span class="n">ay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">;</span> <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="c1"># ArcSurface</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">rx</span><span class="o">-</span><span class="n">ax</span><span class="p">;</span> <span class="n">B</span> <span class="o">=</span> <span class="n">ry</span><span class="o">-</span><span class="n">ay</span><span class="p">;</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">s</span><span class="p">);</span> <span class="n">c</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">B</span><span class="o">-</span><span class="n">ar</span><span class="o">*</span><span class="n">ar</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">;</span> <span class="n">intersected</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1"># quadratic formula # ArcSurface</span>
        <span class="k">with</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ignoreWarnings</span><span class="p">():</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">);</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="c1"># ArcSurface</span>
        <span class="n">v1</span><span class="p">[</span><span class="n">v1</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">inf</span><span class="p">;</span> <span class="n">v1</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">]</span><span class="o">=</span><span class="n">inf</span><span class="p">;</span> <span class="n">v2</span><span class="p">[</span><span class="n">v2</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">inf</span><span class="p">;</span> <span class="n">v2</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">]</span><span class="o">=</span><span class="n">inf</span>   <span class="c1"># ArcSurface</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span><span class="n">v2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">;</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">rx</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">+</span><span class="n">vs</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]);</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">ry</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">+</span><span class="n">vs</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span> <span class="c1"># ArcSurface</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">ty</span><span class="o">-</span><span class="n">ay</span><span class="p">,</span> <span class="n">tx</span><span class="o">-</span><span class="n">ax</span><span class="p">);</span> <span class="n">angles</span><span class="p">[</span><span class="n">angles</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">;</span> <span class="n">angles</span><span class="p">[</span><span class="n">angles</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">;</span> <span class="n">oldAngles</span> <span class="o">=</span> <span class="n">angles</span> <span class="c1"># ArcSurface</span>
        <span class="n">selected_version</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span> <span class="o">&lt;</span> <span class="n">angles</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angles</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">inf</span> <span class="o">&lt;</span> <span class="n">vs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">vs</span> <span class="o">&lt;</span> <span class="n">inf</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmax</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># ArcSurface</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">selected_version</span><span class="p">];</span> <span class="n">intersected</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span> <span class="o">&lt;</span> <span class="n">angles</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">angles</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="p">))]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># ArcSurface</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">vs</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">selected_version</span><span class="p">];</span> <span class="n">intersected</span><span class="p">[</span><span class="n">beta</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">beta</span><span class="p">[</span><span class="n">beta</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">return</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">angles</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># ArcSurface</span>
<div class="viewcode-block" id="ArcSurface.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.ArcSurface.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># step through n=50 points from startAngle to endAngle, then calc the bounds # ArcSurface</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="p">);</span> <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">);</span> <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># ArcSurface</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>                                                     <span class="c1"># ArcSurface</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>                                                   <span class="c1"># ArcSurface</span>
        <span class="k">with</span> <span class="n">p5</span><span class="o">.</span><span class="n">context</span><span class="p">():</span> <span class="n">p5</span><span class="o">.</span><span class="n">noFill</span><span class="p">();</span> <span class="n">p5</span><span class="o">.</span><span class="n">arc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="p">);</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># ArcSurface</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Arc(Surface) x=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> y=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> r=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> startAngle(deg)=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startAngle</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> endAngle(deg)=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endAngle</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_repr</span><span class="p">()</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># ArcSurface</span></div>
<span class="k">def</span> <span class="nf">buildF</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span> <span class="c1"># compiles function of the passed in coefficients             # buildF</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>                                                                      <span class="c1"># buildF</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span>                                                <span class="c1"># buildF</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; + </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">*x**</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>                                         <span class="c1"># buildF</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*x**0 &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;**1 &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;**2 &quot;</span><span class="p">,</span> <span class="s2">&quot;*x &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; +&quot;</span><span class="p">)</span> <span class="c1"># buildF</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lambda x: </span><span class="si">{</span><span class="n">s</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                                  <span class="c1"># buildF</span>
<span class="k">def</span> <span class="nf">buildDF</span><span class="p">(</span><span class="n">coeff</span><span class="p">):</span> <span class="c1"># compiles the derivative function of the passed in coefficients # buildDF</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>                                                                      <span class="c1"># buildDF</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>                                            <span class="c1"># buildDF</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; + </span><span class="si">{</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">*x**</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>                                   <span class="c1"># buildDF</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="p">;</span> <span class="n">s</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*x**0 &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;**1 &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;**2 &quot;</span><span class="p">,</span> <span class="s2">&quot;*x &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; +&quot;</span><span class="p">)</span> <span class="c1"># buildDF</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lambda x: </span><span class="si">{</span><span class="n">s</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                                  <span class="c1"># buildDF</span>
<div class="viewcode-block" id="polySolver"><a class="viewcode-back" href="../../kop.html#k1lib.kop.polySolver">[docs]</a><span class="k">def</span> <span class="nf">polySolver</span><span class="p">(</span><span class="n">polys</span><span class="p">):</span>                                                           <span class="c1"># polySolver</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expected to take in a (N,F) array of N different polynomials with order F-1 and return 2 arrays:</span>

<span class="sd">- intersected (N,) bool array: whether there&#39;re any roots</span>
<span class="sd">- beta (N,) float array: the root of each polynomial that&#39;s &gt;0 and is the minimum out of all roots</span>

<span class="sd">Right now, only supports vectorized solvers with order 2 polynomials. Any higher and it</span>
<span class="sd">falls back to using un-vectorized np.roots(), or other methods like it. This is separated out</span>
<span class="sd">so that it can be swapped out for a better implementation</span>

<span class="sd">Potential candidates for &gt;2 order polynomials:</span>
<span class="sd">- scipy: fsolve, root, newton, brentq</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># polySolver</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">polys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="n">polys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                 <span class="c1"># polySolver</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>                                                               <span class="c1"># polySolver</span>
        <span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">polys</span><span class="o">.</span><span class="n">T</span>                                                          <span class="c1"># polySolver</span>
        <span class="n">intersected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">);</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">;</span> <span class="n">intersected</span><span class="p">[</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># polySolver</span>
        <span class="n">delta</span><span class="p">[</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span> <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">);</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">);</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">;</span> <span class="n">xs</span><span class="p">[</span><span class="n">xs</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf</span> <span class="c1"># polySolver</span>
        <span class="n">beta_version</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmin</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">();</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">beta_version</span><span class="p">];</span> <span class="n">intersected</span><span class="p">[</span><span class="n">beta</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="c1"># polySolver</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">clearNan</span><span class="p">();</span> <span class="n">beta</span><span class="p">[</span><span class="n">beta</span><span class="o">==</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">clearNan</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">1e-8</span><span class="p">)</span><span class="o">*</span><span class="n">beta</span><span class="p">;</span> <span class="n">intersected</span><span class="p">[</span><span class="n">beta</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># polySolver</span>
        <span class="k">return</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span>                                                 <span class="c1"># polySolver</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Currently only support polynomials of order 2, aka a parabola. Why aren&#39;t higher dimensions supported? Cause I&#39;m lazy. You can copy this function (polySolver), create your own robust version that supports higher dimensions and insert it into PolySurface.solver&quot;</span><span class="p">)</span> <span class="c1"># polySolver</span></div>
<div class="viewcode-block" id="PolySurface"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface">[docs]</a><span class="k">class</span> <span class="nc">PolySurface</span><span class="p">(</span><span class="n">Surface</span><span class="p">):</span>                                                      <span class="c1"># PolySurface</span>
<div class="viewcode-block" id="PolySurface.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">coeff</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">solver</span><span class="o">=</span><span class="n">polySolver</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># PolySurface</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Surface defined using a polynomial.</span>

<span class="sd">Let&#39;s say there&#39;s a parabola that you&#39;d like to input into the simulation, say ``x^2/10``. There</span>
<span class="sd">are several dials and knobs that you can change to position your Surface right where you want it.</span>

<span class="sd">There are 2 frame of reference I&#39;ll be using. First is world frame, where all your elements sits in,</span>
<span class="sd">and second is poly frame, where your polynomial coefficients will define (x, y) in.</span>

<span class="sd">In the poly frame, the surface is defined as all x points in (xmin, xmax), together with all y points</span>
<span class="sd">calculated straight from your coefficients. So if ``coeff = [1, 2, 3]``, then the equation will be</span>
<span class="sd">``py = f(px) = 3px^2 + 2px + 1``. Now pairs of (px, py) points in poly frame is obtained.</span>

<span class="sd">Then (px, py) will go through several transformations to get to the world frame:</span>
<span class="sd">- Rotated by ``angle`` radians counterclockwise</span>
<span class="sd">- Scaled by ``scale``</span>
<span class="sd">- Translated by ``(x, y)``</span>

<span class="sd">Then to calculate reflections and whatnot, internally, all rays will be translated from world to poly</span>
<span class="sd">frame, then the intersection points are solved and then results will be translated from poly back</span>
<span class="sd">to world frame.</span>

<span class="sd">:param x: translation applied to surface</span>
<span class="sd">:param angle: angle to rotate the surface by</span>
<span class="sd">:param scale: scaling factor to scale the surface by</span>
<span class="sd">:param xmin: to define the domain of the given polynomial in poly frame</span>
<span class="sd">:param coeff: polynomial coefficients&quot;&quot;&quot;</span>                                         <span class="c1"># PolySurface</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_superAlreadyInit&quot;</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    <span class="c1"># PolySurface</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This only works with polynomial of order 2 or higher. Use the simpler :class:`LineSurface` for order 1!&quot;</span><span class="p">)</span> <span class="c1"># PolySurface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coeff</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span> <span class="c1"># PolySurface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">buildF</span><span class="p">(</span><span class="n">coeff</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">buildDF</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>                         <span class="c1"># PolySurface</span></div>
<div class="viewcode-block" id="PolySurface.parabola"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.parabola">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># PolySurface</span>
    <span class="k">def</span> <span class="nf">parabola</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="n">PolySurface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># PolySurface</span></div>
<div class="viewcode-block" id="PolySurface.parabolaFrom2Points"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.parabolaFrom2Points">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># PolySurface</span>
    <span class="k">def</span> <span class="nf">parabolaFrom2Points</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                      <span class="c1"># PolySurface</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">;</span> <span class="n">mx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">;</span> <span class="n">my</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>                   <span class="c1"># PolySurface</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">);</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="p">);</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">);</span> <span class="n">height</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># PolySurface</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">+</span> <span class="n">height</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span> <span class="n">y</span> <span class="o">=</span> <span class="n">my</span> <span class="o">+</span> <span class="n">height</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">-</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># PolySurface</span>
        <span class="k">return</span> <span class="n">PolySurface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">dist</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dist</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># PolySurface</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__copy__</span><span class="p">();</span> <span class="n">res</span><span class="o">.</span><span class="n">_superAlreadyInit</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">res</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">);</span> <span class="k">return</span> <span class="n">res</span> <span class="c1"># PolySurface</span>
<div class="viewcode-block" id="PolySurface.world2poly"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.world2poly">[docs]</a>    <span class="k">def</span> <span class="nf">world2poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wxs</span><span class="p">,</span> <span class="n">wys</span><span class="p">):</span> <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">);</span> <span class="n">xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">wxs</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">;</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="n">wys</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">;</span> <span class="k">return</span> <span class="n">xs</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">ys</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">xs</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="n">ys</span><span class="o">*</span><span class="n">c</span> <span class="c1"># PolySurface</span></div>
<div class="viewcode-block" id="PolySurface.poly2world"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.poly2world">[docs]</a>    <span class="k">def</span> <span class="nf">poly2world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pxs</span><span class="p">,</span> <span class="n">pys</span><span class="p">):</span> <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="n">pxs</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">pys</span><span class="o">*</span><span class="n">s</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="n">pxs</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="n">pys</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="c1"># PolySurface</span></div>
    <span class="k">def</span> <span class="nf">_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">):</span>                                                       <span class="c1"># PolySurface</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world2poly</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">rtheta</span> <span class="o">=</span> <span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">;</span> <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span> <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeff</span> <span class="c1"># PolySurface</span>
        <span class="c1"># this clusterfuck piece of code is trying to solve f(rx+beta*cos(rtheta))-(ry+beta*sin(rtheta))=0. I don&#39;t want to use numerical # PolySurface</span>
        <span class="c1"># methods as those are not vectorized, so I have to rewrite the whole equation in terms of beta and then do the vectorized # PolySurface</span>
        <span class="c1"># analytical quadratic formula later on. This code builds up that polynomial array where the variable is beta # PolySurface</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">rx</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">polys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># first column is x^0, last row is x^n # PolySurface</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># trying to expand c0*(ax+b)^0 + c1*(ax+b)^1 + ... + cn*(ax+b)^n # PolySurface</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ex</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="n">polys</span><span class="p">[:,</span><span class="n">ex</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coeff</span><span class="p">[</span><span class="n">ex</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="o">**</span><span class="n">k</span> <span class="c1"># PolySurface</span>
        <span class="n">polys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ry</span><span class="p">;</span> <span class="n">polys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rtheta</span><span class="p">)</span> <span class="c1"># then adding some correction term. Once polynomials are formed, then beta can be solved, and normal angles can be found # PolySurface</span>
        <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">(</span><span class="n">polys</span><span class="p">);</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">rx</span><span class="o">+</span><span class="n">beta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rtheta</span><span class="p">);</span> <span class="n">intersected</span><span class="p">[((</span><span class="n">tx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">))]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># PolySurface</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">);</span> <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="n">tx</span><span class="p">))</span><span class="o">+</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">;</span> <span class="k">return</span> <span class="n">intersected</span><span class="p">,</span> <span class="n">beta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">angles</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="c1"># PolySurface</span>
<div class="viewcode-block" id="PolySurface.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.PolySurface.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">pxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">);</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly2world</span><span class="p">(</span><span class="n">pxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">pxs</span><span class="p">));</span> <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="c1"># PolySurface</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>                                                     <span class="c1"># PolySurface</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">);</span> <span class="n">pxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">);</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly2world</span><span class="p">(</span><span class="n">pxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">pxs</span><span class="p">));</span> <span class="c1"># PolySurface</span>
        <span class="p">[</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinSt</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">p5</span><span class="o">.</span><span class="n">line</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">ignore</span><span class="p">();</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># PolySurface</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Poly(Surface) coeff=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coeff</span><span class="si">}</span><span class="s2"> x=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> y=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> angle(deg)=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> scale=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> xmin=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> xmax=</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_repr</span><span class="p">()</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># PolySurface</span></div>
<div class="viewcode-block" id="RaysPath"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RaysPath">[docs]</a><span class="k">class</span> <span class="nc">RaysPath</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                        <span class="c1"># RaysPath</span>
<div class="viewcode-block" id="RaysPath.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RaysPath.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rayss</span><span class="p">:</span><span class="s2">&quot;List[Rays]&quot;</span><span class="p">):</span>                                      <span class="c1"># RaysPath</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Container for a list of :class:`Rays`, and have mechanism to</span>
<span class="sd">draw them out with a slight path correction. Expected to contain</span>
<span class="sd">output of a ray tracing session.&quot;&quot;&quot;</span>                                              <span class="c1"># RaysPath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_og</span> <span class="o">=</span> <span class="n">rayss</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rayss</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span> <span class="k">for</span> <span class="n">rays</span> <span class="ow">in</span> <span class="n">rayss</span><span class="p">]</span>       <span class="c1"># RaysPath</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>                                                     <span class="c1"># RaysPath</span>
        <span class="n">oldRays</span> <span class="o">=</span> <span class="kc">None</span>                                                           <span class="c1"># RaysPath</span>
        <span class="k">for</span> <span class="n">rays</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rayss</span><span class="p">:</span> <span class="n">rays</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">if</span> <span class="n">oldRays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rays</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">oldRays</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">);</span> <span class="n">oldRays</span> <span class="o">=</span> <span class="n">rays</span> <span class="c1"># RaysPath</span>
        <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span>                                                          <span class="c1"># RaysPath</span>
<div class="viewcode-block" id="RaysPath.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.RaysPath.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rayss</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># RaysPath</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">RaysPath</span><span class="p">([</span><span class="n">rays</span> <span class="k">for</span> <span class="n">rays</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_og</span><span class="p">])</span>             <span class="c1"># RaysPath</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rayss</span><span class="p">)</span>                                    <span class="c1"># RaysPath</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rayss</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                           <span class="c1"># RaysPath</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;RaysPath #rays=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rayss</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>             <span class="c1"># RaysPath</span></div>
<div class="viewcode-block" id="OpticElement"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticElement">[docs]</a><span class="k">class</span> <span class="nc">OpticElement</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                    <span class="c1"># OpticElement</span>
    <span class="n">surfaces</span><span class="p">:</span><span class="s2">&quot;List[Surface]&quot;</span>                                                     <span class="c1"># OpticElement</span>
<div class="viewcode-block" id="OpticElement.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticElement.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># OpticElement</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents a solid object with several Surfaces&quot;&quot;&quot;</span>                    <span class="c1"># OpticElement</span>
        <span class="k">pass</span>                                                                     <span class="c1"># OpticElement</span></div>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">)</span>                                 <span class="c1"># OpticElement</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                        <span class="c1"># OpticElement</span>
<div class="viewcode-block" id="OpticElement.cast"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticElement.cast">[docs]</a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="n">OpticSystem</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">rays</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># OpticElement</span></div></div>
<span class="k">def</span> <span class="nf">signed_area</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>                                                         <span class="c1"># signed_area</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">);</span> <span class="n">area</span> <span class="o">=</span> <span class="mf">0.0</span>                                                  <span class="c1"># signed_area</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">;</span> <span class="n">area</span> <span class="o">+=</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># signed_area</span>
    <span class="k">return</span> <span class="n">area</span> <span class="o">/</span> <span class="mf">2.0</span>                                                            <span class="c1"># signed_area</span>
<div class="viewcode-block" id="Polygon"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Polygon">[docs]</a><span class="k">class</span> <span class="nc">Polygon</span><span class="p">(</span><span class="n">OpticElement</span><span class="p">):</span>                                                     <span class="c1"># Polygon</span>
<div class="viewcode-block" id="Polygon.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Polygon.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>                                       <span class="c1"># Polygon</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an OpticElement that has the shape of any polygon you want.</span>
<span class="sd">Example::</span>

<span class="sd">    p = Polygon([[1, 2], [3, 4], [5, 6]])</span>

<span class="sd">This will create a prism with verticies at the specified points&quot;&quot;&quot;</span>               <span class="c1"># Polygon</span>
        <span class="k">if</span> <span class="n">points</span> <span class="ow">and</span> <span class="n">signed_area</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># Polygon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">([</span><span class="o">*</span><span class="n">points</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">:</span> <span class="n">LineSurface</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">,</span> <span class="n">opticElement</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">())</span> <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># Polygon</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">ans</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">();</span> <span class="n">ans</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">;</span> <span class="n">ans</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">];</span> <span class="k">return</span> <span class="n">ans</span> <span class="c1"># Polygon</span>
<div class="viewcode-block" id="Polygon.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Polygon.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># Polygon</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">];</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># Polygon</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Polygon(OpticElement) #points=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2"> position=(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="nb">round</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cli</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="c1"># Polygon</span></div>
<div class="viewcode-block" id="Lens"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Lens">[docs]</a><span class="k">class</span> <span class="nc">Lens</span><span class="p">(</span><span class="n">OpticElement</span><span class="p">):</span>                                                        <span class="c1"># Lens</span>
<div class="viewcode-block" id="Lens.__init__"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Lens.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R1</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">R2</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="s2">&quot;arc&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span> <span class="c1"># Lens</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents a Lens with center at (x, y), and with 2 radiuses, R1 for left and R2 for right.</span>

<span class="sd">:param R1: radius of the left side, works for both arc and parabola mode</span>
<span class="sd">:param angle: angle offset of the Lens</span>
<span class="sd">:param surface: either &quot;arc&quot; or &quot;parabola&quot;, which will make a lens of that geometry&quot;&quot;&quot;</span> <span class="c1"># Lens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">R1</span> <span class="o">=</span> <span class="n">R1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">R2</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="c1"># Lens</span>
        <span class="n">dx1</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">thickness</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">R1</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">R1</span><span class="p">))))</span> <span class="k">if</span> <span class="n">R1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">thickness</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># Lens</span>
        <span class="n">dx2</span> <span class="o">=</span> <span class="p">(</span> <span class="n">thickness</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">R2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">R2</span><span class="p">))))</span> <span class="k">if</span> <span class="n">R1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">thickness</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># Lens</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span> <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span> <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="n">trans</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">c</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">cy</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">c</span><span class="p">]</span> <span class="c1"># Lens</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gp1&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;gp2&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">};</span> <span class="n">fkw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kw</span><span class="p">);</span> <span class="n">fkw</span><span class="p">[</span><span class="s2">&quot;gp1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;gp2&quot;</span><span class="p">];</span> <span class="n">fkw</span><span class="p">[</span><span class="s2">&quot;gp2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;gp1&quot;</span><span class="p">]</span> <span class="c1"># Lens</span>
        <span class="k">if</span> <span class="n">surface</span> <span class="o">==</span> <span class="s2">&quot;arc&quot;</span><span class="p">:</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">ArcSurface</span><span class="o">.</span><span class="n">from2Points</span>                       <span class="c1"># Lens</span>
        <span class="k">elif</span> <span class="n">surface</span> <span class="o">==</span> <span class="s2">&quot;parabola&quot;</span><span class="p">:</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">PolySurface</span><span class="o">.</span><span class="n">parabolaFrom2Points</span>       <span class="c1"># Lens</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Does not recognize the surface &#39;</span><span class="si">{</span><span class="n">surface</span><span class="si">}</span><span class="s2">&#39;. Only &#39;arc&#39; and &#39;parabola&#39; is valid right now&quot;</span><span class="p">)</span> <span class="c1"># Lens</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">[</span>                                                        <span class="c1"># Lens</span>
            <span class="n">LineSurface</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx2</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>     <span class="c1"># Lens</span>
            <span class="n">meth</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">R1</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">kw</span> <span class="k">if</span> <span class="n">R1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fkw</span><span class="p">)),</span> <span class="c1"># Lens</span>
            <span class="n">LineSurface</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx2</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">),</span>   <span class="c1"># Lens</span>
            <span class="n">meth</span><span class="p">(</span><span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx2</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="n">trans</span><span class="p">(</span><span class="n">dx2</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">R2</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span><span class="n">kw</span> <span class="k">if</span> <span class="n">R2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fkw</span><span class="p">))</span> <span class="c1"># Lens</span>
        <span class="p">]</span>                                                                        <span class="c1"># Lens</span></div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">ans</span> <span class="o">=</span> <span class="n">Lens</span><span class="p">();</span> <span class="n">ans</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">];</span> <span class="k">return</span> <span class="n">ans</span> <span class="c1"># Lens</span>
<div class="viewcode-block" id="Lens.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.Lens.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># Lens</span></div>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">];</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># Lens</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Lens R1=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">R1</span><span class="si">}</span><span class="s2"> R2=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">R2</span><span class="si">}</span><span class="s2"> thickness=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness</span><span class="si">}</span><span class="s2"> height=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># Lens</span></div>
<div class="viewcode-block" id="OpticSystem"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticSystem">[docs]</a><span class="k">class</span> <span class="nc">OpticSystem</span><span class="p">(</span><span class="n">Drawable</span><span class="p">):</span>                                                     <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span><span class="s2">&quot;List[OpticElement | Surface]&quot;</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">envGlassParam</span><span class="o">=</span><span class="n">gps</span><span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">]):</span> <span class="c1"># OpticSystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envGlassParam</span> <span class="o">=</span> <span class="n">envGlassParam</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSurfaces</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">elements</span> <span class="ow">or</span> <span class="p">[])</span> <span class="c1"># OpticSystem</span>
<div class="viewcode-block" id="OpticSystem.add"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticSystem.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">elements</span><span class="p">):</span>                                                    <span class="c1"># OpticSystem</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>                                                 <span class="c1"># OpticSystem</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Surface</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSurfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="c1"># element is copied so that this OpticSystem can freely modify all Surfaces params without worrying that it will affect other setups # OpticSystem</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">OpticElement</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">element</span><span class="p">))</span> <span class="c1"># OpticSystem</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can only add either Surface or OpticElement. Object passed in is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># OpticSystem</span>
        <span class="k">return</span> <span class="bp">self</span>                                                              <span class="c1"># OpticSystem</span></div>
    <span class="k">def</span> <span class="nf">_details</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>                                                   <span class="c1"># OpticSystem</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>                                                        <span class="c1"># OpticSystem</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span><span class="p">:</span>                                             <span class="c1"># OpticSystem</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>                                                        <span class="c1"># OpticSystem</span>
            <span class="k">for</span> <span class="n">sur</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">surfaces</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">sur</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>          <span class="c1"># OpticSystem</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>                                                            <span class="c1"># OpticSystem</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSurfaces</span><span class="p">:</span>                                                     <span class="c1"># OpticSystem</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Raw surfaces:</span><span class="se">\n</span><span class="s2">&quot;</span>                                               <span class="c1"># OpticSystem</span>
            <span class="k">for</span> <span class="n">sur</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSurfaces</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">sur</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>    <span class="c1"># OpticSystem</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>                                                            <span class="c1"># OpticSystem</span>
        <span class="k">return</span> <span class="n">s</span>                                                                 <span class="c1"># OpticSystem</span>
    <span class="nd">@property</span>                                                                    <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="nf">surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># OpticSystem</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs all surfaces from all optic elements and raw surfaces&quot;&quot;&quot;</span>        <span class="c1"># OpticSystem</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">surfaces</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSurfaces</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinSt</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># OpticSystem</span>
<div class="viewcode-block" id="OpticSystem.cast"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticSystem.cast">[docs]</a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rays</span><span class="p">:</span><span class="n">Rays</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RaysPath</span><span class="p">:</span>             <span class="c1"># OpticSystem</span>
        <span class="n">rays</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rays</span><span class="p">);</span> <span class="n">surfaces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span>                         <span class="c1"># OpticSystem</span>
        <span class="c1"># if verbose: print(f&quot;OpticElements ({len(self.opticElements)} total):&quot;); print(self.opticElements | cli.insId() | ~cli.apply(lambda i,e: f&quot;{i}) {e}&quot;) | cli.join(&quot;\n&quot;)) # OpticSystem</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">):</span>                                         <span class="c1"># OpticSystem</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">gp1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">gp2</span> <span class="ow">is</span> <span class="kc">None</span>                                 <span class="c1"># OpticSystem</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">or</span> <span class="n">b</span><span class="p">:</span>                                                           <span class="c1"># OpticSystem</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">gp1</span> <span class="o">=</span> <span class="n">gps</span><span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">]</span>                               <span class="c1"># OpticSystem</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">gp2</span> <span class="o">=</span> <span class="n">gps</span><span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">]</span>                             <span class="c1"># OpticSystem</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Surface #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> have to have at least one specified glass params&quot;</span><span class="p">)</span> <span class="c1"># OpticSystem</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_details</span><span class="p">())</span>                                       <span class="c1"># OpticSystem</span>
        <span class="c1"># if verbose: print(f&quot;\nSurfaces ({len(surfaces)} total):&quot;); print(surfaces | cli.insId() | ~cli.apply(lambda i,s: f&quot;{i}) {s}&quot;) | cli.join(&quot;\n&quot;), end=&quot;\n\n&quot;) # OpticSystem</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rays</span><span class="p">;</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">];</span> <span class="n">data</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="p">[]</span>                        <span class="c1"># OpticSystem</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">passes</span><span class="p">):</span>                                                  <span class="c1"># OpticSystem</span>
            <span class="n">raysBefore</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">raysAfter</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([]);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span> <span class="c1"># OpticSystem</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="p">:</span> <span class="n">rp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">raysBefore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span> <span class="n">raysAfter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">castS</span><span class="p">(</span><span class="n">rp</span><span class="p">))</span> <span class="c1"># casting to all available surfaces # OpticSystem</span>
            <span class="n">raysBefore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">raysBefore</span><span class="p">]);</span> <span class="n">raysAfter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">raysAfter</span><span class="p">]);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">raysBefore</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">raysAfter</span><span class="p">)])</span> <span class="c1"># OpticSystem</span>
            <span class="n">intersected</span> <span class="o">=</span> <span class="n">raysAfter</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">raysBefore</span><span class="p">[:,:,</span><span class="mi">5</span><span class="p">];</span> <span class="n">intersected</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">&lt;</span> <span class="n">intersected</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">intersected</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intersected</span><span class="p">)</span> <span class="c1"># OpticSystem</span>
            <span class="n">raysBefore</span><span class="p">[</span><span class="o">~</span><span class="n">intersected</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span> <span class="c1"># If there&#39;re no intersections, then set the raysBefore&#39;s lengths to inf. Checks for intersection by noting the #transforms # OpticSystem</span>
            <span class="n">argmin</span> <span class="o">=</span> <span class="n">raysBefore</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toArgmin</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">();</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argmin</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argmin</span><span class="p">)</span> <span class="c1"># then checks for closest interaction # OpticSystem</span>
            <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">raysBefore</span><span class="p">[</span><span class="n">argmin</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">raysBefore</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])];</span> <span class="n">newR</span> <span class="o">=</span> <span class="n">Rays</span><span class="p">(</span><span class="n">raysAfter</span><span class="p">[</span><span class="n">argmin</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">raysAfter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">ogSurface</span><span class="o">=</span><span class="n">surfaces</span><span class="p">[</span><span class="n">argmin</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()])</span> <span class="c1"># OpticSystem</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">newR</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]):</span> <span class="k">break</span> <span class="c1"># trim away at the paths that no longer change in #transforms # OpticSystem</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">newR</span><span class="p">;</span> <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>                                             <span class="c1"># OpticSystem</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">pretty</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insId</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;Pass: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">; &quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;chosen surfaces: </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span> <span class="c1"># OpticSystem</span>
        <span class="k">return</span> <span class="n">RaysPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>                                                    <span class="c1"># OpticSystem</span></div>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                        <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">)</span>                                 <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="nf">_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;surfaceIdx2Id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">idx</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">)};</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span><span class="p">];</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">_draw</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">];</span> <span class="k">return</span> <span class="n">p5</span><span class="o">.</span><span class="n">svg</span><span class="p">()</span> <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;OpticSystem #opticElements=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span><span class="p">)</span><span class="si">}</span><span class="s2"> #surfaces=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># OpticSystem</span>
    <span class="k">def</span> <span class="nf">_repr_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_details</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">)</span> <span class="c1"># OpticSystem</span>
<div class="viewcode-block" id="OpticSystem.bounds"><a class="viewcode-back" href="../../kop.html#k1lib.kop.OpticSystem.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">opticElements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surfaces</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">bounds</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinSt</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMin</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">+</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># OpticSystem</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Quang Ho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>