<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>k1lib.k1ui.main &mdash; k1lib  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> k1lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../base.html">Base module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">k1lib.cli module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../callbacks/index.html">k1lib.callbacks module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../k1a.html">k1lib._k1a module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../k1ui.html">k1lib.k1ui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../eqn.html">k1lib.eqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fmt.html">k1lib.fmt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphEqn.html">k1lib.graphEqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../imports.html">k1lib.imports module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mo.html">k1lib.mo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../knn.html">k1lib.knn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../p5.html">k1lib.p5 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schedule.html">k1lib.schedule module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../selector.html">k1lib.selector module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../serve.html">k1lib.serve module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viz.html">k1lib.viz module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../monkey.html">Monkey patched classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelogs.html">Changelogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">k1lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">k1lib.k1ui.main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for k1lib.k1ui.main</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED FILE! PLEASE DON&#39;T EDIT HERE. EDIT THE SOURCE NOTEBOOKS INSTEAD</span>
<span class="sd">&quot;&quot;&quot;`k1ui &lt;https://github.com/157239n/k1ui&gt;`_ is another project made in Java that</span>
<span class="sd">aims to record and manipulate the screen, keyboard and mouse. The interface to</span>
<span class="sd">that project on its own is clunky, and this module is the Python interface to</span>
<span class="sd">ease its use.</span>

<span class="sd">Not quite developed yet tho, because I&#39;m lazy.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">k1lib</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">asyncio</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">dill</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">warnings</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">k1lib</span><span class="p">;</span> <span class="n">cli</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">cli</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">k1lib.cli</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span> <span class="n">knn</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">knn</span><span class="p">;</span> <span class="n">Cbs</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">Cbs</span><span class="p">;</span> <span class="n">viz</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="p">;</span> <span class="n">websockets</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;websockets&quot;</span><span class="p">)</span>
<span class="n">nn</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;torch.nn&quot;</span><span class="p">);</span> <span class="n">optim</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;torch.optim&quot;</span><span class="p">)</span>
<span class="n">PIL</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;PIL&quot;</span><span class="p">);</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;graphviz&quot;</span><span class="p">);</span> <span class="n">requests</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">);</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;torchvision.transforms&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">torch</span><span class="p">;</span> <span class="n">hasTorch</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span> <span class="n">torch</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">);</span> <span class="n">hasTorch</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">torchvision</span><span class="p">;</span> <span class="n">hasTv</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span> <span class="n">hasTv</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;WsSession&quot;</span><span class="p">,</span> <span class="s2">&quot;selectArea&quot;</span><span class="p">,</span> <span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="s2">&quot;Recording&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Track&quot;</span><span class="p">,</span> <span class="s2">&quot;CharTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;WordTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;ContourTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;ClickTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;WheelTrack&quot;</span><span class="p">,</span> <span class="s2">&quot;StreamTrack&quot;</span><span class="p">,</span>
           <span class="s2">&quot;distNet&quot;</span><span class="p">,</span> <span class="s2">&quot;TrainScreen&quot;</span><span class="p">]</span>
<span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;k1ui&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;server&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:9511&quot;</span><span class="p">,</span> <span class="s2">&quot;normal http server&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;ws&quot;</span><span class="p">,</span> <span class="s2">&quot;ws://localhost:9512&quot;</span><span class="p">,</span> <span class="s2">&quot;websocket server&quot;</span><span class="p">),</span> <span class="s2">&quot;server urls&quot;</span><span class="p">),</span> <span class="s2">&quot;docs related to k1ui java library&quot;</span><span class="p">);</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">k1ui</span>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;draw&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="o">.</span><span class="n">Settings</span><span class="p">(),</span> <span class="s2">&quot;drawing settings&quot;</span><span class="p">)</span>
<span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;trackHeight&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;Track&#39;s height in Recording visualization&quot;</span><span class="p">)</span>
<span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Padding between tracks&quot;</span><span class="p">);</span>
<div class="viewcode-block" id="get"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.get">[docs]</a><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>                                                                   <span class="c1"># get</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a get request to the Java server.</span>
<span class="sd">Example::</span>

<span class="sd">    k1ui.get(&quot;mouse/200/300&quot;) # move mouse to (200, 300)&quot;&quot;&quot;</span>                      <span class="c1"># get</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">http</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>    <span class="c1"># get</span></div>
<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">jsObj</span><span class="p">):</span>                                                           <span class="c1"># post</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a post request to the Java server.</span>
<span class="sd">Example::</span>

<span class="sd">    k1ui.post(&quot;mouse/200/300&quot;) # move mouse to (200, 300)&quot;&quot;&quot;</span>                     <span class="c1"># post</span>
    <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">http</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">jsObj</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="c1"># post</span>
<span class="n">portAutoInc</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="mi">9520</span><span class="p">)</span>                                             <span class="c1"># post</span>
<div class="viewcode-block" id="WsSession"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession">[docs]</a><span class="k">class</span> <span class="nc">WsSession</span><span class="p">:</span>                                                                 <span class="c1"># WsSession</span>
<div class="viewcode-block" id="WsSession.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventCb</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;WsSession&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">mainThreadCb</span><span class="p">:</span><span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;WsSession&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span> <span class="c1"># WsSession</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a websocket connection with the server, with some callback functions</span>

<span class="sd">The callback functions (most are async btw) will be passed a WebSocket object</span>
<span class="sd">as the first argument. You can use it to send messages like this::</span>

<span class="sd">    # this will send a signal to the server to close the session</span>
<span class="sd">    sess.ws.send(json.dumps({&quot;type&quot;: &quot;close&quot;}))</span>
<span class="sd">    # this will send a signal to the server requesting the current screenshot. Result will be deposited into eventCb</span>
<span class="sd">    sess.ws.send(json.dumps({&quot;type&quot;: &quot;screenshot&quot;}))</span>
<span class="sd">    # this will execute a single event</span>
<span class="sd">    sess.ws.send(json.dumps({&quot;type&quot;: &quot;execute&quot;, &quot;event&quot;: {&quot;type&quot;: &quot;keyTyped&quot;, &quot;javaKeyCode&quot;: 0, ...}}))</span>

<span class="sd">Complete, minimum example::</span>

<span class="sd">    events = []</span>
<span class="sd">    async def eventCb(sess, event): events.append(event)</span>
<span class="sd">    async def mainThreadCb(sess):</span>
<span class="sd">        sess.stream(300) # starts a stream with output screen width of 300px</span>
<span class="sd">        await asyncio.sleep(2)</span>
<span class="sd">        await sess.ws.send(json.dumps({&quot;type&quot;: &quot;execute&quot;, &quot;event&quot;: {&quot;type&quot;: &quot;keyPressed&quot;, &quot;javaKeyCode&quot;: 65, &quot;timestamp&quot;: 0}}))</span>
<span class="sd">        await sess.ws.send(json.dumps({&quot;type&quot;: &quot;execute&quot;, &quot;event&quot;: {&quot;type&quot;: &quot;keyReleased&quot;, &quot;javaKeyCode&quot;: 65, &quot;timestamp&quot;: 0}}))</span>
<span class="sd">        await asyncio.sleep(10); sess.close()</span>
<span class="sd">    await k1ui.WsSession(eventCb, mainThreadCb).run()</span>

<span class="sd">What this code does is that it will communicate with the server continuously for 12</span>
<span class="sd">seconds, capturing all events in the mean time and save them into ``events`` list.</span>
<span class="sd">It will start up a UDP stream to capture screenshots continuously, and after 2 seconds,</span>
<span class="sd">it sends 2 events to the server, trying to type the letter &quot;A&quot;. Finally, it waits for</span>
<span class="sd">another 10 seconds and then terminates the connection.</span>

<span class="sd">This interface is quite low-level, and is the basis for all other functionalities.</span>
<span class="sd">Some of them include:</span>

<span class="sd">* :meth:`record`: recording a session</span>
<span class="sd">* :meth:`execute`: executes a list of events</span>

<span class="sd">:param eventCb: (async) will be called whenever there&#39;s a new event</span>
<span class="sd">:param mainThreadCb: (async) will be called after setting up everything</span>
<span class="sd">:param streamWidth: specifies the width of the UDP stream, in pixels&quot;&quot;&quot;</span>          <span class="c1"># WsSession</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventCb</span> <span class="o">=</span> <span class="n">eventCb</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainThreadCb</span> <span class="o">=</span> <span class="n">mainThreadCb</span> <span class="c1"># WsSession</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">eventCb</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;eventCb has to be an async function&quot;</span><span class="p">)</span> <span class="c1"># WsSession</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">mainThreadCb</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mainThreadCb has to be an async function&quot;</span><span class="p">)</span> <span class="c1"># WsSession</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">streams</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># width -&gt; [width, lock, port]    # WsSession</span></div>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_listenLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                 <span class="c1"># WsSession</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                              <span class="c1"># WsSession</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">);</span> <span class="n">_type</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="c1"># WsSession</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># python sends close signal to java, java then sends a close signal back, as an acknowledgement # WsSession</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;screenshot&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventCb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;screenshot&quot;</span><span class="p">,</span> <span class="s2">&quot;bytes&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;screenshot&quot;</span><span class="p">]),</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)})</span> <span class="c1"># WsSession</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;newEvent&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventCb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">])</span>       <span class="c1"># WsSession</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_pingLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                   <span class="c1"># WsSession</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                              <span class="c1"># WsSession</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span> <span class="k">break</span>                                                <span class="c1"># WsSession</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ping&quot;</span><span class="p">}</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">));</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># WsSession</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">break</span>                                                        <span class="c1"># WsSession</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_streamLoop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">locks</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>                             <span class="c1"># WsSession</span>
        <span class="kn">import</span> <span class="nn">cv2</span><span class="p">;</span> <span class="n">streamRefresh</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># refreshes udp stream after this many seconds, so that it doesn&#39;t hang # WsSession</span>
        <span class="k">def</span> <span class="nf">threadLoop</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>                                              <span class="c1"># WsSession</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">,</span> <span class="n">k1</span><span class="o">.</span><span class="n">captureStdout</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>                            <span class="c1"># WsSession</span>
                <span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;startStream/</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;udp://0.0.0.0:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CAP_FFMPEG</span><span class="p">);</span> <span class="n">beginTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># WsSession</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()):</span>                                          <span class="c1"># WsSession</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span> <span class="k">break</span>                                        <span class="c1"># WsSession</span>
                    <span class="n">res</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>                                      <span class="c1"># WsSession</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span> <span class="k">break</span>                                            <span class="c1"># WsSession</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventCb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="n">frame</span><span class="p">[:,:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)}))</span> <span class="c1"># WsSession</span>
                    <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">beginTime</span> <span class="o">&gt;</span> <span class="n">streamRefresh</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># there will be a short time (5s) where there&#39;re 2 udp streams simultaneously dumps events # WsSession</span>
                <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">();</span> <span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;stopStream/</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                         <span class="c1"># WsSession</span>
        <span class="n">ports</span> <span class="o">=</span> <span class="p">[</span><span class="n">port</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="mi">100</span><span class="p">];</span> <span class="n">sel</span> <span class="o">=</span> <span class="mi">0</span>                                      <span class="c1"># WsSession</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>                                                   <span class="c1"># WsSession</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">threadLoop</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">locks</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">ports</span><span class="p">[</span><span class="n">sel</span><span class="p">]))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c1"># WsSession</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">streamRefresh</span><span class="p">);</span> <span class="n">sel</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">sel</span>                      <span class="c1"># WsSession</span>
<div class="viewcode-block" id="WsSession.stream"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession.stream">[docs]</a>    <span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>                                                     <span class="c1"># WsSession</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts a stream with a particular output width. The lower the width, the higher the fps and vice versa&quot;&quot;&quot;</span> <span class="c1"># WsSession</span>
        <span class="k">if</span> <span class="n">width</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t start stream with width </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">. Just use the existing stream.&quot;</span><span class="p">)</span> <span class="c1"># WsSession</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">portAutoInc</span><span class="p">()</span>                                                     <span class="c1"># WsSession</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="p">[</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">width</span><span class="p">,</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()],</span> <span class="n">port</span><span class="p">];</span> <span class="kn">import</span> <span class="nn">cv2</span> <span class="c1"># placed here so that users can see error message if cv2 is not imported # WsSession</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_streamLoop</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="p">[</span><span class="n">width</span><span class="p">]))</span>              <span class="c1"># WsSession</span></div>
<div class="viewcode-block" id="WsSession.run"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession.run">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                         <span class="c1"># WsSession</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connects with Java server, set things up and runs ``mainThreadCb``&quot;&quot;&quot;</span> <span class="c1"># WsSession</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ws</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">1_000_000_000</span><span class="p">)</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span> <span class="c1"># WsSession</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>                   <span class="c1"># WsSession</span>
            <span class="n">_listenLoop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_listenLoop</span><span class="p">())</span>                <span class="c1"># WsSession</span>
            <span class="n">_pingLoop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pingLoop</span><span class="p">());</span>                   <span class="c1"># WsSession</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">mainThreadCb</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                                   <span class="c1"># WsSession</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                          <span class="c1"># WsSession</span>
            <span class="k">await</span> <span class="n">_listenLoop</span>                                                    <span class="c1"># WsSession</span></div>
<div class="viewcode-block" id="WsSession.close"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                             <span class="c1"># WsSession</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Closes the connection with the Java server&quot;&quot;&quot;</span>                         <span class="c1"># WsSession</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already closed&quot;</span><span class="p">);</span> <span class="k">return</span>                          <span class="c1"># WsSession</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;close&quot;</span><span class="p">}</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">)))</span> <span class="c1"># WsSession</span>
        <span class="k">for</span> <span class="n">width</span><span class="p">,</span> <span class="n">locks</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>                         <span class="c1"># WsSession</span>
            <span class="k">with</span> <span class="n">locks</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># make sure all locks are freed. Also important to have the 2 locks be nested in each other, in case everything aligns just right that evades this mechanism # WsSession</span>
                <span class="k">with</span> <span class="n">locks</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="k">pass</span>                                              <span class="c1"># WsSession</span></div>
<div class="viewcode-block" id="WsSession.execute"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WsSession.execute">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>                                             <span class="c1"># WsSession</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes a series of events&quot;&quot;&quot;</span>                                        <span class="c1"># WsSession</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">events</span> <span class="o">|</span> <span class="n">sortF</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>                    <span class="c1"># WsSession</span>
        <span class="n">deltaT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>                  <span class="c1"># WsSession</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">deltaT</span><span class="p">}):</span> <span class="c1"># WsSession</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                               <span class="c1"># WsSession</span>
            <span class="k">if</span> <span class="n">st</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>                                   <span class="c1"># WsSession</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">}))</span>      <span class="c1"># WsSession</span></div></div>
<div class="viewcode-block" id="selectArea"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.selectArea">[docs]</a><span class="k">def</span> <span class="nf">selectArea</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>                                                      <span class="c1"># selectArea</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Selects an area on the screen to focus into&quot;&quot;&quot;</span>                            <span class="c1"># selectArea</span>
    <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selectArea/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                                    <span class="c1"># selectArea</span></div>
<div class="viewcode-block" id="record"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.record">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyCode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">streamWidth</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">iden</span><span class="p">()):</span>               <span class="c1"># selectArea</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Records activities.</span>
<span class="sd">Examples::</span>

<span class="sd">    events = await k1ui.record(t=5) # records for 5 seconds</span>
<span class="sd">    events = await k1ui.record(keyCode=5) # records until &quot;Escape&quot; is pressed</span>
<span class="sd">    events = await k1ui.record() # records until interrupt signal is sent to the process</span>

<span class="sd">Note: these examples only work on jupyter notebooks. For regular Python processes,</span>
<span class="sd">check out official Python docs (https://docs.python.org/3/library/asyncio-task.html)</span>

<span class="sd">:param t: record duration</span>
<span class="sd">:param keyCode: key to stop the recording</span>
<span class="sd">:param streamWidth: whether to opens the UDP stream and capture screenshots at this width or not</span>
<span class="sd">:param f: extra event post processing function&quot;&quot;&quot;</span>                                <span class="c1"># selectArea</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>                                                                  <span class="c1"># selectArea</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">eventCb</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>                                              <span class="c1"># selectArea</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>                                                           <span class="c1"># selectArea</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>                                   <span class="c1"># selectArea</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;keyReleased&quot;</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;keyCode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">keyCode</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># selectArea</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mainThreadCb</span><span class="p">(</span><span class="n">sess</span><span class="p">):</span>                                                <span class="c1"># selectArea</span>
        <span class="k">if</span> <span class="n">streamWidth</span><span class="p">:</span> <span class="n">sess</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">streamWidth</span><span class="p">)</span>                                 <span class="c1"># selectArea</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">t</span><span class="p">);</span> <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                   <span class="c1"># selectArea</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)</span>                                           <span class="c1"># selectArea</span>
    <span class="k">await</span> <span class="n">WsSession</span><span class="p">(</span><span class="n">eventCb</span><span class="p">,</span> <span class="n">mainThreadCb</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">();</span> <span class="k">return</span> <span class="n">events</span>                  <span class="c1"># selectArea</span></div>
<div class="viewcode-block" id="execute"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.execute">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">events</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>                                            <span class="c1"># selectArea</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Executes some events&quot;&quot;&quot;</span>                                                   <span class="c1"># selectArea</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">eventCb</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span> <span class="k">pass</span>                                         <span class="c1"># selectArea</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">mainThreadCb</span><span class="p">(</span><span class="n">sess</span><span class="p">):</span> <span class="k">await</span> <span class="n">sess</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">events</span><span class="p">);</span> <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>       <span class="c1"># selectArea</span>
    <span class="k">await</span> <span class="n">WsSession</span><span class="p">(</span><span class="n">eventCb</span><span class="p">,</span> <span class="n">mainThreadCb</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>                                 <span class="c1"># selectArea</span></div>
<span class="n">uuid</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;k1ui-&quot;</span><span class="p">)</span>             <span class="c1"># selectArea</span>
<span class="k">def</span> <span class="nf">escapeHtml</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;amp;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;lt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;gt;&quot;</span><span class="p">)</span> <span class="c1"># escapeHtml</span>
<span class="k">class</span> <span class="nc">HtmlView</span><span class="p">:</span>                                                                  <span class="c1"># HtmlView</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">html</span>                                   <span class="c1"># HtmlView</span>
    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span>                                      <span class="c1"># HtmlView</span>
<div class="viewcode-block" id="Recording"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording">[docs]</a><span class="k">class</span> <span class="nc">Recording</span><span class="p">:</span>                                                                 <span class="c1"># Recording</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>                                                  <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">=</span> <span class="p">[]</span>                                    <span class="c1"># Recording</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="c1"># shortcut to initialize using cloned tracks rather than events # Recording</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">events</span> <span class="o">|</span> <span class="n">sortF</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span>                     <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ContourTrack</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>                          <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CharTrack</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>                             <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ClickTrack</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>                            <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">WheelTrack</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>                            <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">StreamTrack</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>                           <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">())</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">()</span>                                     <span class="c1"># Recording</span>
    <span class="k">def</span> <span class="nf">_resetTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">())</span> <span class="o">|</span> <span class="n">toMin</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">toMax</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># Recording</span>
    <span class="k">def</span> <span class="nf">_resetDis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">*</span><span class="mf">0.53</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">*</span><span class="mf">0.53</span><span class="p">]);</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># display times # Recording</span>
    <span class="nd">@property</span>                                                                    <span class="c1"># Recording</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>                     <span class="c1"># Recording</span>
<div class="viewcode-block" id="Recording.addTracks"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.addTracks">[docs]</a>    <span class="k">def</span> <span class="nf">addTracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tracks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recording&quot;</span><span class="p">:</span>                                 <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds tracks to the Recording&quot;&quot;&quot;</span>                                       <span class="c1"># Recording</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Track</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tracks</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tr</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">)));</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.removeTracks"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.removeTracks">[docs]</a>    <span class="k">def</span> <span class="nf">removeTracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tracks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recording&quot;</span><span class="p">:</span>                              <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes tracks from the Recording&quot;&quot;&quot;</span>                                  <span class="c1"># Recording</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Track</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Recording</span>
        <span class="n">tracks</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span><span class="o">.</span><span class="n">remove</span><span class="p">)</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># Recording</span></div>
    <span class="k">def</span> <span class="nf">_normTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="n">default</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="c1"># Recording</span>
<div class="viewcode-block" id="Recording.zoom"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.zoom">[docs]</a>    <span class="k">def</span> <span class="nf">zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                            <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Zooms into a particular time range. If either bounds are not</span>
<span class="sd">specified, they will default to the start and end of all events.</span>

<span class="sd">:param t1: time values are relative to the recording&#39;s start time&quot;&quot;&quot;</span>             <span class="c1"># Recording</span>
        <span class="n">_dis1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis1</span><span class="p">;</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">_dis1</span> <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>     <span class="c1"># Recording</span>
        <span class="n">_dis2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis2</span><span class="p">;</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">_dis2</span> <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">t2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>     <span class="c1"># Recording</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">;</span> <span class="n">t1</span><span class="o">-=</span><span class="n">delta</span><span class="o">*</span><span class="mf">0.03</span><span class="p">;</span> <span class="n">t2</span><span class="o">+=</span><span class="n">delta</span><span class="o">*</span><span class="mf">0.03</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis1</span> <span class="o">=</span> <span class="n">t1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis2</span> <span class="o">=</span> <span class="n">t2</span> <span class="c1"># Recording</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis1</span> <span class="o">=</span> <span class="n">_dis1</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dis2</span> <span class="o">=</span> <span class="n">_dis2</span><span class="p">;</span> <span class="k">return</span> <span class="n">HtmlView</span><span class="p">(</span><span class="n">html</span><span class="p">)</span> <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.sel"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.sel">[docs]</a>    <span class="k">def</span> <span class="nf">sel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Track&quot;</span><span class="p">]:</span>                <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Selects a subset of tracks using several filters.</span>

<span class="sd">For selecting time, assuming we have a track that looks like</span>
<span class="sd">this (x, y are t1, t2)::</span>

<span class="sd">    # |-1--|   |-2-|</span>
<span class="sd">    #    |---3---|</span>
<span class="sd">    #  x     y</span>

<span class="sd">Then, tracks 1 and 3 are selected. Time values are relative to</span>
<span class="sd">recording&#39;s start time</span>

<span class="sd">:param t1: choose tracks that happen after this time</span>
<span class="sd">:param t2: choose tracks that happen before this time</span>
<span class="sd">:param klass: choose specific track class&quot;&quot;&quot;</span>                                     <span class="c1"># Recording</span>
        <span class="n">tracks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span>                                                    <span class="c1"># Recording</span>
        <span class="k">if</span> <span class="n">klass</span><span class="p">:</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span> <span class="o">|</span> <span class="n">instanceOf</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>                            <span class="c1"># Recording</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">t2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                     <span class="c1"># Recording</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normTime</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">);</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normTime</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">)</span> <span class="c1"># Recording</span>
            <span class="n">tracks</span> <span class="o">=</span> <span class="n">tracks</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">endTime</span><span class="p">,</span> <span class="n">o</span><span class="p">])</span> <span class="o">|</span> <span class="o">~</span><span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">t1</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">t2</span><span class="p">)</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="n">tracks</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>                                                 <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.sel1"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.sel1">[docs]</a>    <span class="k">def</span> <span class="nf">sel1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Track&quot;</span><span class="p">]:</span>                                   <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Like :meth:`sel`, but this time gets the first element only.&quot;&quot;&quot;</span>       <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">|</span> <span class="n">item</span><span class="p">()</span>                                       <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.time0"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.time0">[docs]</a>    <span class="k">def</span> <span class="nf">time0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>                                              <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start and end recording times. Start time is zero&quot;&quot;&quot;</span>                  <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">]</span>                                <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.timeUnix"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.timeUnix">[docs]</a>    <span class="k">def</span> <span class="nf">timeUnix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>                                           <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start and end recording times. Both are absolute unix times&quot;&quot;&quot;</span>        <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">]</span>                                    <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>                                              <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstructs events from the Recording&#39;s internal data.</span>
<span class="sd">The events are lossy though::</span>

<span class="sd">    events = ... # events recorded</span>
<span class="sd">    r = k1ui.Recording(events)</span>
<span class="sd">    assert r.events() != events # this is the lossy part. Don&#39;t expect the produced events match exactly with each other&quot;&quot;&quot;</span> <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">events</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">sortF</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="n">deref</span><span class="p">(</span><span class="n">igT</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Recording.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Recording.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Recording&quot;</span><span class="p">:</span>                                               <span class="c1"># Recording</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a clone of this recording&quot;&quot;&quot;</span>                                  <span class="c1"># Recording</span>
        <span class="k">return</span> <span class="n">Recording</span><span class="p">([])</span><span class="o">.</span><span class="n">addTracks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">()</span> <span class="c1"># Recording</span></div>
    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">createTrackss</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">drawTrackss</span><span class="p">)</span>     <span class="c1"># Recording</span></div>
<div class="viewcode-block" id="Track"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track">[docs]</a><span class="k">class</span> <span class="nc">Track</span><span class="p">:</span>                                                                     <span class="c1"># Track</span>
<div class="viewcode-block" id="Track.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>                                      <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Time values are absolute unix time.&quot;&quot;&quot;</span>                                <span class="c1"># Track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recording</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">startTime</span> <span class="k">if</span> <span class="n">startTime</span> <span class="k">else</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">endTime</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">()</span> <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.time0"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.time0">[docs]</a>    <span class="k">def</span> <span class="nf">time0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>                                              <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start and end track times. Times are relative to track&#39;s start time&quot;&quot;&quot;</span> <span class="c1"># Track</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">]</span>                                <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.time0Rec"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.time0Rec">[docs]</a>    <span class="k">def</span> <span class="nf">time0Rec</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>                                           <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start and end track times. Times are relative to recording&#39;s start time&quot;&quot;&quot;</span> <span class="c1"># Track</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">startTime</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">startTime</span><span class="p">]</span> <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.timeUnix"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.timeUnix">[docs]</a>    <span class="k">def</span> <span class="nf">timeUnix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>                                           <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start and end track times. Times are absolute unix times&quot;&quot;&quot;</span>           <span class="c1"># Track</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">]</span>                                    <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.concurrent"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.concurrent">[docs]</a>    <span class="k">def</span> <span class="nf">concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Track&quot;</span><span class="p">]:</span>                                       <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs all tracks that are concurrent to this track&quot;&quot;&quot;</span>                 <span class="c1"># Track</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time0Rec</span><span class="p">())</span>                              <span class="c1"># Track</span></div>
    <span class="k">def</span> <span class="nf">_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span> <span class="o">=</span> <span class="n">recording</span><span class="p">;</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># inject dependency # Track</span>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>                                           <span class="c1"># Track</span>
    <span class="k">def</span> <span class="nf">_displayTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># shortcut func for displaying in __repr__          # Track</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">startTime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># Track</span>
        <span class="n">e</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">startTime</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">;</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;time (</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="c1"># Track</span>
<div class="viewcode-block" id="Track.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>                                              <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstructs events from the Track&#39;s internal data, to be implemented by subclasses.&quot;&quot;&quot;</span> <span class="c1"># Track</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>                                                    <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                              <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a clone of this Track, to be implemented by subclasses&quot;&quot;&quot;</span>     <span class="c1"># Track</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>                                                    <span class="c1"># Track</span></div>
<div class="viewcode-block" id="Track.move"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.Track.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">):</span>                                                   <span class="c1"># Track</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Moves the entire track left or right, to be implemented by subclasses.</span>

<span class="sd">:param deltaTime: if negative, move left by this number of seconds, else move right&quot;&quot;&quot;</span> <span class="c1"># Track</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">+=</span> <span class="n">deltaTime</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">+=</span> <span class="n">deltaTime</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">()</span> <span class="c1"># Track</span></div></div>
<div class="viewcode-block" id="CharTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack">[docs]</a><span class="k">class</span> <span class="nc">CharTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span>                                                          <span class="c1"># CharTrack</span>
<div class="viewcode-block" id="CharTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyText</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">keyCode</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">mods</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span> <span class="n">times</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span> <span class="c1"># CharTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing 1 key pressed and released.</span>

<span class="sd">:param keyText: text to display to user, like &quot;Enter&quot;</span>
<span class="sd">:param keyCode: event&#39;s &quot;javaKeyCode&quot;</span>
<span class="sd">:param mods: list of 3 booleans, whether ctrl, shift or alt is pressed&quot;&quot;&quot;</span>        <span class="c1"># CharTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">times</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyText</span> <span class="o">=</span> <span class="n">keyText</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCode</span> <span class="o">=</span> <span class="n">keyCode</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mods</span> <span class="o">=</span> <span class="n">mods</span> <span class="c1"># CharTrack</span></div>
<div class="viewcode-block" id="CharTrack.parse"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack.parse">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># CharTrack</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;CharTrack&quot;</span><span class="p">]:</span>                                      <span class="c1"># CharTrack</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># keyCode -&gt; obj                                             # CharTrack</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>                                                          <span class="c1"># CharTrack</span>
            <span class="n">_type</span><span class="p">,</span> <span class="n">keyText</span><span class="p">,</span> <span class="n">keyCode</span><span class="p">,</span> <span class="n">mods</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">e</span>                         <span class="c1"># CharTrack</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;keyPressed&quot;</span><span class="p">:</span>                                            <span class="c1"># CharTrack</span>
                <span class="k">if</span> <span class="n">keyCode</span> <span class="ow">in</span> <span class="n">stacks</span> <span class="ow">and</span> <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]:</span>                        <span class="c1"># CharTrack</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">];</span> <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>                     <span class="c1"># CharTrack</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="n">_type</span><span class="p">,</span> <span class="n">keyText</span><span class="p">,</span> <span class="n">keyCode</span><span class="p">,</span> <span class="n">mods</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">]]</span> <span class="c1"># CharTrack</span>
                    <span class="c1">#raise Exception(&quot;Strange case. Why would the same key be pressed twice without being released first&quot;) # CharTrack</span>
                <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>                                              <span class="c1"># CharTrack</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;keyReleased&quot;</span><span class="p">:</span>                                           <span class="c1"># CharTrack</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]</span> <span class="k">if</span> <span class="n">keyCode</span> <span class="ow">in</span> <span class="n">stacks</span> <span class="ow">and</span> <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># CharTrack</span>
                <span class="n">stacks</span><span class="p">[</span><span class="n">keyCode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span>                            <span class="c1"># CharTrack</span>
        <span class="k">def</span> <span class="nf">makeTrack</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>                                                     <span class="c1"># CharTrack</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>                        <span class="c1"># CharTrack</span>
            <span class="k">return</span> <span class="n">CharTrack</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">4</span><span class="p">]])</span>                     <span class="c1"># CharTrack</span>
        <span class="k">return</span> <span class="n">events</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;keyTyped&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;keyText&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;javaKeyCode&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;ctrl&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">]],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">])</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">())</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="n">makeTrack</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># CharTrack</span></div>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span> <span class="k">return</span> <span class="n">escapeHtml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>                  <span class="c1"># CharTrack</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;CharTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> keyText (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">keyText</span><span class="si">}</span><span class="s2">)&gt;&quot;</span> <span class="c1"># CharTrack</span>
<div class="viewcode-block" id="CharTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># CharTrack</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">()</span> <span class="c1"># does not care about mods because the mods will have a separate CharTrack already, so we don&#39;t have to repeat # CharTrack</span>
        <span class="k">if</span> <span class="n">t1</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyPressed&quot;</span><span class="p">,</span> <span class="s2">&quot;keyText&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyText</span><span class="p">,</span> <span class="s2">&quot;javaKeyCode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t1</span><span class="o">*</span><span class="mi">1000</span><span class="p">)})</span> <span class="c1"># CharTrack</span>
        <span class="k">if</span> <span class="n">t2</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;keyReleased&quot;</span><span class="p">,</span> <span class="s2">&quot;keyText&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyText</span><span class="p">,</span> <span class="s2">&quot;javaKeyCode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t2</span><span class="o">*</span><span class="mi">1000</span><span class="p">)})</span> <span class="c1"># CharTrack</span>
        <span class="k">return</span> <span class="n">d</span>                                                                 <span class="c1"># CharTrack</span></div>
<div class="viewcode-block" id="CharTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">CharTrack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyText</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mods</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">())</span> <span class="c1"># CharTrack</span></div>
<div class="viewcode-block" id="CharTrack.move"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.CharTrack.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">):</span>                                                   <span class="c1"># CharTrack</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">+=</span> <span class="n">deltaTime</span>                           <span class="c1"># CharTrack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">+=</span> <span class="n">deltaTime</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">()</span>                  <span class="c1"># CharTrack</span></div></div>
<span class="k">def</span> <span class="nf">_ord2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>                                                                    <span class="c1"># _ord2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="nb">ord</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span>                                                 <span class="c1"># _ord2</span>
    <span class="n">x2y</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                                                 <span class="c1"># _ord2</span>
    <span class="n">y2x</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                                                 <span class="c1"># _ord2</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x2y</span><span class="p">,</span> <span class="n">y2x</span><span class="p">]</span>                                                      <span class="c1"># _ord2</span>
<span class="n">_upper</span><span class="p">,</span> <span class="n">_upperCs</span><span class="p">,</span> <span class="n">_upperD1</span><span class="p">,</span> <span class="n">_upperD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="p">);</span>      <span class="c1"># _ord2</span>
<span class="n">_lower</span><span class="p">,</span> <span class="n">_lowerCs</span><span class="p">,</span> <span class="n">_lowerD1</span><span class="p">,</span> <span class="n">_lowerD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">)</span>       <span class="c1"># _ord2</span>
<span class="n">_num</span><span class="p">,</span> <span class="n">_numCs</span><span class="p">,</span> <span class="n">_numD1</span><span class="p">,</span> <span class="n">_numD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;1234567890&quot;</span><span class="p">)</span>                               <span class="c1"># _ord2</span>
<span class="n">_puncLower</span><span class="p">,</span> <span class="n">_puncLowerCs</span><span class="p">,</span> <span class="n">_puncLowerD1</span><span class="p">,</span> <span class="n">_puncLowerD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;[];&#39;,./`-=</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>     <span class="c1"># _ord2</span>
<span class="n">_puncUpper</span><span class="p">,</span> <span class="n">_puncUpperCs</span><span class="p">,</span> <span class="n">_puncUpperD1</span><span class="p">,</span> <span class="n">_puncUpperD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;?~_+|&quot;</span><span class="p">)</span>     <span class="c1"># _ord2</span>
<span class="c1"># maps from numbers 12345 to punctuation like !@#$%                              # _ord2</span>
<span class="n">_numPunc</span><span class="p">,</span> <span class="n">_numPuncCs</span><span class="p">,</span> <span class="n">_numPuncD1</span><span class="p">,</span> <span class="n">_numPuncD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="s2">&quot;!@#$%^&amp;*()&quot;</span><span class="p">)</span>               <span class="c1"># _ord2</span>
<span class="n">_numPuncMap1</span> <span class="o">=</span> <span class="p">[</span><span class="n">_numPuncCs</span><span class="p">,</span> <span class="n">_numCs</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">_numPuncMap2</span> <span class="o">=</span> <span class="p">[</span><span class="n">_numCs</span><span class="p">,</span> <span class="n">_numPuncCs</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># _ord2</span>
<span class="n">_punc</span><span class="p">,</span> <span class="n">_puncCs</span><span class="p">,</span> <span class="n">_puncD1</span><span class="p">,</span> <span class="n">_puncD2</span> <span class="o">=</span> <span class="n">_ord2</span><span class="p">(</span><span class="n">_puncLower</span> <span class="o">+</span> <span class="n">_puncUpper</span> <span class="o">+</span> <span class="n">_numPunc</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="c1"># _ord2</span>
<span class="c1"># maps from lower case punctuation like ;&#39;,./ into upper case like :&quot;&lt;&gt;?         # _ord2</span>
<span class="n">_puncMap</span> <span class="o">=</span> <span class="p">[</span><span class="n">_puncLower</span><span class="p">,</span> <span class="n">_puncUpper</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span> <span class="n">_puncMapCs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_puncLowerCs</span><span class="p">,</span> <span class="n">_puncUpperCs</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># _ord2</span>
<span class="n">_puncMap2</span> <span class="o">=</span> <span class="p">[</span><span class="n">_puncUpper</span><span class="p">,</span> <span class="n">_puncLower</span><span class="p">]</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                             <span class="c1"># _ord2</span>
<span class="k">def</span> <span class="nf">_inferText</span><span class="p">(</span><span class="n">code</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">mods</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>                                           <span class="c1"># _inferText</span>
    <span class="k">if</span> <span class="n">mods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">mods</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">None</span>                                           <span class="c1"># _inferText</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">mods</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>                                                              <span class="c1"># _inferText</span>
    <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>                                                                    <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_upperCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_upperD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>                               <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_lowerCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_lowerD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>                       <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_numCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_numPuncD2</span><span class="p">[</span><span class="n">_numPuncMap2</span><span class="p">[</span><span class="n">code</span><span class="p">]]</span>                 <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_puncLowerCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_puncUpperD2</span><span class="p">[</span><span class="n">_puncMapCs</span><span class="p">[</span><span class="n">code</span><span class="p">]]</span>           <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_puncCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_puncD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>                                 <span class="c1"># _inferText</span>
        <span class="k">return</span> <span class="kc">None</span>                                                              <span class="c1"># _inferText</span>
    <span class="k">else</span><span class="p">:</span>                                                                        <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_upperCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_upperD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>                       <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_lowerCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_lowerD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>                               <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_numCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_numD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>                                   <span class="c1"># _inferText</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">_puncCs</span><span class="p">:</span> <span class="k">return</span> <span class="n">_puncD2</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>                                 <span class="c1"># _inferText</span>
        <span class="k">return</span> <span class="kc">None</span>                                                              <span class="c1"># _inferText</span>
<span class="k">def</span> <span class="nf">_isUpper</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_upper</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_puncUpper</span> <span class="ow">or</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_numPunc</span> <span class="c1"># _isUpper</span>
<span class="k">def</span> <span class="nf">_canon</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span> <span class="c1"># returns canonical key to be pressed      # _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_num</span><span class="p">:</span> <span class="k">return</span> <span class="n">_numD1</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>                                               <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_upper</span><span class="p">:</span> <span class="k">return</span> <span class="n">_upperD1</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>                                           <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_lower</span><span class="p">:</span> <span class="k">return</span> <span class="n">_upperD1</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>                                   <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_puncLower</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>                                                 <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_puncUpper</span><span class="p">:</span> <span class="k">return</span> <span class="n">_puncMap2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>                                      <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_numPunc</span><span class="p">:</span> <span class="k">return</span> <span class="n">_numPuncMap1</span><span class="p">[</span><span class="n">_numPuncD1</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>                         <span class="c1"># _canon</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_punc</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>                                                      <span class="c1"># _canon</span>
    <span class="k">return</span> <span class="kc">None</span>                                                                  <span class="c1"># _canon</span>
<span class="k">def</span> <span class="nf">_textToKeys</span><span class="p">(</span><span class="n">text</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> <span class="c1"># opposite of _interText                              # _textToKeys</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">sk</span> <span class="o">=</span> <span class="mi">16</span> <span class="c1"># shift key                                     # _textToKeys</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>                                                               <span class="c1"># _textToKeys</span>
        <span class="n">_cap</span> <span class="o">=</span> <span class="n">_isUpper</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                                                       <span class="c1"># _textToKeys</span>
        <span class="k">if</span> <span class="n">_cap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cap</span><span class="p">:</span>   <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">]);</span> <span class="n">cap</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># change to upper # _textToKeys</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_cap</span> <span class="ow">and</span> <span class="n">cap</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">]);</span> <span class="n">cap</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># change to lower # _textToKeys</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;down&quot;</span><span class="p">,</span> <span class="n">_canon</span><span class="p">(</span><span class="n">c</span><span class="p">)]);</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="n">_canon</span><span class="p">(</span><span class="n">c</span><span class="p">)])</span>               <span class="c1"># _textToKeys</span>
    <span class="k">if</span> <span class="n">cap</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="n">sk</span><span class="p">])</span>                                                 <span class="c1"># _textToKeys</span>
    <span class="k">return</span> <span class="n">d</span>                                                                     <span class="c1"># _textToKeys</span>
<span class="k">def</span> <span class="nf">_getTextBlocks</span><span class="p">(</span><span class="n">charTracks</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;CharTrack&quot;</span><span class="p">]):</span> <span class="c1"># Get potential collection of CharTracks # _getTextBlocks</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">charTracks</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">|</span> <span class="n">sortF</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">_inferText</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">keyCode</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">mods</span><span class="p">),</span> <span class="n">x</span><span class="p">])</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># _getTextBlocks</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">inBlock</span> <span class="o">=</span> <span class="kc">False</span>                                             <span class="c1"># _getTextBlocks</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">es</span><span class="p">:</span>                                                            <span class="c1"># _getTextBlocks</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">inBlock</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">);</span> <span class="n">inBlock</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># ends a block   # _getTextBlocks</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inBlock</span><span class="p">:</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">inBlock</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># starts a new block # _getTextBlocks</span>
        <span class="k">if</span> <span class="n">inBlock</span><span class="p">:</span> <span class="n">_d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">obj</span><span class="p">])</span>                                          <span class="c1"># _getTextBlocks</span>
    <span class="k">if</span> <span class="n">inBlock</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span>                                                     <span class="c1"># _getTextBlocks</span>
    <span class="k">return</span> <span class="n">d</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">iden</span><span class="p">())</span>                            <span class="c1"># _getTextBlocks</span>
<div class="viewcode-block" id="WordTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WordTrack">[docs]</a><span class="k">class</span> <span class="nc">WordTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span>                                                          <span class="c1"># WordTrack</span>
<div class="viewcode-block" id="WordTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WordTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>                                 <span class="c1"># WordTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing normal text input. This is not created from events</span>
<span class="sd">directly. Rather, it&#39;s created from scanning over CharTracks and merging them together&quot;&quot;&quot;</span> <span class="c1"># WordTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">times</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>                               <span class="c1"># WordTrack</span></div>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span> <span class="k">return</span> <span class="n">escapeHtml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span>                  <span class="c1"># WordTrack</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;WordTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> text (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">) &gt;&quot;</span> <span class="c1"># WordTrack</span>
<div class="viewcode-block" id="WordTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WordTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># WordTrack</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">_textToKeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">);</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">es</span><span class="p">))</span> <span class="c1"># WordTrack</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">es</span><span class="p">):</span>                                     <span class="c1"># WordTrack</span>
            <span class="n">_type</span> <span class="o">=</span> <span class="s2">&quot;keyPressed&quot;</span> <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;down&quot;</span> <span class="k">else</span> <span class="s2">&quot;keyReleased&quot;</span><span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span> <span class="c1"># WordTrack</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_type</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span> <span class="c1"># WordTrack</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_type</span><span class="p">,</span> <span class="s2">&quot;javaKeyCode&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">})</span> <span class="c1"># WordTrack</span>
        <span class="k">return</span> <span class="n">d</span>                                                                 <span class="c1"># WordTrack</span></div>
<div class="viewcode-block" id="WordTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WordTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">WordTrack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">())</span>                 <span class="c1"># WordTrack</span></div></div>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">)</span>                                                             <span class="c1"># WordTrack</span>
<span class="k">def</span> <span class="nf">formWords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>                                                <span class="c1"># formWords</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tries to merge nearby CharTracks together that looks like the user</span>
<span class="sd">is trying to type something, if they make sense. Assuming the user types</span>
<span class="sd">&quot;a&quot;, then &quot;b&quot;, then &quot;c&quot;. This should be able to detect the intent that</span>
<span class="sd">the user is trying to type &quot;abc&quot;, and replace 3 CharTracks with a WordTrack.</span>
<span class="sd">Example::</span>

<span class="sd">    # example recording, run in notebook cell to see interactive interface</span>
<span class="sd">    r = k1ui.Recording.sample(); r</span>
<span class="sd">    # run in another notebook cell and compare difference</span>
<span class="sd">    r.formWords()&quot;&quot;&quot;</span>                                                             <span class="c1"># formWords</span>
    <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">charTracks</span> <span class="ow">in</span> <span class="n">_getTextBlocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">CharTrack</span><span class="p">)):</span>           <span class="c1"># formWords</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>                                              <span class="c1"># formWords</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">charTracks</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">toMin</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">toMax</span><span class="p">()</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># formWords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeTracks</span><span class="p">(</span><span class="n">charTracks</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">addTracks</span><span class="p">(</span><span class="n">WordTrack</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">ts</span><span class="p">))</span>       <span class="c1"># formWords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removeTracks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">*</span><span class="n">ts</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">),</span> <span class="n">klass</span><span class="o">=</span><span class="n">CharTrack</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">keyCode</span> <span class="o">==</span> <span class="mi">16</span><span class="p">))</span> <span class="c1"># removing shift CharTracks # formWords</span>
    <span class="k">return</span> <span class="bp">self</span>                                                                  <span class="c1"># formWords</span>
<div class="viewcode-block" id="ContourTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack">[docs]</a><span class="k">class</span> <span class="nc">ContourTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span> <span class="c1"># mouse movements                                     # ContourTrack</span>
<div class="viewcode-block" id="ContourTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>                                                  <span class="c1"># ContourTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing mouse trajectory (&quot;mouseMoved&quot; event).</span>

<span class="sd">:param coords: numpy array with shape (#events, [x, y, unix time])&quot;&quot;&quot;</span>            <span class="c1"># ContourTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">toMin</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">toMax</span><span class="p">());</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedImg</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># ContourTrack</span></div>
<div class="viewcode-block" id="ContourTrack.parse"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack.parse">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># ContourTrack</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;ContourTrack&quot;</span><span class="p">]:</span>                                   <span class="c1"># ContourTrack</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">events</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouseMoved&quot;</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouseDragged&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">])</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="c1"># ContourTrack</span>
        <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">coords</span> <span class="o">|</span> <span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[</span><span class="n">ContourTrack</span><span class="p">(</span><span class="n">coords</span><span class="p">)]</span>          <span class="c1"># ContourTrack</span></div>
    <span class="k">def</span> <span class="nf">_img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                              <span class="c1"># ContourTrack</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedImg</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedImg</span>                               <span class="c1"># ContourTrack</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">();</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="c1"># ContourTrack</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time0Rec</span><span class="p">()),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">))</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span> <span class="c1"># ContourTrack</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ContourTrack&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedImg</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span> <span class="o">|</span> <span class="n">toImg</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cachedImg</span> <span class="c1"># ContourTrack</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;ContourTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> n (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&gt;&quot;</span> <span class="c1"># ContourTrack</span>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>                                                     <span class="c1"># ContourTrack</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div&gt;&lt;div style=&quot;margin-bottom:10px&quot;&gt;</span><span class="si">{</span><span class="n">escapeHtml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">())</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_imgHtml</span><span class="p">()</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;&quot;&quot;</span> <span class="c1"># ContourTrack</span>
    <span class="k">def</span> <span class="nf">_imgHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;img src=&quot;data:image/png;base64,</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_img</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">toBytes</span><span class="p">(</span><span class="n">imgType</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">aS</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot; alt=&quot;Mouse trajectory&quot; /&gt;&quot;&quot;&quot;</span> <span class="c1"># ContourTrack</span>
    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;!-- k1ui.ContourTrack --&gt;&lt;div&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_imgHtml</span><span class="p">()</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;&quot;&quot;</span> <span class="c1"># ContourTrack</span>
<div class="viewcode-block" id="ContourTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mouseMoved&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">1000</span><span class="p">)})</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># ContourTrack</span></div>
<div class="viewcode-block" id="ContourTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">ContourTrack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>                    <span class="c1"># ContourTrack</span></div>
<div class="viewcode-block" id="ContourTrack.move"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ContourTrack.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">deltaTime</span><span class="p">;</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">)</span> <span class="c1"># ContourTrack</span></div></div>
<div class="viewcode-block" id="ClickTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack">[docs]</a><span class="k">class</span> <span class="nc">ClickTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span> <span class="c1"># mouse down, then up                                   # ClickTrack</span>
<div class="viewcode-block" id="ClickTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>                    <span class="c1"># ClickTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing a mouse pressed and released event&quot;&quot;&quot;</span>                    <span class="c1"># ClickTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">times</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="c1"># coords = [[x1, y1], [x2, y2]] # ClickTrack</span></div>
<div class="viewcode-block" id="ClickTrack.parse"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack.parse">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># ClickTrack</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;ClickTrack&quot;</span><span class="p">]:</span>                                     <span class="c1"># ClickTrack</span>
        <span class="n">tracks</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">pressedEvents</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># haha, get it?   # ClickTrack</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>                                                          <span class="c1"># ClickTrack</span>
            <span class="n">_type</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">e</span>                                           <span class="c1"># ClickTrack</span>
            <span class="n">pe</span> <span class="o">=</span> <span class="n">pressedEvents</span><span class="p">[</span><span class="n">button</span><span class="p">]</span>                                           <span class="c1"># ClickTrack</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;mousePressed&quot;</span><span class="p">:</span>                                          <span class="c1"># ClickTrack</span>
                <span class="k">if</span> <span class="n">pe</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Strange case. Why would inRange be true when mouse has just been pressed?&quot;</span><span class="p">)</span> <span class="c1"># ClickTrack</span>
                <span class="n">pressedEvents</span><span class="p">[</span><span class="n">button</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>                                        <span class="c1"># ClickTrack</span>
            <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;mouseReleased&quot;</span><span class="p">:</span>                                         <span class="c1"># ClickTrack</span>
                <span class="k">if</span> <span class="n">pe</span><span class="p">:</span> <span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClickTrack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pe</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]]),</span> <span class="p">[</span><span class="n">pe</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]]));</span> <span class="n">pressedEvents</span><span class="p">[</span><span class="n">button</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># ClickTrack</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Strange case. Why would mouse be released right at the start? Not strange enough to warrant an exception though&quot;</span><span class="p">)</span> <span class="c1"># ClickTrack</span>
        <span class="n">events</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mousePressed&quot;</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouseReleased&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;button&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">])</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># ClickTrack</span>
        <span class="k">return</span> <span class="n">tracks</span>                                                            <span class="c1"># ClickTrack</span></div>
<div class="viewcode-block" id="ClickTrack.isClick"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack.isClick">[docs]</a>    <span class="k">def</span> <span class="nf">isClick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>                                              <span class="c1"># ClickTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether this ClickTrack represents a single click.</span>

<span class="sd">:param threshold: if Manhattan distance between start and end is less than this amount, then declare it a single click&quot;&quot;&quot;</span> <span class="c1"># ClickTrack</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">threshold</span>           <span class="c1"># ClickTrack</span></div>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;ClickTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> coords (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&gt;&quot;</span> <span class="c1"># ClickTrack</span>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span> <span class="k">return</span> <span class="n">escapeHtml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                        <span class="c1"># ClickTrack</span>
<div class="viewcode-block" id="ClickTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># ClickTrack</span>
        <span class="n">xy1</span><span class="p">,</span> <span class="n">xy2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">()</span>                         <span class="c1"># ClickTrack</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mousePressed&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xy1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">xy1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;button&quot;</span><span class="p">:</span> <span class="n">xy1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t1</span><span class="o">*</span><span class="mi">1000</span><span class="p">)},</span> <span class="c1"># ClickTrack</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mouseReleased&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xy2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">xy2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;button&quot;</span><span class="p">:</span> <span class="n">xy2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t2</span><span class="o">*</span><span class="mi">1000</span><span class="p">)}]</span> <span class="c1"># ClickTrack</span></div>
<div class="viewcode-block" id="ClickTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.ClickTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">ClickTrack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">|</span> <span class="n">deref</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">())</span>    <span class="c1"># ClickTrack</span></div></div>
<div class="viewcode-block" id="WheelTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WheelTrack">[docs]</a><span class="k">class</span> <span class="nc">WheelTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span>                                                         <span class="c1"># WheelTrack</span>
<div class="viewcode-block" id="WheelTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WheelTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>                    <span class="c1"># WheelTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing mouse wheel moved event&quot;&quot;&quot;</span>                               <span class="c1"># WheelTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">times</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>                           <span class="c1"># WheelTrack</span></div>
<div class="viewcode-block" id="WheelTrack.parse"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WheelTrack.parse">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># WheelTrack</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;WheelTrack&quot;</span><span class="p">]:</span>                                     <span class="c1"># WheelTrack</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lastTime</span> <span class="o">=</span> <span class="mi">0</span>                                            <span class="c1"># WheelTrack</span>
        <span class="k">for</span> <span class="n">rot</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">events</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouseWheelMoved&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;wheelRotation&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">]):</span> <span class="c1"># WheelTrack</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">lastTime</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">);</span> <span class="n">_d</span> <span class="o">=</span> <span class="p">[]</span>                           <span class="c1"># WheelTrack</span>
            <span class="n">_d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rot</span><span class="p">,</span> <span class="n">t</span><span class="p">]);</span> <span class="n">lastTime</span> <span class="o">=</span> <span class="n">t</span>                                    <span class="c1"># WheelTrack</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_d</span><span class="p">);</span> <span class="k">return</span> <span class="n">d</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">aS</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cut</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">rows</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="o">~</span><span class="n">aS</span><span class="p">(</span><span class="n">WheelTrack</span><span class="p">))</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># WheelTrack</span></div>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;WheelTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> rotations (avg </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;+&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&gt;&quot;</span> <span class="c1"># WheelTrack</span>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span> <span class="k">return</span> <span class="n">escapeHtml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                        <span class="c1"># WheelTrack</span>
<div class="viewcode-block" id="WheelTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WheelTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                            <span class="c1"># WheelTrack</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># WheelTrack</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">rs</span><span class="p">,</span> <span class="n">ts</span><span class="p">]</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rot</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mouseWheelMoved&quot;</span><span class="p">,</span> <span class="s2">&quot;wheelRotation&quot;</span><span class="p">:</span> <span class="n">rot</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">1000</span><span class="p">)})</span> <span class="c1"># WheelTrack</span></div>
<div class="viewcode-block" id="WheelTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.WheelTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">WheelTrack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">())</span>              <span class="c1"># WheelTrack</span></div></div>
<div class="viewcode-block" id="StreamTrack"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack">[docs]</a><span class="k">class</span> <span class="nc">StreamTrack</span><span class="p">(</span><span class="n">Track</span><span class="p">):</span>                                                        <span class="c1"># StreamTrack</span>
<div class="viewcode-block" id="StreamTrack.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>                     <span class="c1"># StreamTrack</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Representing screenshots from the UDP stream&quot;&quot;&quot;</span>                       <span class="c1"># StreamTrack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="n">frames</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># StreamTrack</span></div>
<div class="viewcode-block" id="StreamTrack.parse"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack.parse">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># StreamTrack</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;StreamTrack&quot;</span><span class="p">]:</span>                                    <span class="c1"># StreamTrack</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">events</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>              <span class="c1"># StreamTrack</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>                                           <span class="c1"># StreamTrack</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">StreamTrack</span><span class="p">(</span><span class="o">*</span><span class="n">events</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;frame&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">])</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">))]</span> <span class="c1"># StreamTrack</span></div>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;StreamTrack </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displayTimes</span><span class="p">()</span><span class="si">}</span><span class="s2"> #frames (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) resolution </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># StreamTrack</span>
    <span class="k">def</span> <span class="nf">_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">iden</span><span class="p">()):</span> <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">]</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="n">insertIdColumn</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">f</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="n">n</span><span class="p">))</span> <span class="o">|</span> <span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># StreamTrack</span>
    <span class="k">def</span> <span class="nf">_carousel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">toImg</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">plotImgs</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">Carousel</span><span class="p">)</span> <span class="c1"># StreamTrack</span>
    <span class="k">def</span> <span class="nf">_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>                                                     <span class="c1"># StreamTrack</span>
        <span class="n">metaId</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">metaId</span><span class="p">;</span> <span class="n">streamId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">f</span> <span class="o">=</span> <span class="n">filt</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="o">&lt;</span><span class="n">op</span><span class="p">()</span><span class="o">&lt;</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># StreamTrack</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">toImg</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">HtmlImage</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;width:800px&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">)</span> <span class="c1"># StreamTrack</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">scriptTags</span><span class="p">[</span><span class="n">streamId</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">;</span>
<span class="s2">meta_</span><span class="si">{</span><span class="n">metaId</span><span class="si">}</span><span class="s2">.cbs[</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">] = (x) =&gt; </span><span class="se">{{</span>
<span class="s2">    const stream_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#stream_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    const streamText_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#streamText_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    if (!stream_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">) return;</span>
<span class="s2">    const fT = x/800*</span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis2</span><span class="o">-</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="si">}</span><span class="s2">; // frame time</span>
<span class="s2">    let minT = Infinity; let minIm = null; let minI = null</span>
<span class="s2">    for (const [imE, t, i] of data_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">) </span><span class="se">{{</span>
<span class="s2">        const dT = Math.abs(fT-t);</span>
<span class="s2">        if (dT &lt; minT) </span><span class="se">{{</span><span class="s2"> minIm = imE; minT = dT; minI = i </span><span class="se">}}</span>
<span class="s2">        else break;</span>
<span class="s2">    </span><span class="se">}}</span>
<span class="s2">    stream_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">.innerHTML = minIm;</span>
<span class="s2">    streamText_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">.innerHTML = &quot;frame: &quot; + minI;</span>
<span class="se">}}</span><span class="s2">;&quot;&quot;&quot;</span>                                                                           <span class="c1"># StreamTrack</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">escapeHtml</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span>
<span class="s2">            &lt;div style=&quot;position:relative&quot;&gt;</span>
<span class="s2">                &lt;div id=&quot;stream_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">&quot;&gt;&lt;/div&gt;</span>
<span class="s2">                &lt;div id=&quot;streamText_</span><span class="si">{</span><span class="n">streamId</span><span class="si">}</span><span class="s2">&quot; style=&quot;position:absolute;top:8px;left:12px;padding:4px 8px;background-color:white;border-radius:12px&quot;&gt;&lt;/div&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;&quot;&quot;&quot;</span>                                                                <span class="c1"># StreamTrack</span>
    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">escapeHtml</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2">&lt;div&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_carousel</span><span class="p">()</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span><span class="si">}</span><span class="s2">&lt;/div&gt;&lt;/div&gt;&quot;&quot;&quot;</span> <span class="c1"># StreamTrack</span>
<div class="viewcode-block" id="StreamTrack.events"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack.events">[docs]</a>    <span class="k">def</span> <span class="nf">events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="p">[]</span>                                                  <span class="c1"># StreamTrack</span></div>
<div class="viewcode-block" id="StreamTrack.copy"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">StreamTrack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">))</span> <span class="c1"># StreamTrack</span></div>
<div class="viewcode-block" id="StreamTrack.move"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.StreamTrack.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">+=</span> <span class="n">deltaTime</span><span class="p">;</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">deltaTime</span><span class="p">)</span>  <span class="c1"># StreamTrack</span></div></div>
<span class="k">def</span> <span class="nf">createTrackss</span><span class="p">(</span><span class="n">rec</span><span class="p">:</span><span class="n">Recording</span><span class="p">):</span>                                                <span class="c1"># createTrackss</span>
    <span class="n">dis1</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis1</span><span class="p">;</span> <span class="n">dis2</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis2</span><span class="p">;</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">dis2</span><span class="o">-</span><span class="n">dis1</span> <span class="c1"># nTrack for &quot;new track&quot; # createTrackss</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">iden</span><span class="p">()):</span>                                                       <span class="c1"># createTrackss</span>
        <span class="n">trackss</span> <span class="o">=</span> <span class="p">[]</span>                                                             <span class="c1"># createTrackss</span>
        <span class="k">for</span> <span class="n">nTrack</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">f</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dis1</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="mf">0.01</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">endTime</span><span class="p">,</span> <span class="n">dis2</span><span class="o">-</span><span class="n">delta</span><span class="o">*</span><span class="mf">0.01</span><span class="p">),</span> <span class="n">x</span><span class="p">])</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">&gt;</span><span class="n">dis1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">&lt;</span><span class="n">dis2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">():</span> <span class="c1"># createTrackss</span>
            <span class="n">cTracks</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># &quot;chosen track&quot;                                      # createTrackss</span>
            <span class="k">for</span> <span class="n">eTracks</span> <span class="ow">in</span> <span class="n">trackss</span><span class="p">:</span> <span class="c1"># &quot;existing track&quot;                           # createTrackss</span>
                <span class="k">if</span> <span class="n">eTracks</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nTrack</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">cTracks</span> <span class="o">=</span> <span class="n">eTracks</span><span class="p">;</span> <span class="k">break</span> <span class="c1"># can fit # createTrackss</span>
            <span class="k">if</span> <span class="n">cTracks</span><span class="p">:</span> <span class="n">cTracks</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nTrack</span><span class="p">)</span>                         <span class="c1"># createTrackss</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">trackss</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;tracks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">nTrack</span><span class="p">],</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">nTrack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span> <span class="c1"># createTrackss</span>
        <span class="k">return</span> <span class="n">trackss</span>                                                           <span class="c1"># createTrackss</span>
    <span class="n">trackss</span> <span class="o">=</span> <span class="p">[</span>                                                                  <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">CharTrack</span><span class="p">)),</span>                                         <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">WordTrack</span><span class="p">)),</span>                                         <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">ContourTrack</span><span class="p">)),</span>                                      <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">ClickTrack</span><span class="p">)),</span>                                        <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">WheelTrack</span><span class="p">)),</span>                                        <span class="c1"># createTrackss</span>
        <span class="o">*</span><span class="n">process</span><span class="p">(</span><span class="n">instanceOf</span><span class="p">(</span><span class="n">StreamTrack</span><span class="p">))</span>                                        <span class="c1"># createTrackss</span>
    <span class="p">];</span>                                                                           <span class="c1"># createTrackss</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">trackss</span><span class="p">,</span> <span class="n">rec</span><span class="p">]</span>                                                        <span class="c1"># createTrackss</span>
<span class="n">autoId</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">)))</span>                           <span class="c1"># createTrackss</span>
<span class="k">def</span> <span class="nf">drawTrackss</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>                                                  <span class="c1"># drawTrackss</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">trackHeight</span><span class="p">;</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">pad</span><span class="p">;</span> <span class="n">trackss</span><span class="p">,</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span> <span class="n">sidebarW</span><span class="o">=</span><span class="mi">120</span><span class="p">;</span> <span class="c1"># width # drawTrackss</span>
    <span class="n">infoId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">metaId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">timeId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">timeLId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">sketchId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">();</span> <span class="n">sketchLId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">()</span> <span class="c1"># drawTrackss</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">fromDict</span><span class="p">({</span><span class="s2">&quot;id2Tt&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;dis1&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis1</span><span class="p">,</span> <span class="s2">&quot;dis2&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis2</span><span class="p">,</span> <span class="s2">&quot;metaId&quot;</span><span class="p">:</span> <span class="n">metaId</span><span class="p">,</span> <span class="s2">&quot;scriptTags&quot;</span><span class="p">:</span> <span class="p">{}})</span> <span class="c1"># drawTrackss</span>
                                                                                 <span class="c1"># drawTrackss</span>
    <span class="n">children</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trackss</span><span class="p">)</span> <span class="o">|</span> <span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="n">drawTracks</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span> <span class="o">|</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># drawTrackss</span>
    <span class="n">trackNames</span> <span class="o">=</span> <span class="n">trackss</span> <span class="o">|</span> <span class="n">op</span><span class="p">()[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">insertIdColumn</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;div style=&#39;position:absolute;top:</span><span class="si">{</span><span class="n">pad</span><span class="o">+</span><span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="si">}</span><span class="s2">px;left:12px;height:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">px;text-align:center;line-height:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">px&#39;&gt;&lt;div&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">s&lt;/div&gt;&lt;/div&gt;&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># drawTrackss</span>
    <span class="n">st0</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis1</span> <span class="o">-</span> <span class="n">rec</span><span class="o">.</span><span class="n">startTime</span><span class="p">;</span> <span class="n">et0</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dis2</span> <span class="o">-</span> <span class="n">rec</span><span class="o">.</span><span class="n">startTime</span><span class="p">;</span> <span class="n">ticks0</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span> <span class="n">et0</span><span class="p">)</span> <span class="c1"># 0-based # drawTrackss</span>
    <span class="n">ticksP</span> <span class="o">=</span> <span class="p">(</span><span class="n">ticks0</span><span class="o">+</span><span class="n">rec</span><span class="o">.</span><span class="n">startTime</span><span class="o">-</span><span class="n">rec</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">dis2</span><span class="o">-</span><span class="n">rec</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">*</span><span class="mi">800</span> <span class="c1"># pixel scale # drawTrackss</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticks0</span><span class="p">,</span> <span class="n">ticksP</span><span class="p">]</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">&lt;</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;div style=&#39;position:absolute;width:1px;height:10px;background-color:black;left:</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">px;bottom:4px&#39;&gt;&lt;/div&gt;   &lt;div style=&#39;position:absolute;left:</span><span class="si">{</span><span class="n">y</span><span class="o">-</span><span class="mi">8</span><span class="si">}</span><span class="s2">px;top:0px&#39;&gt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># drawTrackss</span>
    <span class="n">sketchH</span> <span class="o">=</span> <span class="p">(</span><span class="n">pad</span><span class="o">+</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">trackss</span><span class="p">)</span><span class="o">+</span><span class="n">pad</span><span class="p">;</span> <span class="n">extraScripts</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">scriptTags</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="c1"># drawTrackss</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;div style=&quot;display:flex;flex-direction:column;align-items:flex-start&quot;&gt;</span>
<span class="s2">    &lt;div style=&quot;display:flex;flex-direction:row&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;width:</span><span class="si">{</span><span class="n">sidebarW</span><span class="si">}</span><span class="s2">px;padding-right:10px;display:flex;justify-content:center;align-items:center&quot;&gt;&lt;div&gt;Time (s)&lt;/div&gt;&lt;/div&gt;</span>
<span class="s2">        &lt;div id=&quot;time_</span><span class="si">{</span><span class="n">timeId</span><span class="si">}</span><span class="s2">&quot; style=&quot;background-color:red;height:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">px;position:relative;height:34px&quot;&gt;</span>
<span class="s2">            </span><span class="si">{</span><span class="n">ticks</span><span class="si">}</span>
<span class="s2">            &lt;div id=&quot;timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2">&quot; style=&quot;position:absolute;top:0px;background-color:white;border:1px solid black;border-radius:8px;padding:0px 8px&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div style=&quot;display:flex;flex-direction:row&quot;&gt;</span>
<span class="s2">        &lt;div style=&quot;width:</span><span class="si">{</span><span class="n">sidebarW</span><span class="si">}</span><span class="s2">px;padding-right:10px;position:relative&quot;&gt;</span><span class="si">{</span><span class="n">trackNames</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;div id=&quot;sketch_</span><span class="si">{</span><span class="n">sketchId</span><span class="si">}</span><span class="s2">&quot; style=&quot;width:</span><span class="si">{</span><span class="mi">800</span><span class="si">}</span><span class="s2">px;height:</span><span class="si">{</span><span class="n">sketchH</span><span class="si">}</span><span class="s2">px;background-color:grey;position:relative&quot;&gt;</span>
<span class="s2">            &lt;div id=&quot;sketchL_</span><span class="si">{</span><span class="n">sketchLId</span><span class="si">}</span><span class="s2">&quot; style=&quot;position:absolute;width:1px;height:</span><span class="si">{</span><span class="n">sketchH</span><span class="si">}</span><span class="s2">px;background-color:black;top:0px&quot;&gt;&lt;/div&gt;</span>
<span class="s2">            </span><span class="si">{</span><span class="n">children</span><span class="si">}</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;div id=&quot;info_</span><span class="si">{</span><span class="n">infoId</span><span class="si">}</span><span class="s2">&quot; style=&quot;min-height:30px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;padding:4px 12px&quot;&gt;&lt;/div&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;script&gt;</span>
<span class="s2">    id2Tt = </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">id2Tt</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">aS</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">)</span><span class="si">}</span>
<span class="s2">    info_</span><span class="si">{</span><span class="n">infoId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#info_</span><span class="si">{</span><span class="n">infoId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    time_</span><span class="si">{</span><span class="n">timeId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#time_</span><span class="si">{</span><span class="n">timeId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    sketch_</span><span class="si">{</span><span class="n">sketchId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#sketch_</span><span class="si">{</span><span class="n">sketchId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    sketchL_</span><span class="si">{</span><span class="n">sketchLId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#sketchL_</span><span class="si">{</span><span class="n">sketchLId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2"> = document.querySelector(&quot;#timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2">&quot;);</span>
<span class="s2">    meta_</span><span class="si">{</span><span class="n">metaId</span><span class="si">}</span><span class="s2"> = </span><span class="se">{{</span><span class="s2">x: 0, y: 0, cbs: </span><span class="se">{{}}}}</span><span class="s2">;</span>
<span class="s2">    for (const [k, v] of Object.entries(id2Tt)) </span><span class="se">{{</span>
<span class="s2">        let elem = document.querySelector(`#track_$</span><span class="se">{{</span><span class="s2">k</span><span class="se">}}</span><span class="s2">`);</span>
<span class="s2">        elem.onmouseover = () =&gt; </span><span class="se">{{</span><span class="s2">info_</span><span class="si">{</span><span class="n">infoId</span><span class="si">}</span><span class="s2">.innerHTML = atob(v[0]);elem.style.backgroundColor = &quot;red&quot;;</span><span class="se">}}</span><span class="s2">;</span>
<span class="s2">        elem.onmouseout  = () =&gt; </span><span class="se">{{</span><span class="s2">info_</span><span class="si">{</span><span class="n">infoId</span><span class="si">}</span><span class="s2">.innerHTML = &quot;&quot;;        elem.style.backgroundColor = &quot;white&quot;;</span><span class="se">}}</span><span class="s2">;</span>
<span class="s2">    </span><span class="se">}}</span>
<span class="s2">    sketch_</span><span class="si">{</span><span class="n">sketchId</span><span class="si">}</span><span class="s2">.onmousemove = (event) =&gt; </span><span class="se">{{</span>
<span class="s2">        const x = event.pageX-sketch_</span><span class="si">{</span><span class="n">sketchId</span><span class="si">}</span><span class="s2">.getBoundingClientRect().x;</span>
<span class="s2">        meta_</span><span class="si">{</span><span class="n">metaId</span><span class="si">}</span><span class="s2">.x = x;</span>
<span class="s2">        sketchL_</span><span class="si">{</span><span class="n">sketchLId</span><span class="si">}</span><span class="s2">.style.left = x + &quot;px&quot;;</span>
<span class="s2">        timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2">.style.left = (x-timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2">.getBoundingClientRect().width/2) + &quot;px&quot;;</span>
<span class="s2">        timeL_</span><span class="si">{</span><span class="n">timeLId</span><span class="si">}</span><span class="s2">.innerHTML = Number(x/800*</span><span class="si">{</span><span class="n">et0</span><span class="o">-</span><span class="n">st0</span><span class="si">}</span><span class="s2">+</span><span class="si">{</span><span class="n">st0</span><span class="si">}</span><span class="s2">).toFixed(2) + &quot;s&quot;;</span>
<span class="s2">        for (const cb of Object.values(meta_</span><span class="si">{</span><span class="n">metaId</span><span class="si">}</span><span class="s2">.cbs)) cb(x);</span>
<span class="s2">    </span><span class="se">}}</span>
<span class="s2">    </span><span class="si">{</span><span class="n">extraScripts</span><span class="si">}</span>
<span class="s2">&lt;/script&gt;&quot;&quot;&quot;</span>                                                                     <span class="c1"># drawTrackss</span>
<span class="k">def</span> <span class="nf">drawTracks</span><span class="p">(</span><span class="n">tracks</span><span class="p">,</span> <span class="n">rowId</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">tracks</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">drawTrack</span><span class="p">,</span> <span class="n">rowId</span><span class="o">=</span><span class="n">rowId</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span> <span class="o">|</span> <span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># drawTracks</span>
<span class="k">def</span> <span class="nf">drawTrack</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">rowId</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>                                      <span class="c1"># drawTrack</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">trackHeight</span><span class="p">;</span> <span class="n">pad</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">pad</span><span class="p">;</span> <span class="n">st</span><span class="p">,</span> <span class="n">et</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">track</span>  <span class="c1"># drawTrack</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">-</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis2</span><span class="o">-</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">*</span><span class="mi">800</span><span class="p">;</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">et</span><span class="o">-</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis2</span><span class="o">-</span><span class="n">ctx</span><span class="o">.</span><span class="n">dis1</span><span class="p">)</span><span class="o">*</span><span class="mi">800</span> <span class="c1"># drawTrack</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">rowId</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="n">pad</span><span class="p">)</span><span class="o">+</span><span class="n">pad</span><span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">;</span> <span class="n">trackId</span> <span class="o">=</span> <span class="n">autoId</span><span class="p">()</span>                         <span class="c1"># drawTrack</span>
    <span class="n">tooltip</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_tooltip</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">)</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>  <span class="c1"># drawTrack</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">id2Tt</span><span class="p">[</span><span class="n">trackId</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tooltip</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>                                    <span class="c1"># drawTrack</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;div id=&quot;track_</span><span class="si">{</span><span class="n">trackId</span><span class="si">}</span><span class="s2">&quot; style=&quot;top:</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">px;left:</span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2">px;width:</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">px;height:</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">px;background-color:white;position:absolute&quot;&gt;&lt;/div&gt;&quot;&quot;&quot;</span> <span class="c1"># drawTrack</span>
<span class="n">basePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getabsfile</span><span class="p">(</span><span class="n">k1lib</span><span class="p">))</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s2">&quot;k1ui&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="c1"># drawTrack</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                                                <span class="c1"># drawTrack</span>
<span class="k">def</span> <span class="nf">sampleEvents</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>                                                <span class="c1"># sampleEvents</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grabs the built-in example events. Results will be really long,</span>
<span class="sd">so beware, as it can crash your notebook if you try to display it.&quot;&quot;&quot;</span>            <span class="c1"># sampleEvents</span>
    <span class="n">mouseE</span><span class="p">,</span> <span class="n">keyE</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basePath</span><span class="si">}</span><span class="s2">mouseKey.pth&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>        <span class="c1"># sampleEvents</span>
    <span class="n">deltaT</span> <span class="o">=</span> <span class="n">keyE</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mouseE</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>                   <span class="c1"># sampleEvents</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">mouseE</span><span class="p">()</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">deltaT</span><span class="p">}),</span> <span class="o">*</span><span class="n">keyE</span><span class="p">()]</span> <span class="c1"># sampleEvents</span>
    <span class="k">try</span><span class="p">:</span> <span class="c1"># local comp has the k1ui-screen file, but it will not be bundled with the library, cause it&#39;s like 80MB! # sampleEvents</span>
        <span class="n">screenE</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="s2">&quot;screen.pth&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>                      <span class="c1"># sampleEvents</span>
        <span class="n">deltaT</span> <span class="o">=</span> <span class="n">keyE</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">screenE</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>              <span class="c1"># sampleEvents</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">screenE</span><span class="p">()</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">deltaT</span><span class="p">}),</span> <span class="o">*</span><span class="n">ev</span><span class="p">]</span> <span class="c1"># sampleEvents</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="n">ev</span>                                                            <span class="c1"># sampleEvents</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">,</span> <span class="n">static</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                                                <span class="c1"># sampleEvents</span>
<span class="k">def</span> <span class="nf">sample</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>                                                       <span class="c1"># sample</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a Recording from :meth:`sampleEvents`&quot;&quot;&quot;</span>                          <span class="c1"># sample</span>
    <span class="k">return</span> <span class="n">Recording</span><span class="p">(</span><span class="n">Recording</span><span class="o">.</span><span class="n">sampleEvents</span><span class="p">())</span>                                   <span class="c1"># sample</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">ContourTrack</span><span class="p">)</span>                                                          <span class="c1"># sample</span>
<span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>                                              <span class="c1"># split</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits this contour track by multiple timestamps relative</span>
<span class="sd">to recording&#39;s start time. Example::</span>

<span class="sd">    r = k1ui.Recording.sample()</span>
<span class="sd">    r.sel1(klass=k1ui.ContourTrack).split([5])&quot;&quot;&quot;</span>                                <span class="c1"># split</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">cps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="n">rec</span><span class="o">.</span><span class="n">startTime</span> <span class="c1"># split</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                                  <span class="c1"># split</span>
        <span class="k">if</span> <span class="n">cps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span> <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>                                               <span class="c1"># split</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># split</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">y</span><span class="p">])</span>                                           <span class="c1"># split</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>                                                        <span class="c1"># split</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">):</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">y</span><span class="p">]);</span> <span class="k">break</span>                                  <span class="c1"># split</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cps</span><span class="p">):</span> <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">:]);</span> <span class="k">break</span>                                 <span class="c1"># split</span>
    <span class="n">rec</span><span class="o">.</span><span class="n">removeTracks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                                                       <span class="c1"># split</span>
    <span class="n">rec</span><span class="o">.</span><span class="n">addTracks</span><span class="p">(</span><span class="n">d</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">ContourTrack</span><span class="p">))</span>                                       <span class="c1"># split</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">ContourTrack</span><span class="p">)</span>                                                          <span class="c1"># split</span>
<span class="k">def</span> <span class="nf">splitClick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clickTracks</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;ClickTrack&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                       <span class="c1"># splitClick</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits this contour track by click events. Essentially, the click</span>
<span class="sd">events chops this contour into multiple segments. Example::</span>

<span class="sd">    r = k1ui.Recording.sample()</span>
<span class="sd">    r.sel1(klass=k1ui.ContourTrack).splitClick()</span>

<span class="sd">:param clickTracks: if not specified, use all ClickTracks from the recording&quot;&quot;&quot;</span>  <span class="c1"># splitClick</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># splitClick</span>
    <span class="k">if</span> <span class="n">clickTracks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">clickTracks</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time0Rec</span><span class="p">())</span> <span class="o">|</span> <span class="n">instanceOf</span><span class="p">(</span><span class="n">ClickTrack</span><span class="p">)</span> <span class="c1"># splitClick</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">clickTracks</span> <span class="o">|</span> <span class="o">~</span><span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">isClick</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">timeUnix</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">sort</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">-</span><span class="n">rec</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">())</span> <span class="c1"># splitClick</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">)</span>                                                             <span class="c1"># splitClick</span>
<span class="k">def</span> <span class="nf">addTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>                         <span class="c1"># addTime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inserts a specific duration into a specific point in time.</span>
<span class="sd">More clearly, this transfroms this::</span>

<span class="sd">    # |-1--|   |-2-|</span>
<span class="sd">    #    |---3---|</span>
<span class="sd">    #         ^ insert duration=3 here</span>

<span class="sd">Into this::</span>

<span class="sd">    # |-1--|      |-2-|</span>
<span class="sd">    #    |---3------|</span>

<span class="sd">Tracks that partly overlaps with the range will have their start/end times</span>
<span class="sd">modified, and potentially delete some of the Track&#39;s internal data:</span>

<span class="sd">- Tracks whose only start and end times are modified: Char, Word, Click, Wheel</span>
<span class="sd">- Tracks whose internal data are also modified: Contour, Stream</span>

<span class="sd">:param t: where to insert the duration, relative to Recording&#39;s start time</span>
<span class="sd">:param duration: how long (in seconds) to insert?&quot;&quot;&quot;</span>                             <span class="c1"># addTime</span>
    <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="p">);</span> <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c1"># tracks at or after the specified time # addTime</span>
    <span class="n">unix</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>                                                    <span class="c1"># addTime</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">at</span><span class="p">:</span> <span class="n">after</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>                                         <span class="c1"># addTime</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">at</span><span class="p">:</span>                                                             <span class="c1"># addTime</span>
        <span class="n">track</span><span class="o">.</span><span class="n">endTime</span> <span class="o">+=</span> <span class="n">duration</span>                                                <span class="c1"># addTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">ContourTrack</span><span class="p">):</span>                                      <span class="c1"># addTime</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">unix</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">();</span> <span class="n">track</span><span class="o">.</span><span class="n">_cachedImg</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># addTime</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">unix</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">duration</span> <span class="c1"># index is valid           # addTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">StreamTrack</span><span class="p">):</span>                                       <span class="c1"># addTime</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span><span class="p">;</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">unix</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>                           <span class="c1"># addTime</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>   <span class="o">&gt;</span> <span class="n">unix</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>   <span class="o">+=</span> <span class="n">duration</span> <span class="c1"># index is valid           # addTime</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span>                                                          <span class="c1"># addTime</span>
        <span class="n">track</span><span class="o">.</span><span class="n">startTime</span> <span class="o">+=</span> <span class="n">duration</span><span class="p">;</span> <span class="n">track</span><span class="o">.</span><span class="n">endTime</span> <span class="o">+=</span> <span class="n">duration</span>                   <span class="c1"># addTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">ContourTrack</span><span class="p">):</span> <span class="n">track</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">duration</span>          <span class="c1"># addTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">StreamTrack</span><span class="p">):</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span> <span class="o">+=</span> <span class="n">duration</span>               <span class="c1"># addTime</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">+=</span> <span class="n">duration</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span>                      <span class="c1"># addTime</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">)</span>                                                             <span class="c1"># addTime</span>
<span class="k">def</span> <span class="nf">removeTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>                           <span class="c1"># removeTime</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deletes time from t1 to t2 (relative to Recording&#39;s start time).</span>
<span class="sd">All tracks lying completely inside this range will be deleted. More</span>
<span class="sd">clearly, it transforms this::</span>

<span class="sd">    # |-1--|  |-2-|   |-3-|</span>
<span class="sd">    #    |---4---|  |-5-|</span>
<span class="sd">    #        ^       ^ delete between these carets</span>

<span class="sd">Into this::</span>

<span class="sd">    # |-1--|   |-3-|</span>
<span class="sd">    #    |-4-||5-|</span>

<span class="sd">Tracks that partly overlaps with the range will have their start/end times</span>
<span class="sd">modified, and potentially delete some of the Track&#39;s internal data:</span>

<span class="sd">- Tracks whose only start and end times are modified: Char, Word, Click, Wheel</span>
<span class="sd">- Tracks whose internal data are also modified: Contour, Stream&quot;&quot;&quot;</span>               <span class="c1"># removeTime</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">;</span> <span class="n">t1U</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">;</span> <span class="n">t2U</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span>     <span class="c1"># removeTime</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">removeTracks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span> <span class="o">&gt;=</span> <span class="n">t1U</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">endTime</span> <span class="o">&lt;</span> <span class="n">t2U</span><span class="p">))</span> <span class="c1"># removing everything that&#39;s completely inside # removeTime</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">);</span> <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span> <span class="o">&gt;=</span> <span class="n">t2U</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># removeTime</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">overlap</span><span class="p">:</span> <span class="c1"># handling left overhang                               # removeTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">ContourTrack</span><span class="p">):</span>                                      <span class="c1"># removeTime</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">idx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t1U</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">();</span> <span class="n">idx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t2U</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span> <span class="c1"># removeTime</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">idx2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t2U</span><span class="p">:</span> <span class="n">idx2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                                   <span class="c1"># removeTime</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:</span><span class="n">idx1</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">idx2</span><span class="p">:];</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">duration</span>                       <span class="c1"># removeTime</span>
            <span class="n">track</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]);</span> <span class="n">track</span><span class="o">.</span><span class="n">_cachedImg</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># removeTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">StreamTrack</span><span class="p">):</span>                                       <span class="c1"># removeTime</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span><span class="p">;</span> <span class="n">idx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">t1U</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">();</span> <span class="n">idx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">t2U</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span> <span class="c1"># removeTime</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t2U</span><span class="p">:</span> <span class="n">idx2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1"># special case if idx2 is not valid # removeTime</span>
            <span class="n">track</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">track</span><span class="o">.</span><span class="n">times</span><span class="p">[:</span><span class="n">idx1</span><span class="p">],</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">idx2</span><span class="p">:]</span><span class="o">-</span><span class="n">duration</span><span class="p">])</span> <span class="c1"># removeTime</span>
            <span class="n">track</span><span class="o">.</span><span class="n">frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">track</span><span class="o">.</span><span class="n">frames</span><span class="p">[:</span><span class="n">idx1</span><span class="p">],</span> <span class="n">track</span><span class="o">.</span><span class="n">frames</span><span class="p">[</span><span class="n">idx2</span><span class="p">:]])</span> <span class="c1"># removeTime</span>
        <span class="n">track</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1U</span><span class="p">,</span> <span class="n">track</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">duration</span><span class="p">);</span> <span class="n">track</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1U</span><span class="p">,</span> <span class="n">track</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="c1"># removeTime</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">after</span><span class="p">:</span>                                                          <span class="c1"># removeTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">ContourTrack</span><span class="p">):</span> <span class="n">track</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">duration</span>        <span class="c1"># removeTime</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">track</span><span class="p">,</span> <span class="n">StreamTrack</span><span class="p">):</span> <span class="n">track</span><span class="o">.</span><span class="n">times</span> <span class="o">-=</span> <span class="n">duration</span>               <span class="c1"># removeTime</span>
        <span class="n">track</span><span class="o">.</span><span class="n">startTime</span> <span class="o">-=</span> <span class="n">duration</span><span class="p">;</span> <span class="n">track</span><span class="o">.</span><span class="n">endTime</span> <span class="o">-=</span> <span class="n">duration</span>                   <span class="c1"># removeTime</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resetTimes</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resetDis</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span>                            <span class="c1"># removeTime</span>
<span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">):</span>                                                           <span class="c1"># _move</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">e2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">dot</span> <span class="o">=</span> <span class="n">e1</span><span class="nd">@e2</span><span class="p">;</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">dot</span><span class="p">)</span>   <span class="c1"># _move</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span> <span class="n">c</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]])</span>  <span class="c1"># _move</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mf">0.5</span><span class="o">/</span><span class="p">(</span><span class="n">e1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mf">0.5</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span><span class="n">rot</span> <span class="o">@</span> <span class="n">cs</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">scale</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span> <span class="c1"># _move</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">ContourTrack</span><span class="p">)</span>                                                          <span class="c1"># _move</span>
<span class="k">def</span> <span class="nf">movePoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                           <span class="c1"># movePoint</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Move contour&#39;s start/end to another location, smoothly scaling all</span>
<span class="sd">intermediary points along.</span>

<span class="sd">:param start: if True, move the start point, else move the end point&quot;&quot;&quot;</span>          <span class="c1"># movePoint</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">;</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>                                       <span class="c1"># movePoint</span>
    <span class="k">if</span> <span class="n">start</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="mi">2</span><span class="p">];</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span>                                     <span class="c1"># movePoint</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">2</span><span class="p">];</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">s</span>                                         <span class="c1"># movePoint</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span> <span class="n">c</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">_move</span><span class="p">(</span><span class="n">c</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span><span class="o">+</span><span class="n">s</span>                            <span class="c1"># movePoint</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Track</span><span class="p">)</span>                                                                 <span class="c1"># movePoint</span>
<span class="k">def</span> <span class="nf">nextTrack</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Track</span><span class="p">:</span>                                                    <span class="c1"># nextTrack</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grabs the next track (ordered by start time) in the recording&quot;&quot;&quot;</span>          <span class="c1"># nextTrack</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="o">.</span><span class="n">_tracks</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="n">sortF</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span><span class="p">)</span> <span class="o">|</span> <span class="n">item</span><span class="p">()</span> <span class="c1"># nextTrack</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Recording</span><span class="p">)</span>                                                             <span class="c1"># nextTrack</span>
<span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Recording</span><span class="p">:</span>                        <span class="c1"># refine</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform sensible default operations to refine the Recording.</span>
<span class="sd">This currently includes:</span>

<span class="sd">- (0) Splitting ContourTracks into multiple smaller tracks using click events</span>
<span class="sd">- (1) Forming words from nearby CharTracks</span>
<span class="sd">- (2) Removing open-close CharTracks. Basically, CharTracks that don&#39;t have a begin or end time</span>

<span class="sd">:param enabled: list of integers, whether to turn on or off certain features. 1 to turn on, 0 to turn off&quot;&quot;&quot;</span> <span class="c1"># refine</span>
    <span class="k">if</span> <span class="n">enabled</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">formWords</span><span class="p">()</span>                                              <span class="c1"># refine</span>
    <span class="k">if</span> <span class="n">enabled</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">ContourTrack</span><span class="p">)</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">splitClick</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">()</span> <span class="c1"># refine</span>
    <span class="k">if</span> <span class="n">enabled</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeTracks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">CharTrack</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">startTime</span><span class="p">))</span> <span class="c1"># refine</span>
    <span class="k">return</span> <span class="bp">self</span>                                                                  <span class="c1"># refine</span>
<span class="k">def</span> <span class="nf">convBlock</span><span class="p">(</span><span class="n">inC</span><span class="p">,</span> <span class="n">outC</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>                         <span class="c1"># convBlock</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">inC</span><span class="p">,</span> <span class="n">outC</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">outC</span><span class="p">))</span> <span class="c1"># convBlock</span>
<span class="k">if</span> <span class="n">hasTorch</span><span class="p">:</span>                                                                     <span class="c1"># convBlock</span>
    <span class="k">class</span> <span class="nc">skipBlock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>                                            <span class="c1"># convBlock</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inC</span><span class="p">):</span>                                                 <span class="c1"># convBlock</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">convBlock</span><span class="p">(</span><span class="n">inC</span><span class="p">,</span> <span class="n">inC</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">convBlock</span><span class="p">(</span><span class="n">inC</span><span class="p">,</span> <span class="n">inC</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>                                   <span class="c1"># convBlock</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">((</span><span class="n">x</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span>         <span class="c1"># convBlock</span>
    <span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>                                                  <span class="c1"># convBlock</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skips</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>                                         <span class="c1"># convBlock</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>                                                   <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skips</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">convBlock</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="o">*</span><span class="p">[</span><span class="n">skipBlock</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skips</span><span class="p">)])</span> <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avgPool</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin1</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">LinBlock</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">skips</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lin2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distThreshold</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">));</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span> <span class="c1"># convBlock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headOnly</span> <span class="o">=</span> <span class="kc">True</span>                                                 <span class="c1"># convBlock</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>                                                    <span class="c1"># convBlock</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">skips</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgPool</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin1</span>       <span class="c1"># convBlock</span>
            <span class="k">return</span> <span class="n">x</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headOnly</span> <span class="k">else</span> <span class="n">x</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin2</span>                         <span class="c1"># convBlock</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>                           <span class="c1"># convBlock</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">distThreshold</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span>              <span class="c1"># convBlock</span>
            <span class="k">return</span> <span class="n">x</span>                                                             <span class="c1"># convBlock</span>
<div class="viewcode-block" id="distNet"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.distNet">[docs]</a><span class="k">def</span> <span class="nf">distNet</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;torch.nn.Module&quot;</span><span class="p">:</span>                                              <span class="c1"># distNet</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grabs a pretrained network that might be useful in distinguishing</span>
<span class="sd">between screens. Example::</span>

<span class="sd">    net = k1ui.distNet()</span>
<span class="sd">    net(torch.randn(16, 3, 192, 192)) # returns tensor of shape (16, 10)&quot;&quot;&quot;</span>      <span class="c1"># distNet</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">();</span> <span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">basePath</span><span class="si">}</span><span class="s2">256.model.state_dict.pth&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">dill</span><span class="o">.</span><span class="n">loads</span><span class="p">))</span> <span class="c1"># distNet</span>
    <span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">();</span> <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span> <span class="k">return</span> <span class="n">net</span> <span class="c1"># distNet</span></div>
<span class="k">def</span> <span class="nf">discardTransients</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">countThres</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">regular</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># consistent for 7 consecutive frames, then output the results # discardTransients</span>
    <span class="n">lastRow</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">lastE</span> <span class="o">=</span> <span class="kc">None</span>                                                 <span class="c1"># discardTransients</span>
    <span class="n">yielded</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>                                                   <span class="c1"># discardTransients</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>                                                               <span class="c1"># discardTransients</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span> <span class="k">else</span> <span class="n">row</span>                                             <span class="c1"># discardTransients</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="n">lastE</span><span class="p">:</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>                                                <span class="c1"># discardTransients</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lastE</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span> <span class="n">lastRow</span> <span class="o">=</span> <span class="n">row</span><span class="p">;</span> <span class="n">yielded</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># discardTransients</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">countThres</span><span class="o">-</span><span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">yielded</span><span class="p">:</span> <span class="n">yielded</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="k">yield</span> <span class="n">lastRow</span>   <span class="c1"># discardTransients</span>
        <span class="k">elif</span> <span class="n">regular</span><span class="p">:</span> <span class="k">yield</span> <span class="kc">None</span>                                                 <span class="c1"># discardTransients</span>
<span class="k">class</span> <span class="nc">Buffer</span><span class="p">:</span>                                                                    <span class="c1"># Buffer</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>                                         <span class="c1"># Buffer</span>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                                        <span class="c1"># Buffer</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>                                  <span class="c1"># Buffer</span>
<span class="k">if</span> <span class="n">hasTorch</span> <span class="ow">and</span> <span class="n">hasTv</span><span class="p">:</span>                                                           <span class="c1"># Buffer</span>
    <span class="n">np2Tensor</span> <span class="o">=</span> <span class="n">toImg</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">]))</span> <span class="o">|</span> <span class="n">toTensor</span><span class="p">()</span>                 <span class="c1"># Buffer</span>
    <span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>                                                        <span class="c1"># Buffer</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nClasses</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                                  <span class="c1"># Buffer</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">LinBlock</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">nClasses</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">nClasses</span><span class="p">,</span> <span class="n">nClasses</span><span class="p">)</span> <span class="c1"># Buffer</span>
        <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xb</span><span class="p">):</span> <span class="k">return</span> <span class="n">xb</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>                     <span class="c1"># Buffer</span>
<span class="n">whatever</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>                                                              <span class="c1"># Buffer</span>
<div class="viewcode-block" id="TrainScreen"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen">[docs]</a><span class="k">class</span> <span class="nc">TrainScreen</span><span class="p">:</span>                                                               <span class="c1"># TrainScreen</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>                                                  <span class="c1"># TrainScreen</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Core dataset of TrainScreen. Essentially just a list of (frameId, screen name)&quot;&quot;&quot;</span> <span class="c1"># TrainScreen</span>
<div class="viewcode-block" id="TrainScreen.__init__"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span><span class="n">Recording</span><span class="p">):</span>                                             <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a screen training system that will train a small neural network</span>
<span class="sd">to recognize different screens using a small amount of feedback from the user.</span>
<span class="sd">Overview on how it&#39;s supposed to look like:</span>

<span class="sd">Setting up::</span>

<span class="sd">    r = k1ui.Recording(await k1ui.record(30)) # record everything for 30 seconds, and creates a recording out of it</span>
<span class="sd">    ts = k1ui.TrainScreen(r) # creates the TrainScreen object</span>
<span class="sd">    r # run this in a cell to display the recording, including StreamTrack</span>
<span class="sd">    ts.addRule(&quot;home&quot;, &quot;settings&quot;, &quot;home&quot;) # add expected screen transition dynamics (home -&gt; settings -&gt; home)</span>

<span class="sd">Training with user&#39;s feedback::</span>

<span class="sd">    ts.registerFrames({&quot;home&quot;: [100, 590, 4000, 4503], &quot;settings&quot;: [1200, 2438]}) # label some frames of the recording. Network will train for ~6 seconds</span>
<span class="sd">    next(ts) # display 20 images that confuses the network the most</span>
<span class="sd">    ts.register({&quot;home&quot;: [2, 6], &quot;settings&quot;: [1, 16]}) # label some frames from the last line. Notice the frame numbers are much smaller and are &lt;20</span>
<span class="sd">    next(ts); ts.register({}); next(ts); ts.register({}) # repeat the last 2 lines for a few times (3-5 times is probably good enough for ~7 screens)</span>

<span class="sd">Evaluating the performance::</span>

<span class="sd">    ts.graphs() # displays 2 graphs: network&#39;s prediction graph and the actual rule graph. Best way to judge performance</span>
<span class="sd">    ts.l.Accuracy.plot() # actual accuracy metric while training. Network could have bad accuracy here while still able to construct a perfect graph, so don&#39;t rely much on this</span>

<span class="sd">Using the model::</span>

<span class="sd">    ts.predict(torch.randn(2, 3, 192, 192) | k1ui.distNet()) # returns list of ints. Can use ts.idx2Name dict to convert to screen names</span>

<span class="sd">Saving the model::</span>

<span class="sd">    ts | aS(dill.dumps) | file(&quot;ts.pth&quot;)</span>

<span class="sd">.. warning::</span>

<span class="sd">    This won&#39;t actually save the associated recording, because recordings are</span>
<span class="sd">    very heavy objects (several GB). It is expected that you manually manage</span>
<span class="sd">    the lifecycle of the recording.&quot;&quot;&quot;</span>                                           <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1"># [(frame id, screen name)]                  # TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aspect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">|</span> <span class="n">item</span><span class="p">()</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="o">~</span><span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="o">/</span><span class="n">x</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distNet</span> <span class="o">=</span> <span class="n">distNet</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainParams</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;joinAlpha&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span> <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lastScreenName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screenDump</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screenTransients</span> <span class="o">=</span> <span class="n">discardTransients</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screenDump</span><span class="p">,</span> <span class="n">regular</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># TrainScreen</span></div>
    <span class="nd">@property</span>                                                                    <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">_coldStart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1"># whether there are any data at all to work with # TrainScreen</span>
    <span class="k">def</span> <span class="nf">_coldGuard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                        <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coldStart</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TrainScreen has not started yet. Run `next(ts)`, choose a few frames using `ts.register()` to access this functionality&quot;</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">_learner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coldGuard</span><span class="p">();</span> <span class="n">l</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">Learner</span><span class="p">();</span> <span class="n">l</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataF</span><span class="p">()</span>              <span class="c1"># TrainScreen</span>
        <span class="n">l</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name2Idx</span><span class="p">))</span>                                        <span class="c1"># TrainScreen</span>
        <span class="n">l</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distNet</span><span class="o">.</span><span class="n">parameters</span><span class="p">()]</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">3e-3</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
        <span class="n">l</span><span class="o">.</span><span class="n">cbs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Cbs</span><span class="o">.</span><span class="n">LossCrossEntropy</span><span class="p">());</span> <span class="n">l</span><span class="o">.</span><span class="n">css</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>                        <span class="c1"># TrainScreen</span>
        <span class="n">l</span><span class="o">.</span><span class="n">ConfusionMatrix</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="n">deref</span><span class="p">()(</span><span class="bp">self</span><span class="o">.</span><span class="n">name2Idx</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">|</span> <span class="n">sort</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="n">l</span><span class="o">.</span><span class="n">cbs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;AccuracyTop5&quot;</span><span class="p">,</span> <span class="s2">&quot;AccF0&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="n">l</span>                          <span class="c1"># TrainScreen</span>
<div class="viewcode-block" id="TrainScreen.train"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                               <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trains the network for a while (300 epochs/6 seconds). Will be called</span>
<span class="sd">automatically when you register new frames to the system</span>

<span class="sd">:param restart: whether to restart the small network or not&quot;&quot;&quot;</span>                   <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">restart</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learner</span><span class="p">();</span>                                    <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trainParams</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">])</span>                                  <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.trainParams"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.trainParams">[docs]</a>    <span class="k">def</span> <span class="nf">trainParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joinAlpha</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epochs</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets training parameters.</span>

<span class="sd">:param joinAlpha: (default 0) alpha used in joinStreamsRandom component for each</span>
<span class="sd">    screen categories. Read more at :class:`~k1lib.cli.structural.joinStreamsRandom`</span>
<span class="sd">:param epochs: (default 300) number of epochs for each training session&quot;&quot;&quot;</span>       <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">joinAlpha</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainParams</span><span class="p">[</span><span class="s2">&quot;joinAlpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">joinAlpha</span>                 <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">epochs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainParams</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epochs</span>                          <span class="c1"># TrainScreen</span></div>
    <span class="nd">@property</span>                                                                    <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">frames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>                                              <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grab the frames from the first :class:`StreamTrack` from the :class:`Recording`&quot;&quot;&quot;</span> <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">sel1</span><span class="p">(</span><span class="n">klass</span><span class="o">=</span><span class="n">StreamTrack</span><span class="p">)</span><span class="o">.</span><span class="n">frames</span>                             <span class="c1"># TrainScreen</span>
    <span class="nd">@property</span>                                                                    <span class="c1"># TrainScreen</span>
    <span class="nd">@lru_cache</span>                                                                   <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">feats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>                                         <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the feature array of shape (N, 10) by passing the frames</span>
<span class="sd">through :meth:`distNet`. This returns a list of arrays, not a giant,</span>
<span class="sd">stacked array for memory performance&quot;&quot;&quot;</span>                                          <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coldGuard</span><span class="p">();</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting all frames to features using `distNet`...&quot;</span><span class="p">);</span> <span class="n">a</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames</span> <span class="o">|</span> <span class="n">tee</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">crt</span><span class="p">()</span> <span class="o">|</span> <span class="n">np2Tensor</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distNet</span><span class="p">))</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
        <span class="nb">print</span><span class="p">();</span> <span class="k">return</span> <span class="n">res</span>                                                      <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span>                                   <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">_randomConsidering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">|</span> <span class="n">splitW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span> <span class="o">|</span> <span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PIL.Image.Image&quot;</span><span class="p">:</span> <span class="c1"># show frames                       # TrainScreen</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coldStart</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_considering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_randomConsidering</span><span class="p">()</span>        <span class="c1"># TrainScreen</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># TrainScreen</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionScreens</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">randomize</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_randomConsidering</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">iter</span><span class="p">);</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_midBoundaryConsidering</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">iter</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_considering</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">wrapList</span><span class="p">()</span> <span class="o">|</span> <span class="n">insert</span><span class="p">(</span><span class="n">yieldT</span> <span class="o">|</span> <span class="n">repeat</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">randomize</span><span class="p">())</span> <span class="o">|</span> <span class="n">joinStreamsRandom</span><span class="p">()</span> <span class="o">|</span> <span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_considering</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">)</span> <span class="o">|</span> <span class="n">insertIdColumn</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="n">plotImgs</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aspect</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">_refreshIdx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx2Name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name2Idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span> <span class="o">|</span> <span class="n">insertIdColumn</span><span class="p">()</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">toDict</span><span class="p">())</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
<div class="viewcode-block" id="TrainScreen.register"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>                                                       <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tells the object which images previously displayed by :meth:`__next__`</span>
<span class="sd">associate with what screen name. Example::</span>

<span class="sd">    next(ts) # displays the images out to a notebook cell</span>
<span class="sd">    ts.register({&quot;home&quot;: [3, 4, 7], &quot;settings&quot;: [5, 19, 2], &quot;monkeys&quot;: [15, 11], &quot;guns&quot;: []})</span>

<span class="sd">This will also quickly (around 6 seconds) train a small neural network on all</span>
<span class="sd">available frames based on the new information you provided.</span>

<span class="sd">See also: :meth:`registerFrames`&quot;&quot;&quot;</span>                                              <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deref</span><span class="p">()(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">repeat</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_considering</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">unique</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refreshIdx</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>                                         <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.registerFrames"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.registerFrames">[docs]</a>    <span class="k">def</span> <span class="nf">registerFrames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>                         <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tells the object which frames should have which labels.</span>
<span class="sd">Example::</span>

<span class="sd">    ts.registerFrames({&quot;home&quot;: [328, 609], &quot;settings&quot;: [12029], &quot;monkeys&quot;: [1238]})</span>

<span class="sd">This differs from :meth:`register` in that the frame id here is the</span>
<span class="sd">absolute frame index in the recording, while in :meth:`register`,</span>
<span class="sd">it&#39;s the frame displayed by :meth:`__next__`.&quot;&quot;&quot;</span>                                 <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">deref</span><span class="p">()(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">repeat</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">unique</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refreshIdx</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">()</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.addRule"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.addRule">[docs]</a>    <span class="k">def</span> <span class="nf">addRule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">screenNames</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;TrainScreen&quot;</span><span class="p">:</span>                  <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a screen transition rule. Let&#39;s say that the transition</span>
<span class="sd">dynamic looks like this:</span>

<span class="sd">.. code-block:: text</span>

<span class="sd">    home &lt;---&gt; settings &lt;---&gt; account</span>
<span class="sd">                  ^</span>
<span class="sd">                  |</span>
<span class="sd">                  v</span>
<span class="sd">              shortcuts</span>

<span class="sd">You can represent it like this::</span>

<span class="sd">    ts.addRule(&quot;home&quot;, &quot;settings&quot;, &quot;account&quot;, &quot;settings&quot;, &quot;home&quot;)</span>
<span class="sd">    ts.addRule(&quot;settings&quot;, &quot;shortcuts&quot;, &quot;settings&quot;)&quot;&quot;&quot;</span>                           <span class="c1"># TrainScreen</span>
        <span class="n">screenNames</span> <span class="o">|</span> <span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">();</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.transitionScreens"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.transitionScreens">[docs]</a>    <span class="k">def</span> <span class="nf">transitionScreens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obeyRule</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="n">whatever</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span> <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of screens (list of (frameId, screen name) tuple) that</span>
<span class="sd">the network deems to be transitions between screen states.</span>

<span class="sd">:param obeyRule: if not specified, then don&#39;t filter. If True, returns only screens that</span>
<span class="sd">    are part of the specified rule and vice versa&quot;&quot;&quot;</span>                             <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coldGuard</span><span class="p">()</span>                                                        <span class="c1"># TrainScreen</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feats</span><span class="p">)</span> <span class="o">|</span> <span class="n">insertIdColumn</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">discardTransients</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="o">~</span><span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="ow">not</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx2Name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">obeyRule</span> <span class="ow">is</span> <span class="n">whatever</span><span class="p">:</span> <span class="k">return</span> <span class="n">transitions</span>                              <span class="c1"># TrainScreen</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">inSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">obeyRule</span> <span class="k">else</span> <span class="o">~</span><span class="n">inSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>        <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="n">transitions</span> <span class="o">|</span> <span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="n">iden</span><span class="p">()</span> <span class="o">+</span> <span class="n">aS</span><span class="p">(</span><span class="nb">tuple</span><span class="p">))</span> <span class="o">|</span> <span class="n">f</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">unique</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.newEvent"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.newEvent">[docs]</a>    <span class="k">def</span> <span class="nf">newEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sess</span><span class="p">:</span><span class="n">WsSession</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>                              <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span>                                            <span class="c1"># TrainScreen</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>                                                <span class="c1"># TrainScreen</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;frame&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">np2Tensor</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_distNet</span><span class="p">)</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>\
                    <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">model</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx2Name</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="c1"># TrainScreen</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">eventCb</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;screenName&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}))</span> <span class="c1"># TrainScreen</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;screenName&quot;</span><span class="p">:</span>                                        <span class="c1"># TrainScreen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_screenDump</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]);</span> <span class="n">res</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screenTransients</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>                                                              <span class="c1"># TrainScreen</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">eventCb</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;screenTransition&quot;</span><span class="p">,</span> <span class="s2">&quot;transition&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lastScreenName</span><span class="p">,</span> <span class="n">res</span><span class="p">)}))</span> <span class="c1"># TrainScreen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_lastScreenName</span> <span class="o">=</span> <span class="n">res</span>                                       <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.predict"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feats</span><span class="p">:</span><span class="s2">&quot;torch.Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>                        <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Using the built-in network, tries to predict the screen name for a</span>
<span class="sd">bunch of features of shape (N, 10). Example::</span>

<span class="sd">    r = ...; ts = k1ui.TrainScreen(r); next(ts)</span>
<span class="sd">    ts.register({&quot;bg&quot;: [9, 10, 11, 12, 17, 19], &quot;docs&quot;: [5, 6, 7, 8, 0, 1, 4], &quot;jupyter&quot;: [2, 3]})</span>
<span class="sd">    # returns list of 2 integers</span>
<span class="sd">    ts.predict(torch.randn(2, 3, 192, 192) | aS(k1ui.distNet()))&quot;&quot;&quot;</span>              <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coldGuard</span><span class="p">();</span> <span class="k">return</span> <span class="n">feats</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">model</span><span class="p">)</span> <span class="o">|</span> <span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.transitionGraph"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.transitionGraph">[docs]</a>    <span class="k">def</span> <span class="nf">transitionGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;graphviz.dot.Digraph&quot;</span><span class="p">:</span>                         <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a screen transition graph of the entire recording. See also: :meth:`graphs`&quot;&quot;&quot;</span> <span class="c1"># TrainScreen</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">digraph</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitionScreens</span><span class="p">()</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">window</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span> <span class="o">|</span> <span class="n">count</span><span class="p">()</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">g</span><span class="p">(</span><span class="o">*</span><span class="n">xy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">();</span> <span class="k">return</span> <span class="n">g</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.ruleGraph"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.ruleGraph">[docs]</a>    <span class="k">def</span> <span class="nf">ruleGraph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;graphviz.dot.Digraph&quot;</span><span class="p">:</span>                               <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a screen transition graph based on the specified rules.</span>
<span class="sd">Rules are added using :meth:`addRule`. See also: :meth:`graphs`&quot;&quot;&quot;</span>               <span class="c1"># TrainScreen</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">digraph</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">|</span> <span class="n">ignore</span><span class="p">();</span> <span class="k">return</span> <span class="n">g</span>           <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.graphs"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.graphs">[docs]</a>    <span class="k">def</span> <span class="nf">graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">viz</span><span class="o">.</span><span class="n">Carousel</span><span class="p">:</span>                                            <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combines both graphs from :meth:`transitionGraph` and :meth:`ruleGraph`&quot;&quot;&quot;</span> <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionGraph</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ruleGraph</span><span class="p">()]</span> <span class="o">|</span> <span class="n">toImg</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">viz</span><span class="o">.</span><span class="n">Carousel</span><span class="p">)</span> <span class="c1"># TrainScreen</span></div>
<div class="viewcode-block" id="TrainScreen.labeledData"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.labeledData">[docs]</a>    <span class="k">def</span> <span class="nf">labeledData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">viz</span><span class="o">.</span><span class="n">Carousel</span><span class="p">:</span>                                       <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualizes labeled data&quot;&quot;&quot;</span>                                            <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">|</span> <span class="n">groupBy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">randomize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">plotImgs</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aspect</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">im</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">viz</span><span class="o">.</span><span class="n">Carousel</span><span class="p">)</span> <span class="c1"># TrainScreen</span></div>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">);</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">];</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_lastScreenName&quot;</span><span class="p">];</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_screenDump&quot;</span><span class="p">];</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_screenTransients&quot;</span><span class="p">];</span> <span class="k">return</span> <span class="n">d</span> <span class="c1"># TrainScreen</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>                                                   <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lastScreenName</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_screenDump</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span> <span class="c1"># TrainScreen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_screenTransients</span> <span class="o">=</span> <span class="n">discardTransients</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_screenDump</span><span class="p">,</span> <span class="n">regular</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># TrainScreen</span>
<div class="viewcode-block" id="TrainScreen.correctRatio"><a class="viewcode-back" href="../../../k1ui.html#k1lib.k1ui.main.TrainScreen.correctRatio">[docs]</a>    <span class="k">def</span> <span class="nf">correctRatio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                      <span class="c1"># TrainScreen</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ratio between the number of screens that is in a valid transition and</span>
<span class="sd">ones that isn&#39;t in a valid transition. Just a quick metric to see how well the</span>
<span class="sd">network is doing. The higher the number, the better it is&quot;&quot;&quot;</span>                     <span class="c1"># TrainScreen</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionScreens</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitionScreens</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span> <span class="c1"># TrainScreen</span></div></div>
<span class="k">def</span> <span class="nf">fillIn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>                                                           <span class="c1"># fillIn</span>
    <span class="n">iS</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># index of states                                                     # fillIn</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">nextI</span><span class="p">,</span> <span class="n">nextS</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span>                                      <span class="c1"># fillIn</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>                                                           <span class="c1"># fillIn</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">nextI</span><span class="p">:</span>                                                           <span class="c1"># fillIn</span>
            <span class="n">iS</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">nextS</span>                                               <span class="c1"># fillIn</span>
            <span class="k">if</span> <span class="n">iS</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">):</span> <span class="n">nextI</span><span class="p">,</span> <span class="n">nextS</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span>                       <span class="c1"># fillIn</span>
        <span class="k">yield</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">]</span>                                                         <span class="c1"># fillIn</span>
<span class="k">def</span> <span class="nf">blocks</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>                                                                  <span class="c1"># blocks</span>
    <span class="n">lastIs</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lastE</span> <span class="o">=</span> <span class="kc">None</span>                                                    <span class="c1"># blocks</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>                                                              <span class="c1"># blocks</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="n">lastE</span><span class="p">:</span>                                                           <span class="c1"># blocks</span>
            <span class="k">if</span> <span class="n">lastE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">yield</span> <span class="nb">min</span><span class="p">(</span><span class="n">lastIs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lastIs</span><span class="p">),</span> <span class="n">lastE</span>          <span class="c1"># blocks</span>
            <span class="n">lastIs</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">lastE</span> <span class="o">=</span> <span class="n">e</span>                                               <span class="c1"># blocks</span>
        <span class="n">lastIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                                                         <span class="c1"># blocks</span>
    <span class="k">yield</span> <span class="nb">min</span><span class="p">(</span><span class="n">lastIs</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lastIs</span><span class="p">),</span> <span class="n">lastE</span>                                        <span class="c1"># blocks</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">TrainScreen</span><span class="p">)</span>                                                           <span class="c1"># blocks</span>
<span class="k">def</span> <span class="nf">_dataF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>                                                         <span class="c1"># _dataF</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coldGuard</span><span class="p">();</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">fillIn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="n">op</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># old version. A bit more liveral than v2, and will accidentally auto label wrongly from time to time # _dataF</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">z</span> <span class="o">|</span> <span class="n">repeat</span><span class="p">()]</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">())</span> <span class="o">|</span> <span class="n">joinStreams</span><span class="p">()</span> <span class="c1"># _dataF</span>
    <span class="n">js</span> <span class="o">=</span> <span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="n">xs</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">repeatFrom</span><span class="p">()</span> <span class="o">|</span> <span class="n">randomize</span><span class="p">())</span> <span class="o">|</span> <span class="n">joinStreamsRandom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trainParams</span><span class="p">[</span><span class="s2">&quot;joinAlpha&quot;</span><span class="p">],</span> <span class="n">xs</span> <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">|</span> <span class="n">deref</span><span class="p">()))</span> <span class="c1"># joinStreams # _dataF</span>
    <span class="k">return</span> <span class="n">v2</span> <span class="o">|</span> <span class="n">randomize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">groupBy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">filt</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">splitW</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">transpose</span><span class="p">()</span>\
        <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">js</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feats</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name2Idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">batched</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>\
                <span class="o">|</span> <span class="n">apply</span><span class="p">(</span><span class="n">transpose</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span> <span class="o">+</span> <span class="n">toTensor</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span> <span class="c1"># _dataF</span>
               <span class="p">)</span> <span class="o">|</span> <span class="n">stagger</span><span class="o">.</span><span class="n">tv</span><span class="p">(</span><span class="mi">1024</span><span class="o">/</span><span class="n">bs</span><span class="p">)</span> <span class="o">|</span> <span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>                                <span class="c1"># _dataF</span>
<span class="k">def</span> <span class="nf">midBounds</span><span class="p">(</span><span class="n">it</span><span class="p">):</span> <span class="c1"># to grab data samples that&#39;s in between blocks. Aka the really confusing case in-between transitions, so that the user can guide it effectively # midBounds</span>
    <span class="n">lastI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lastE</span> <span class="o">=</span> <span class="kc">None</span>                                                      <span class="c1"># midBounds</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>                                                              <span class="c1"># midBounds</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="n">lastE</span><span class="p">:</span> <span class="k">yield</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">lastI</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="n">lastI</span><span class="p">,</span> <span class="n">lastE</span><span class="p">;</span> <span class="n">lastE</span> <span class="o">=</span> <span class="n">e</span>           <span class="c1"># midBounds</span>
        <span class="n">lastI</span> <span class="o">=</span> <span class="n">i</span>                                                                <span class="c1"># midBounds</span>
    <span class="k">return</span> <span class="n">it</span>                                                                    <span class="c1"># midBounds</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">TrainScreen</span><span class="p">)</span>                                                           <span class="c1"># midBounds</span>
<span class="k">def</span> <span class="nf">_midBoundaryConsidering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">midBounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">sort</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">cut</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># _midBoundaryConsidering</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Quang Ho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>