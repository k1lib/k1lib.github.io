<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>k1lib.cli.inp &mdash; k1lib  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> k1lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../base.html">Base module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cli/index.html">k1lib.cli module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../callbacks/index.html">k1lib.callbacks module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../k1a.html">k1lib._k1a module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../k1ui.html">k1lib.k1ui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../eqn.html">k1lib.eqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fmt.html">k1lib.fmt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graphEqn.html">k1lib.graphEqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../imports.html">k1lib.imports module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mo.html">k1lib.mo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../knn.html">k1lib.knn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../p5.html">k1lib.p5 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schedule.html">k1lib.schedule module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../selector.html">k1lib.selector module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../selen.html">k1lib.selen module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../serve.html">k1lib.serve module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viz.html">k1lib.viz module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../monkey.html">Monkey patched classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelogs.html">Changelogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">k1lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">k1lib.cli.inp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for k1lib.cli.inp</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED FILE! PLEASE DON&#39;T EDIT HERE. EDIT THE SOURCE NOTEBOOKS INSTEAD</span>
<span class="sd">&quot;&quot;&quot;This module for tools that will likely start the processing stream.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">k1lib</span><span class="o">,</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">k1lib</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">warnings</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">dill</span><span class="o">,</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">validators</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">k1lib.cli</span> <span class="kn">import</span> <span class="n">BaseCli</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">k1lib.cli</span> <span class="k">as</span> <span class="nn">cli</span>
<span class="kn">from</span> <span class="nn">k1lib.cli.typehint</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="n">requests</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">minio</span><span class="p">;</span> <span class="n">hasMinio</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span> <span class="n">hasMinio</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="s2">&quot;splitSeek&quot;</span><span class="p">,</span> <span class="s2">&quot;refineSeek&quot;</span><span class="p">,</span> <span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="s2">&quot;cmd&quot;</span><span class="p">,</span> <span class="s2">&quot;walk&quot;</span><span class="p">,</span> <span class="s2">&quot;requireCli&quot;</span><span class="p">,</span> <span class="s2">&quot;urlPath&quot;</span><span class="p">,</span> <span class="s2">&quot;kzip&quot;</span><span class="p">,</span> <span class="s2">&quot;kunzip&quot;</span><span class="p">,</span> <span class="s2">&quot;unzip&quot;</span><span class="p">]</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cli</span>
<span class="k">class</span> <span class="nc">NoPartialContent</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>                                          <span class="c1"># NoPartialContent</span>
<span class="k">def</span> <span class="nf">getChunk</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">sB</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">eB</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">retries</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span> <span class="c1"># start inclusive, end exclusive # getChunk</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">retries</span><span class="p">):</span>                                                     <span class="c1"># getChunk</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Range&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;bytes=</span><span class="si">{</span><span class="n">sB</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">eB</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="c1"># getChunk</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                                                   <span class="c1"># getChunk</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t get file chunk&quot;</span><span class="p">)</span>          <span class="c1"># getChunk</span>
            <span class="k">continue</span>                                                             <span class="c1"># getChunk</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">206</span><span class="p">:</span> <span class="k">raise</span> <span class="n">NoPartialContent</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server doesn&#39;t allow partial downloads at this particular url. Status code: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># getChunk</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">content</span>                                                       <span class="c1"># getChunk</span>
<span class="k">def</span> <span class="nf">getChunks</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">sB</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">eB</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">chunkSize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunkTimeout</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">chunkRetries</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span> <span class="c1"># getChunks</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Grabs bytes from sB to eB in chunks&quot;&quot;&quot;</span>                                    <span class="c1"># getChunks</span>
    <span class="n">chunkSize</span> <span class="o">=</span> <span class="n">chunkSize</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">chunkSize</span>                          <span class="c1"># getChunks</span>
    <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">getChunk</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">stop</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunkTimeout</span><span class="p">,</span> <span class="n">chunkRetries</span><span class="p">))</span> <span class="c1"># getChunks</span>
<span class="n">catSettings</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;chunkSize&quot;</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="s2">&quot;file reading chunk size for binary+chunk mode. Decrease it to avoid wasting memory and increase it to avoid disk latency&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="n">catSettings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;every&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;for text mode, will print every n lines&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;for binary mode, will print every n 100000-byte blocks&quot;</span><span class="p">),</span> <span class="s2">&quot;profiler print frequency&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="n">catSettings</span><span class="p">,</span> <span class="s2">&quot;inp.cat() settings&quot;</span><span class="p">)</span>                           <span class="c1"># getChunks</span>
                                                                                 <span class="c1"># getChunks</span>
<span class="n">rfS</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span>                                                           <span class="c1"># getChunks</span>
<span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;RemoteFile&quot;</span><span class="p">,</span> <span class="n">rfS</span><span class="p">,</span> <span class="s2">&quot;inp.RemoteFile() settings, used in cat(), splitSeek() and the like&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="n">rfS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;memoryLimit&quot;</span><span class="p">,</span> <span class="mi">100_000_000</span><span class="p">,</span> <span class="s2">&quot;if the internal cache exceeds this limit (in bytes), and randomAccess is False, then old downloaded chunks will be deleted&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="n">rfS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;seconds before terminating the remote request and retrying&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="n">rfS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;retries&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;how many times to retry sending the request before giving up&quot;</span><span class="p">)</span> <span class="c1"># getChunks</span>
<span class="k">def</span> <span class="nf">noPartial</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>                                                       <span class="c1"># noPartial</span>
    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">getChunk</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">10</span>                           <span class="c1"># noPartial</span>
    <span class="k">except</span> <span class="n">NoPartialContent</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>                                         <span class="c1"># noPartial</span>
<span class="k">class</span> <span class="nc">RemoteFile</span><span class="p">:</span>                                                                <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">randomAccess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blockSize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noPartialConfirm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retries</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># RemoteFile</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">:param url: url of the remote file</span>
<span class="sd">:param randomAccess: is random accessing parts of the file expected? If</span>
<span class="sd">    True, then keeps all of the reads in ram internally, else free them</span>
<span class="sd">    as soon as possible</span>
<span class="sd">:param blockSize: all reads will fetch roughly this amount of bytes&quot;&quot;&quot;</span>           <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomAccess</span> <span class="o">=</span> <span class="n">randomAccess</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockSize</span> <span class="o">=</span> <span class="n">blockSize</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">chunkSize</span> <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noPartialConfirm</span> <span class="o">=</span> <span class="n">noPartialConfirm</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Domain</span><span class="p">()</span> <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span> <span class="c1"># List[sB, eB, content]           # RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_confirmMsgShown</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">rfS</span><span class="o">.</span><span class="n">timeout</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">retries</span> <span class="ow">or</span> <span class="n">rfS</span><span class="o">.</span><span class="n">retries</span> <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_totalReadSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">noPartial</span> <span class="o">=</span> <span class="n">noPartial</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">)</span> <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sB</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">eB</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="c1"># fetches from start to end byte and dumps to internal memory. Inclusive start and end byte # RemoteFile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">noPartial</span><span class="p">:</span>                                                   <span class="c1"># RemoteFile</span>
            <span class="n">eB</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eB</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sB</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">blockSize</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>                      <span class="c1"># RemoteFile</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">getChunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">)</span>       <span class="c1"># RemoteFile</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># RemoteFile</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noPartialConfirm</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confirmMsgShown</span><span class="p">:</span>              <span class="c1"># RemoteFile</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Remote file &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; don&#39;t support partial downloads.</span>
<span class="s2">Therefore the entire file will be loaded into RAM, which</span>
<span class="s2">could be undesireable. Do you want to continue? Y/n: &quot;&quot;&quot;</span><span class="p">)</span>                        <span class="c1"># RemoteFile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_confirmMsgShown</span> <span class="o">=</span> <span class="kc">True</span>                                     <span class="c1"># RemoteFile</span>
                <span class="k">if</span> <span class="n">ans</span><span class="o">.</span><span class="n">lower</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">]);</span> <span class="k">return</span> <span class="c1"># RemoteFile</span>
            <span class="n">sB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">;</span> <span class="n">eB</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>      <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reads</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">,</span> <span class="n">chunk</span><span class="p">])</span>                                       <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_totalReadSize</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">+</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Domain</span><span class="p">([</span><span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">])</span> <span class="c1"># RemoteFile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomAccess</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_totalReadSize</span> <span class="o">&gt;</span> <span class="n">rfS</span><span class="o">.</span><span class="n">memoryLimit</span><span class="p">:</span> <span class="c1"># deletes old reads # RemoteFile</span>
            <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>                                 <span class="c1"># RemoteFile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_totalReadSize</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>                                    <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">_ensureRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">):</span> <span class="c1"># makes sure that all ranges between sB and eB are available # RemoteFile</span>
        <span class="n">missingDomain</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Domain</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">sB</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">eB</span><span class="o">+</span><span class="mi">30</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))])</span> <span class="o">&amp;</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="c1"># RemoteFile</span>
        <span class="k">for</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span> <span class="ow">in</span> <span class="n">missingDomain</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span>                  <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">_readChunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">):</span> <span class="c1"># read from sB to eB, but in chunks, to be optimized. inclusive sB, exclusive eB # RemoteFile</span>
        <span class="n">sB</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span> <span class="n">eB</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">eB</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensureRange</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span> <span class="c1"># RemoteFile</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">filt</span><span class="p">(</span><span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">chunk</span><span class="p">:</span> <span class="n">e</span><span class="o">&gt;=</span><span class="n">sB</span> <span class="ow">and</span> <span class="n">s</span><span class="o">&lt;=</span><span class="n">eB</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">chunk</span><span class="p">:</span> <span class="n">chunk</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">sB</span><span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">+</span><span class="nb">min</span><span class="p">(</span><span class="n">eB</span><span class="o">-</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">filt</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>                                            <span class="c1"># RemoteFile</span>
        <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">=</span> <span class="n">cookie</span>                                    <span class="c1"># RemoteFile</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">+=</span> <span class="n">cookie</span>                                 <span class="c1"># RemoteFile</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">cookie</span>                      <span class="c1"># RemoteFile</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid whence&quot;</span><span class="p">)</span>                                  <span class="c1"># RemoteFile</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span>                                                      <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                             <span class="c1"># RemoteFile</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readChunks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>             <span class="c1"># RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span> <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">if</span> <span class="n">join</span> <span class="k">else</span> <span class="n">chunks</span>        <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                            <span class="c1"># RemoteFile</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">seekPos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span>                                         <span class="c1"># RemoteFile</span>
        <span class="k">try</span><span class="p">:</span>                                                                     <span class="c1"># RemoteFile</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                      <span class="c1"># RemoteFile</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockSize</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>                   <span class="c1"># RemoteFile</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">()</span>                      <span class="c1"># RemoteFile</span>
                    <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>                                            <span class="c1"># RemoteFile</span>
                    <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">()</span>                       <span class="c1"># RemoteFile</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span> <span class="k">pass</span>                                                 <span class="c1"># RemoteFile</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>                                                      <span class="c1"># RemoteFile</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                                                <span class="c1"># RemoteFile</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span> <span class="c1"># only happens at end of file            # RemoteFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">=</span> <span class="n">seekPos</span> <span class="o">+</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span><span class="n">ans</span><span class="p">[:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">newLine</span> <span class="k">else</span> <span class="n">ans</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newLine</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                           <span class="c1"># RemoteFile</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                              <span class="c1"># RemoteFile</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">newLine</span><span class="p">)</span>                                         <span class="c1"># RemoteFile</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">break</span>                                  <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">seekPos</span>                                          <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="nf">_getSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># RemoteFile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noPartial</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>           <span class="c1"># RemoteFile</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">):</span>                                            <span class="c1"># RemoteFile</span>
            <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toDict</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()[</span><span class="s2">&quot;content-length&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ab_int</span><span class="p">()</span> <span class="c1"># RemoteFile</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>                                               <span class="c1"># RemoteFile</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t get size of remote file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                           <span class="c1"># RemoteFile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getSize</span><span class="p">()</span>                        <span class="c1"># RemoteFile</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>                                                         <span class="c1"># RemoteFile</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;RemoteFile url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> size=</span><span class="si">{</span><span class="n">k1lib</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># RemoteFile</span>
<span class="kn">import</span> <span class="nn">zipfile</span><span class="o">,</span> <span class="nn">inspect</span>                                                          <span class="c1"># RemoteFile</span>
<span class="k">class</span> <span class="nc">ZipWrapper</span><span class="p">:</span>                                                                <span class="c1"># ZipWrapper</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">zfn</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zfn</span> <span class="o">=</span> <span class="n">zfn</span>                       <span class="c1"># ZipWrapper</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># ZipWrapper</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">compress_size</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="n">file_size</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="c1"># ZipWrapper</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Zip subfile name=&#39;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="n">k1lib</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">file_size</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">k1lib</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">compress_size</span><span class="p">)</span><span class="si">}{</span><span class="n">s</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># ZipWrapper</span>
    <span class="nd">@property</span>                                                                    <span class="c1"># ZipWrapper</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">file_size</span>                                      <span class="c1"># ZipWrapper</span>
    <span class="nd">@property</span>                                                                    <span class="c1"># ZipWrapper</span>
    <span class="k">def</span> <span class="nf">compressedSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">compress_size</span>                        <span class="c1"># ZipWrapper</span>
    <span class="k">def</span> <span class="nf">_catHandle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                        <span class="c1"># ZipWrapper</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zfn</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>                                  <span class="c1"># ZipWrapper</span>
            <span class="k">with</span> <span class="n">zipf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">subfile</span><span class="p">:</span>                          <span class="c1"># ZipWrapper</span>
                <span class="k">yield</span> <span class="n">subfile</span>                                                    <span class="c1"># ZipWrapper</span>
<span class="nd">@contextmanager</span>                                                                  <span class="c1"># ZipWrapper</span>
<span class="k">def</span> <span class="nf">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">noPartialConfirm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># can be actual file or url      # openFile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                  <span class="c1"># openFile</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;_catHandle&quot;</span><span class="p">):</span> <span class="k">yield from</span> <span class="n">fn</span><span class="o">.</span><span class="n">_catHandle</span><span class="p">();</span> <span class="k">return</span> <span class="c1"># custom datatype case # openFile</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">yield</span> <span class="n">fn</span><span class="p">;</span> <span class="k">return</span> <span class="c1"># file handle case, just return itself            # openFile</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>                                                       <span class="c1"># openFile</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>                                                                 <span class="c1"># openFile</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">chunkSize</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">yield</span> <span class="n">f</span>             <span class="c1"># openFile</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># openFile</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">chunkSize</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">yield</span> <span class="n">f</span>            <span class="c1"># openFile</span>
    <span class="k">elif</span> <span class="n">validators</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>                                             <span class="c1"># openFile</span>
        <span class="k">yield</span> <span class="n">RemoteFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">noPartialConfirm</span><span class="o">=</span><span class="n">noPartialConfirm</span><span class="p">)</span>           <span class="c1"># openFile</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> doesn&#39;t seem to exist and/or it&#39;s not a valid url&quot;</span><span class="p">)</span> <span class="c1"># openFile</span>
<span class="k">def</span> <span class="nf">_catGenText</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">):</span> <span class="c1"># fn for &quot;file name&quot;                                # _catGenText</span>
    <span class="k">try</span><span class="p">:</span>                                                                         <span class="c1"># _catGenText</span>
        <span class="k">if</span> <span class="n">sB</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">eB</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># fast path without bounds (90-160 MB/s expected) # _catGenText</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>                                        <span class="c1"># _catGenText</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                              <span class="c1"># _catGenText</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># why put the if outside the loop? Speed reasons. Also, isn&#39;t .readline() supposed to return a string? Well, cause we&#39;re supporting random file handles from custom datatypes, some asshole file handles might return bytes instead # _catGenText</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                  <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="k">return</span>                                    <span class="c1"># _catGenText</span>
                        <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="n">line</span>            <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                      <span class="c1"># _catGenText</span>
                <span class="k">else</span><span class="p">:</span>                                                            <span class="c1"># _catGenText</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                  <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>                                     <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="k">return</span>                                    <span class="c1"># _catGenText</span>
                        <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="n">line</span>            <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                      <span class="c1"># _catGenText</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># slow path with bounds (15 MB/s expected). Update: much faster now, expect only 40% slower than the path above # _catGenText</span>
            <span class="n">sB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">);</span> <span class="n">eB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span>                                 <span class="c1"># _catGenText</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>                                        <span class="c1"># _catGenText</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">sB</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">sB</span> <span class="c1"># current byte                                # _catGenText</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                              <span class="c1"># _catGenText</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                        <span class="c1"># _catGenText</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                  <span class="c1"># _catGenText</span>
                        <span class="n">b</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                                           <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>                                <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">eB</span><span class="p">:</span> <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">eB</span><span class="p">)];</span> <span class="k">return</span>         <span class="c1"># _catGenText</span>
                        <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="n">line</span>            <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                      <span class="c1"># _catGenText</span>
                <span class="k">else</span><span class="p">:</span>                                                            <span class="c1"># _catGenText</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                  <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>                                     <span class="c1"># _catGenText</span>
                        <span class="n">b</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                                           <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>                                <span class="c1"># _catGenText</span>
                        <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">eB</span><span class="p">:</span> <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">eB</span><span class="p">)];</span> <span class="k">return</span>         <span class="c1"># _catGenText</span>
                        <span class="k">yield</span> <span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="n">line</span>            <span class="c1"># _catGenText</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                      <span class="c1"># _catGenText</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span> <span class="k">pass</span>                                               <span class="c1"># _catGenText</span>
<span class="k">def</span> <span class="nf">_catGenBin</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">):</span>                                                      <span class="c1"># _catGenBin</span>
    <span class="n">chunkSize</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">chunkSize</span><span class="p">;</span> <span class="n">sB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">);</span> <span class="n">eB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">eB</span><span class="p">);</span> <span class="n">nB</span> <span class="o">=</span> <span class="n">eB</span> <span class="o">-</span> <span class="n">sB</span> <span class="c1"># number of bytes to read total # _catGenBin</span>
    <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>                                               <span class="c1"># _catGenBin</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">sB</span><span class="p">);</span> <span class="n">nChunks</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nB</span> <span class="o">/</span> <span class="n">chunkSize</span><span class="p">);</span> <span class="n">lastChunkSize</span> <span class="o">=</span> <span class="n">nB</span> <span class="o">-</span> <span class="n">chunkSize</span><span class="o">*</span><span class="p">(</span><span class="n">nChunks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># _catGenBin</span>
        <span class="c1"># had to do this because RemoteFile is actually not thread-safe          # _catGenBin</span>
        <span class="c1"># applyF = (lambda f_: cli.apply(f_)) if isinstance(f, RemoteFile) else (lambda f_: cli.applyTh(f_, prefetch=10)) # _catGenBin</span>
        <span class="n">applyF</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">f_</span><span class="p">:</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f_</span><span class="p">))</span> <span class="c1"># actually, normal reads are not thread-safe either. Stupid me # _catGenBin</span>
        <span class="k">yield from</span> <span class="nb">range</span><span class="p">(</span><span class="n">nChunks</span><span class="p">)</span> <span class="o">|</span> <span class="n">applyF</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nChunks</span><span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunkSize</span><span class="p">)[:</span><span class="n">lastChunkSize</span><span class="p">])</span> <span class="c1"># _catGenBin</span>
<span class="k">def</span> <span class="nf">fileLength</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>                                                              <span class="c1"># fileLength</span>
    <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">)</span>                 <span class="c1"># fileLength</span>
<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="k">return</span> <span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">b</span> <span class="o">+</span> <span class="n">fileLength</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>                  <span class="c1"># wrap</span>
<span class="k">class</span> <span class="nc">_cat</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                             <span class="c1"># _cat</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">):</span>                                    <span class="c1"># _cat</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">capture</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                                           <span class="c1"># _cat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sB</span> <span class="o">=</span> <span class="n">sB</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eB</span> <span class="o">=</span> <span class="n">eB</span>       <span class="c1"># _cat</span>
    <span class="k">def</span> <span class="nf">_typehint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                           <span class="c1"># _cat</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="k">return</span> <span class="n">tIter</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="k">else</span> <span class="n">tList</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>           <span class="c1"># _cat</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">tIter</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="k">else</span> <span class="nb">bytes</span>                      <span class="c1"># _cat</span>
    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;fileHandle&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]:</span> <span class="c1"># _cat</span>
        <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capturedSerial</span><span class="p">;</span> <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">;</span> <span class="n">chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">;</span> <span class="n">sB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sB</span><span class="p">;</span> <span class="n">eB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eB</span> <span class="c1"># _cat</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;_cat&quot;</span><span class="p">):</span> <span class="c1"># custom datatype, _cat method defined, so it will take control of things # _cat</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">chunks</span><span class="p">,</span> <span class="s2">&quot;sB&quot;</span><span class="p">:</span> <span class="n">sB</span><span class="p">,</span> <span class="s2">&quot;eB&quot;</span><span class="p">:</span> <span class="n">eB</span><span class="p">}</span>        <span class="c1"># _cat</span>
            <span class="n">kwdiff</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span><span class="n">text</span><span class="o">!=</span><span class="kc">True</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;chunks&quot;</span><span class="p">,</span><span class="n">chunks</span><span class="o">!=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="n">chunks</span><span class="o">!=</span><span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;sB&quot;</span><span class="p">,</span><span class="n">sB</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;eB&quot;</span><span class="p">,</span><span class="n">eB</span><span class="o">!=-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span> <span class="c1"># _cat</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>       <span class="c1"># _cat</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;ser&quot;</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">]);</span> <span class="n">weirdArgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span> <span class="c1"># _cat</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weirdArgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom datatype `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="si">}</span><span class="s2">` has ._cat() method, which expects only `ser` and `kwargs` arguments, but detected these arguments instead: </span><span class="si">{</span><span class="n">weirdArgs</span><span class="si">}</span><span class="s2">. Please fix `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span> <span class="c1"># _cat</span>
            <span class="k">def</span> <span class="nf">guard</span><span class="p">():</span>                                                         <span class="c1"># _cat</span>
                <span class="k">if</span> <span class="n">kwdiff</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom datatype `</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="si">}</span><span class="s2">` does not support custom cat() arguments like </span><span class="si">{</span><span class="n">kwdiff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># _cat</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">guard</span><span class="p">();</span> <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">()</span> <span class="o">|</span> <span class="n">ser</span>                           <span class="c1"># _cat</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                                         <span class="c1"># _cat</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ser&quot;</span><span class="p">:</span> <span class="n">guard</span><span class="p">();</span> <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">(</span><span class="n">ser</span><span class="p">)</span>                <span class="c1"># _cat</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">|</span> <span class="n">ser</span>             <span class="c1"># _cat</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>                                                         <span class="c1"># _cat</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ser&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>                 <span class="c1"># _cat</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">_cat</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">ser</span><span class="p">)</span>                                <span class="c1"># _cat</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unreachable&quot;</span><span class="p">)</span>                                 <span class="c1"># _cat</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">fn</span>               <span class="c1"># _cat</span>
        <span class="k">if</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">chunks</span> <span class="ow">and</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">k1a</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="c1"># _cat</span>
            <span class="k">return</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">_k1a</span><span class="o">.</span><span class="n">k1a</span><span class="o">.</span><span class="n">StrIterCat</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span> <span class="o">|</span> <span class="n">ser</span> <span class="c1"># accelerated C version # _cat</span>
        <span class="k">if</span> <span class="n">chunks</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">_catGenText</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span> <span class="o">|</span> <span class="n">ser</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="p">(</span><span class="n">_catGenBin</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span> <span class="o">|</span> <span class="n">ser</span><span class="p">)</span> <span class="c1"># _cat</span>
        <span class="n">sB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">sB</span><span class="p">);</span> <span class="n">eB</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span>                                     <span class="c1"># _cat</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>                                                                 <span class="c1"># _cat</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">sB</span><span class="p">);</span> <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">eB</span><span class="o">-</span><span class="n">sB</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">|</span> <span class="n">ser</span> <span class="c1"># _cat</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># _cat</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">sB</span><span class="p">);</span> <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">eB</span><span class="o">-</span><span class="n">sB</span><span class="p">)</span> <span class="o">|</span> <span class="n">ser</span> <span class="c1"># _cat</span>
<span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                          <span class="c1"># Profile</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>                   <span class="c1"># Profile</span>
    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>                                                       <span class="c1"># Profile</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">fmt</span><span class="p">;</span> <span class="n">chars</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">beginTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                      <span class="c1"># Profile</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>                                                            <span class="c1"># Profile</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ConstantPad</span><span class="o">.</span><span class="n">multi</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">every</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">every</span><span class="o">.</span><span class="n">text</span> <span class="c1"># Profile</span>
            <span class="k">for</span> <span class="n">lines</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>                                       <span class="c1"># Profile</span>
                <span class="n">chars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>                                                  <span class="c1"># Profile</span>
                <span class="k">if</span> <span class="n">lines</span> <span class="o">%</span> <span class="n">every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># every 1000 lines, print stuff out       # Profile</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">beginTime</span><span class="c1">#; self.data.append([lines, chars, elapsed]) # Profile</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current line: </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">lines</span><span class="o">/</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="si">}</span><span class="s2"> lines/s), current byte/chars: </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">chars</span><span class="o">/</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="si">}</span><span class="s2">/s), elapsed: </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="si">}</span><span class="s2">                                 &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Profile</span>
                <span class="k">yield</span> <span class="n">e</span>                                                          <span class="c1"># Profile</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># Profile</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">ConstantPad</span><span class="o">.</span><span class="n">multi</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="n">every</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">every</span><span class="o">.</span><span class="n">binary</span> <span class="c1"># Profile</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>                                           <span class="c1"># Profile</span>
                <span class="n">chars</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>                                                  <span class="c1"># Profile</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># every 10 100000-byte chunks, print stuff out # Profile</span>
                    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">beginTime</span><span class="c1">#; self.data.append([chars, elapsed]) # Profile</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current size/chars: </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">chars</span><span class="o">/</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="si">}</span><span class="s2">/s), elapsed: </span><span class="si">{</span><span class="n">fmt</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="si">}</span><span class="s2">                                 &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Profile</span>
                <span class="k">yield</span> <span class="n">e</span>                                                          <span class="c1"># Profile</span>
<div class="viewcode-block" id="cat"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.cat">[docs]</a><span class="k">def</span> <span class="nf">cat</span><span class="p">(</span><span class="n">fileName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">profile</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sB</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">eB</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># cat</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a file line by line.</span>
<span class="sd">Example::</span>

<span class="sd">    # display first 10 lines of file</span>
<span class="sd">    cat(&quot;file.txt&quot;) | headOut()</span>
<span class="sd">    # piping in also works</span>
<span class="sd">    &quot;file.txt&quot; | cat() | headOut()</span>

<span class="sd">    # read bytes from an image file and dumps it to another file</span>
<span class="sd">    cat(&quot;img.png&quot;, False) | file(&quot;img2.png&quot;)</span>

<span class="sd">If you want to read only specific sections of the file, you can specify the</span>
<span class="sd">start (``sB``) and end byte (``eB``) like this::</span>

<span class="sd">    &quot;123456\\n89&quot; | file(&quot;test/catTest.pth&quot;)</span>
<span class="sd">    # returns [&#39;3456&#39;, &#39;8&#39;]</span>
<span class="sd">    cat(&quot;test/catTest.pth&quot;, sB=2, eB=8) | deref()</span>

<span class="sd">    settings.cat.context.chunkSize=3 # just for demonstration, don&#39;t do it normally</span>
<span class="sd">    # returns [b&#39;123&#39;, b&#39;456&#39;, b&#39;\\n8&#39;]</span>
<span class="sd">    cat(&quot;test/catTest.pth&quot;, text=False, chunks=True, eB=8) | deref()</span>

<span class="sd">.. admonition:: Remote files</span>

<span class="sd">    You can also read from urls directly, like this::</span>

<span class="sd">        cat(&quot;https://k1lib.com/latest/&quot;) | deref()</span>

<span class="sd">    For remote files like this, there are extra settings at :data:`~k1lib.settings`.cli.RemoteFile.</span>
<span class="sd">    This will also read the file chunk by chunk if required. If the website doesn&#39;t support</span>
<span class="sd">    partial downloads, then all of it will be downloaded and stored into ram, which may not be</span>
<span class="sd">    desireable. The available settings are:</span>

<span class="sd">    - timeout: seconds before killing the existing request</span>
<span class="sd">    - retries: try to resend the request for this much before giving up</span>

<span class="sd">If you are working with large files and would like to read 1 file from multiple</span>
<span class="sd">threads/processes, then you can use this cli in conjunction with :class:`splitSeek`.</span>

<span class="sd">If you are dumping multiple pickled objects into a single file, you can read all</span>
<span class="sd">of them using :meth:`cat.pickle`.</span>

<span class="sd">This cli has lots of settings at :data:`~k1lib.settings`.cli.cat</span>

<span class="sd">See also: :meth:`ls`</span>

<span class="sd">.. admonition:: Custom datatype</span>

<span class="sd">    It is possible to build objects that can interoperate with this cli,</span>
<span class="sd">    like this::</span>

<span class="sd">        class custom1:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _cat(self): return [&quot;abc&quot;, &quot;def&quot;]</span>

<span class="sd">        custom1() |  cat()           # returns [&quot;abc&quot;, &quot;def&quot;]</span>
<span class="sd">        custom1() |  cat() | item()  # returns &quot;abc&quot;</span>
<span class="sd">        custom1() | (cat() | item()) # returns &quot;abc&quot;</span>

<span class="sd">    When called upon, :meth:`cat` will see that the input is not a simple string, which</span>
<span class="sd">    will prompt it to look for ``_cat()`` method of the complex object and execute it.</span>
<span class="sd">    By default, if the user specifies any non-default arguments like ``text=False``,</span>
<span class="sd">    it will errors out because :meth:`cat` does not know how to handle it. Here&#39;s how</span>
<span class="sd">    to do it right::</span>

<span class="sd">        class custom2:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _cat(self, kwargs): # default kwargs if user doesn&#39;t specify anything else is `{&quot;text&quot;: True, &quot;chunks&quot;: None, &quot;sB&quot;: 0, &quot;eB&quot;: -1}`</span>
<span class="sd">                if kwargs[&quot;text&quot;]: return [&quot;abc&quot;, &quot;def&quot;]</span>
<span class="sd">                else: return [b&quot;abc&quot;, b&quot;def&quot;]</span>

<span class="sd">        custom2() |  cat()                     # returns [&quot;abc&quot;, &quot;def&quot;]</span>
<span class="sd">        custom2() |  cat()           | item()  # returns &quot;abc&quot;</span>
<span class="sd">        custom2() | (cat()           | item()) # returns &quot;abc&quot;</span>
<span class="sd">        custom2() |  cat(text=False)           # returns [b&quot;abc&quot;, b&quot;def&quot;]</span>
<span class="sd">        custom2() |  cat(text=False) | item()  # returns b&quot;abc&quot;</span>

<span class="sd">    Here, you&#39;re saying that your function can handle non-standard arguments, so</span>
<span class="sd">    :meth:`cat` will give you all the args. You may support only some arguments</span>
<span class="sd">    and completely ignore others, it&#39;s all up to you. Might still be worth it to</span>
<span class="sd">    throw some errors warning users of arguments your custom datatype does not support.</span>

<span class="sd">    You can also capture future clis like this::</span>

<span class="sd">        class custom3:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _cat(self, ser):            # &quot;ser&quot; stands for &quot;serial&quot;</span>
<span class="sd">                if len(ser.clis) == 1 and isinstance(ser.clis[0], item):</span>
<span class="sd">                    return &quot;123&quot;            # fancy optimization</span>
<span class="sd">                return [&quot;abc&quot;, &quot;def&quot;] | ser # default &quot;slow&quot; base case</span>

<span class="sd">        custom3() |  cat()           # returns [&quot;abc&quot;, &quot;def&quot;]</span>
<span class="sd">        custom3() |  cat() | item()  # returns &quot;abc&quot;, because cat() did not capture any clis</span>
<span class="sd">        custom3() | (cat() | item()) # returns &quot;123&quot;, which might be desireable, up to you</span>

<span class="sd">    This feature is pretty advanced actually, in that you can actually do different</span>
<span class="sd">    things based on future processing tasks. Let&#39;s say that the captured cli looks like</span>
<span class="sd">    ``cut(3) | batched(10) | rItem(3)``. This essentially means &quot;give me elements 30</span>
<span class="sd">    through 39 from the 4th column&quot;. With this information, you can query your custom</span>
<span class="sd">    database for exactly those elements only, while fetching nothing else, which would be</span>
<span class="sd">    great for performance.</span>

<span class="sd">    You can also outright lie to the user like in the example, where if :class:`~k1lib.cli.utils.item`</span>
<span class="sd">    is detected, it will return a completely different version (&quot;123&quot;) while it should return</span>
<span class="sd">    &quot;abc&quot; instead. The possibilities are endless. As you can probably feel, it&#39;s super hard to</span>
<span class="sd">    actually utilize this in the right way without breaking something, as you are completely</span>
<span class="sd">    responsible for the captured clis. Let&#39;s see another example::</span>

<span class="sd">        class custom4:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _cat(self, ser):</span>
<span class="sd">                return [&quot;abc&quot;, &quot;def&quot;]</span>

<span class="sd">        custom4() |  cat()           # returns [&quot;abc&quot;, &quot;def&quot;]</span>
<span class="sd">        custom4() |  cat() | item()  # returns &quot;abc&quot;</span>
<span class="sd">        custom4() | (cat() | item()) # returns [&quot;abc&quot;, &quot;def&quot;]</span>

<span class="sd">    Same story as ``custom3``, demonstrating that if you declare that you want to see and</span>
<span class="sd">    manipulate ``ser``, you&#39;ll be completely responsible for it, and if you don&#39;t handle it</span>
<span class="sd">    correctly, it will create horrible bugs. You can, of course, have access to ``ser`` and</span>
<span class="sd">    ``kwargs`` at the same time::</span>

<span class="sd">        class custom5:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _cat(self, ser, kwargs): return [&quot;abc&quot;, &quot;def&quot;] | ser</span>

<span class="sd">    If your custom datatype feels like a block device, and you don&#39;t want to rewrite all</span>
<span class="sd">    the functionalities in :meth:`cat`, you can implement the method ``_catHandle`` that</span>
<span class="sd">    yields the custom file handle instead::</span>

<span class="sd">        class custom6:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _catHandle(self): yield io.BytesIO(b&quot;abc\\ndef\\n123&quot;)</span>
<span class="sd">        class custom7:</span>
<span class="sd">            def __init__(self, config=None): ...</span>
<span class="sd">            def _catHandle(self): yield io.StringIO(&quot;abc\\ndef\\n123&quot;)</span>

<span class="sd">        custom6() | cat(text=False) # returns b&#39;abc\\ndef\\n123&#39;</span>
<span class="sd">        custom7() | cat() | deref() # returns [&#39;abc&#39;, &#39;def&#39;, &#39;123&#39;]</span>

<span class="sd">    Remember that you have to yield instead of returning the file handle. This is so that</span>
<span class="sd">    you can use ``with`` statements, and if you return the file handle, the file might be</span>
<span class="sd">    closed by the time :meth:`cat` decides to use it.</span>

<span class="sd">:param fileName: if None, then return a :class:`~k1lib.cli.init.BaseCli`</span>
<span class="sd">    that accepts a file name and outputs Iterator[str]</span>
<span class="sd">:param text: if True, read text file, else read binary file</span>
<span class="sd">:param chunks: if True then reads the file chunk by chunk, else reads the</span>
<span class="sd">    entire file. Defaults to True in text mode and False in binary mode</span>
<span class="sd">:param profile: whether to profile the file reading rate or not. Can adjust</span>
<span class="sd">    printing frequency using `settings.cli.cat.every`</span>
<span class="sd">:param sB: &quot;start byte&quot;. Specify this if you want to start reading from this byte</span>
<span class="sd">:param eB: &quot;end byte&quot;, exclusive. Default -1 means end of file&quot;&quot;&quot;</span>                <span class="c1"># cat</span>
    <span class="k">if</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">chunks</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="kc">False</span> <span class="c1"># dev note: if default arguments are changed, please also change _cat()&#39;s implementation for custom datatypes # cat</span>
    <span class="k">if</span> <span class="n">profile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t profile reading rate when you&#39;re trying to read everything at once&quot;</span><span class="p">);</span> <span class="n">profile</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># cat</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">_cat</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">sB</span><span class="p">,</span> <span class="n">eB</span><span class="p">)</span>                                               <span class="c1"># cat</span>
    <span class="k">if</span> <span class="n">profile</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">|</span> <span class="n">Profile</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>                                            <span class="c1"># cat</span>
    <span class="k">return</span> <span class="n">f</span> <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fileName</span> <span class="o">|</span> <span class="n">f</span>                               <span class="c1"># cat</span></div>
<span class="k">def</span> <span class="nf">_catPickle</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pickleModule</span><span class="o">=</span><span class="n">dill</span><span class="p">):</span>                                <span class="c1"># _catPickle</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a file as a series of pickled objects.</span>
<span class="sd">Example::</span>

<span class="sd">    &quot;ab&quot; | aS(dill.dumps) | file(&quot;test/catTest.pth&quot;)</span>
<span class="sd">    &quot;cd&quot; | aS(dill.dumps) &gt;&gt; file(&quot;test/catTest.pth&quot;) # append to the file</span>
<span class="sd">    # returns [&quot;ab&quot;, &quot;cd&quot;]</span>
<span class="sd">    cat.pickle(&quot;test/catTest.pth&quot;) | deref()</span>
<span class="sd">    # also returns [&quot;ab&quot;, &quot;cd&quot;], same style as :class:`cat`</span>
<span class="sd">    &quot;test/catTest.pth&quot; | cat.pickle() | deref()</span>

<span class="sd">:param fileName: name of the pickled file</span>
<span class="sd">:param pickleModule: pickle module to use. Python&#39;s default is &quot;pickle&quot;, but</span>
<span class="sd">    I usually use :mod:`dill` because it&#39;s more robust&quot;&quot;&quot;</span>                        <span class="c1"># _catPickle</span>
    <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>                                                                 <span class="c1"># _catPickle</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>                            <span class="c1"># _catPickle</span>
            <span class="k">try</span><span class="p">:</span>                                                                 <span class="c1"># _catPickle</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="k">yield</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                                   <span class="c1"># _catPickle</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>                                                         <span class="c1"># _catPickle</span>
    <span class="k">return</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span> <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fileName</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>           <span class="c1"># _catPickle</span>
<span class="n">cat</span><span class="o">.</span><span class="n">pickle</span> <span class="o">=</span> <span class="n">_catPickle</span>                                                          <span class="c1"># _catPickle</span>
<div class="viewcode-block" id="splitSeek"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.splitSeek">[docs]</a><span class="k">class</span> <span class="nc">splitSeek</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                        <span class="c1"># splitSeek</span>
<div class="viewcode-block" id="splitSeek.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.splitSeek.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                <span class="c1"># splitSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits a file up into n fragments aligned to the closest character and return the seek points.</span>
<span class="sd">Example::</span>

<span class="sd">    # preparing the large file</span>
<span class="sd">    range(120) | apply(lambda x: f&quot;{x:3}_56789&quot;) | file(&quot;test/largeFile.txt&quot;)</span>
<span class="sd">    # returns [0, 30, 70, 110, 150, 190, 230, 270, 300, 340]</span>
<span class="sd">    &quot;test/largeFile.txt&quot; | splitSeek(31) | head()</span>
<span class="sd">    # returns 32</span>
<span class="sd">    &quot;test/largeFile.txt&quot; | splitSeek(31) | shape(0)</span>
<span class="sd">    # returns 32, demonstrating you can also pipe file objects in, if that&#39;s what you want</span>
<span class="sd">    open(&quot;test/largeFile.txt&quot;) | splitSeek(31) | shape(0)</span>
<span class="sd">    # returns [0, 0, 10, 10, 20, 30, 30, 40, 40, 50], notice some segments have zero length</span>
<span class="sd">    &quot;test/largeFile.txt&quot; | splitSeek(200) | head()</span>
<span class="sd">    # returns [0, 400, 1200], demonstrating that you can split a file up unevenly by weights</span>
<span class="sd">    &quot;test/largeFile.txt&quot; | splitSeek(ws=[1, 2]) | deref()</span>

<span class="sd">So, the generated file has 120 lines in total. Each line is 10 bytes (9 for</span>
<span class="sd">the string, and 1 for the new line character). Splitting the file into 31</span>
<span class="sd">fragments will result in 32 seek points (:math:`p_i\quad i\in[1, n+1]`). You</span>
<span class="sd">can then use these seek points to read the file in multiple threads/processes</span>
<span class="sd">using :meth:`cat`, like this::</span>

<span class="sd">    # returns [[&#39;  0_56789&#39;, &#39;  1_56789&#39;, &#39;  2_56789&#39;], [&#39;  3_56789&#39;, &#39;  4_56789&#39;, &#39;  5_56789&#39;, &#39;  6_56789&#39;]]</span>
<span class="sd">    &quot;test/largeFile.txt&quot; | splitSeek(31) | window(2) | ~apply(lambda sB, eB: cat(&quot;test/largeFile.txt&quot;, sB=sB, eB=eB-1)) | head(2) | deref()</span>

<span class="sd">Because :math:`120/31\\approx4`, most of cat&#39;s reads contain 4 lines, but some</span>
<span class="sd">has 3 lines. Also notice that the lines smoothly transitions between cat&#39;s</span>
<span class="sd">reads (``2_56789`` to ``3_56789``), so that&#39;s pretty nice. Just like with :meth:`cat`,</span>
<span class="sd">this also works with urls::</span>

<span class="sd">    &quot;https://example.com&quot; | splitSeek(10)</span>

<span class="sd">.. warning::</span>

<span class="sd">    You have to really test whether reading the same file from multiple processes is</span>
<span class="sd">    going to be really faster or not. If your data is stored in a HDD (aka hard drive,</span>
<span class="sd">    with spinning disks), then it will actually slow you down (10x-100x), because the</span>
<span class="sd">    disk will have to context switch all the time, and each switch has a 10ms cost.</span>

<span class="sd">    You also have to take into account collecting together the results of all processes,</span>
<span class="sd">    which can bottleneck the cpu. Read more about concurrency pitfalls at :class:`~k1lib.cli.modifier.applyMp`.</span>

<span class="sd">In some scenarios where you want to adjust the seek points even more, like when</span>
<span class="sd">you want to parse FASTA genome files, which has blocks of 2/4 lines each like this:</span>

<span class="sd">.. code-block:: text</span>

<span class="sd">    @FP200005993L1C001R00100000061/2</span>
<span class="sd">    TTTTAAACTTGCATTCTTTGGAGATTTGCTGAGTGTTGCTAGAGCTGGGAAACTTTTTTAATGAGATACGTGCATATTTTTCAAATTTACAGATCTTTTTTCACAAAAATAGAAAGTCATAAATGTGAAATGGAAACCTAAACAAGGCAA</span>
<span class="sd">    +</span>
<span class="sd">    GFEEEDEFGFFFFEFFFFFIFCEEEFFFGFFDFEGEDGFFFGDGFFGDGCE@GGGEEFDFGFGCFDFGGHCHFFFGFFFFFGEFDFFGHGFGEEHGFGEGFGFHFFEGFFFE;GEGEFGGHFFEI=GDAEDIFDDFGHFGEFGFEGGGGF</span>
<span class="sd">    @FP200005993L1C001R00100000167/2</span>
<span class="sd">    CTGGAATTTGGTATCTTATTGCCAAAGAATCTGTTTTGTGAAACTTGGGATCTCTATTTTAATGTTAATTCTGGTCAGTTGTGCCTAAACTCCATAAAGCAGGGACTATACTGAGGCGTATTCAATCTTCCTTCTTACCAAGGCCAGGAA</span>
<span class="sd">    +</span>
<span class="sd">    EEFECEDEFFCGFFFFFEEEGEGFEDECCEFEFDFEEFDFEDDFEFEEFDDFFEEFFEEFEFFHEEFEEFEFFDEFFFECF&gt;FFFEFEDFCFFFEGFEDEEGDDFEEFEFGEEBD@EG&gt;EEFFECEEGFEEEFFEDGEEEDE5EBDG:CC</span>

<span class="sd">Here, each 4 lines are (title, read, blank, quality). Because by default, this will</span>
<span class="sd">only split neatly along new lines, you will have to write extra functions to detect</span>
<span class="sd">if a particular seek point is desirable, and if not, either jump forward or backward</span>
<span class="sd">using :meth:`splitSeek.forward` and :meth:`splitSeek.backward`. To help with this,</span>
<span class="sd">:class:`refineSeek` has some useful methods that you might want to check out.</span>

<span class="sd">:param n: how many splits do you want?</span>
<span class="sd">:param c: block-boundary character, usually just the new line character</span>
<span class="sd">:param ws: weights. If given, the splits length ratios will roughly correspond to this&quot;&quot;&quot;</span> <span class="c1"># splitSeek</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># file name, result # splitSeek</span>
        <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specify at least n or ws for splitSeek to work&quot;</span><span class="p">)</span> <span class="c1"># splitSeek</span></div>
<div class="viewcode-block" id="splitSeek.forward"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.splitSeek.forward">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>                                       <span class="c1"># splitSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns char location after the search char, going forward.</span>
<span class="sd">Example::</span>

<span class="sd">    f = io.BytesIO(b&quot;123\\n456\\n789\\nabc&quot;)</span>
<span class="sd">    f | splitSeek(2) # returns [0, 4, 15]</span>
<span class="sd">    splitSeek.forward(f, 2) # returns 4</span>
<span class="sd">    splitSeek.forward(f, 3) # returns 4</span>
<span class="sd">    splitSeek.forward(f, 4) # returns 8</span>

<span class="sd">:param f: file handle</span>
<span class="sd">:param i: current seek point</span>
<span class="sd">:param c: block-boundary character&quot;&quot;&quot;</span>                                            <span class="c1"># splitSeek</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>                                                            <span class="c1"># splitSeek</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>                                                            <span class="c1"># splitSeek</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                          <span class="c1"># splitSeek</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">();</span> <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="n">di</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                   <span class="c1"># splitSeek</span>
                <span class="k">if</span> <span class="n">di</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">b</span> <span class="o">+</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span>                                    <span class="c1"># splitSeek</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>                                            <span class="c1"># splitSeek</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                   <span class="c1"># splitSeek</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span> <span class="k">return</span> <span class="n">inner</span><span class="p">(</span><span class="n">_f</span><span class="p">)</span>  <span class="c1"># splitSeek</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">inner</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                                                    <span class="c1"># splitSeek</span></div>
<div class="viewcode-block" id="splitSeek.backward"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.splitSeek.backward">[docs]</a>    <span class="nd">@staticmethod</span>                                                                <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>                                      <span class="c1"># splitSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns char location after the search char, going backward.</span>
<span class="sd">Example::</span>

<span class="sd">    f = io.BytesIO(b&quot;123\\n456\\n789\\nabc&quot;)</span>
<span class="sd">    f | splitSeek(2) # returns [0, 4, 15]</span>
<span class="sd">    splitSeek.backward(f, 5) # returns 4</span>
<span class="sd">    splitSeek.backward(f, 4) # returns 4</span>
<span class="sd">    splitSeek.backward(f, 3) # returns 0</span>

<span class="sd">:param f: file handle</span>
<span class="sd">:param i: current seek point</span>
<span class="sd">:param c: block-boundary character&quot;&quot;&quot;</span>                                            <span class="c1"># splitSeek</span>
        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>                                                            <span class="c1"># splitSeek</span>
            <span class="n">mul</span> <span class="o">=</span> <span class="mi">1</span>                                                              <span class="c1"># splitSeek</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                          <span class="c1"># splitSeek</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1000</span><span class="o">*</span><span class="n">mul</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">mul</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span> <span class="n">mul</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># search range # splitSeek</span>
                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">();</span> <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">begin</span><span class="p">);</span> <span class="n">di</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1"># splitSeek</span>
                <span class="k">if</span> <span class="n">di</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">b</span> <span class="o">+</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span>                                    <span class="c1"># splitSeek</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>                                              <span class="c1"># splitSeek</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                   <span class="c1"># splitSeek</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">_f</span><span class="p">:</span> <span class="k">return</span> <span class="n">inner</span><span class="p">(</span><span class="n">_f</span><span class="p">)</span>  <span class="c1"># splitSeek</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">inner</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                                                    <span class="c1"># splitSeek</span></div>
<div class="viewcode-block" id="splitSeek.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.splitSeek.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span> <span class="c1"># why return self instead of the seek positions directly? Because we want to pass along dependencies like file name to downstream processes like refineSeek # splitSeek</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>                      <span class="c1"># splitSeek</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">;</span> <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>                       <span class="c1"># splitSeek</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>                                                             <span class="c1"># splitSeek</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_END</span><span class="p">);</span> <span class="n">end</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>                               <span class="c1"># splitSeek</span>
            <span class="k">if</span> <span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">begins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">end</span><span class="o">/</span><span class="n">n</span><span class="p">))</span> <span class="c1"># splitSeek</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">begins</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">splitW</span><span class="p">(</span><span class="o">*</span><span class="n">ws</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="c1"># splitSeek</span>
            <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">begins</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">splitSeek</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)),</span> <span class="n">end</span><span class="p">]</span> <span class="c1"># splitSeek</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                  <span class="c1"># splitSeek</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">f</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span> <span class="c1"># splitSeek</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span>                                   <span class="c1"># splitSeek</span></div>
    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aft</span><span class="p">):</span>                                                       <span class="c1"># splitSeek</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__or__</span><span class="p">(</span><span class="n">aft</span><span class="p">)</span>                          <span class="c1"># splitSeek</span>
        <span class="k">return</span> <span class="n">aft</span><span class="o">.</span><span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                                                 <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                             <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>                                      <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">)</span>                                    <span class="c1"># splitSeek</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>                               <span class="c1"># splitSeek</span></div>
<div class="viewcode-block" id="refineSeek"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.refineSeek">[docs]</a><span class="k">class</span> <span class="nc">refineSeek</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                       <span class="c1"># refineSeek</span>
<div class="viewcode-block" id="refineSeek.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.refineSeek.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>                                        <span class="c1"># refineSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refines seek positions.</span>
<span class="sd">Example::</span>

<span class="sd">    # returns list of integers for seek positions</span>
<span class="sd">    &quot;abc.txt&quot; | splitSeek(30)</span>
<span class="sd">    # returns refined seek positions, such that the line starting at the seek positions starts with &quot;@&quot;</span>
<span class="sd">    &quot;abc.txt&quot; | splitSeek(30) | refineSeek(lambda x: x.startswith(b&quot;@&quot;))</span>
<span class="sd">    # same thing as above</span>
<span class="sd">    &quot;abc.txt&quot; | splitSeek(30) | refineSeek(lambda x: x[0] == b&quot;@&quot;[0])</span>
<span class="sd">    # returns refined seek positions, such that 0th line starts with &quot;@&quot; and 2nd line starts with &quot;+&quot;. This demonstrates `window` parameter</span>
<span class="sd">    &quot;abc.txt&quot; | splitSeek(30) | refineSeek(lambda x: x[0][0] == b&quot;@&quot;[0] and x[2][0] == b&quot;+&quot;[0], 3)</span>
<span class="sd">    # same thing as above, demonstrating some builtin refine seek functions</span>
<span class="sd">    &quot;abc.txt&quot; | splitSeek(30) | refineSeek.fastq()</span>

<span class="sd">:param f: function that returns True if the current line/lines is a valid block boundary</span>
<span class="sd">:param window: by default (1), will fetch 1 line and check boundary using ``f(line)``.</span>
<span class="sd">    If a value greater than 1 is passed (for example, 3), will fetch 3 lines and check</span>
<span class="sd">    boundary using ``f([line1, line2, line3])``</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># refineSeek</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span>                                         <span class="c1"># refineSeek</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">fastF</span><span class="p">(</span><span class="n">f</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span>              <span class="c1"># refineSeek</span></div>
<div class="viewcode-block" id="refineSeek.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.refineSeek.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seeks</span><span class="p">):</span>                                                    <span class="c1"># refineSeek</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">;</span> <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span>                                         <span class="c1"># refineSeek</span>
        <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">fio</span><span class="p">,</span> <span class="n">sB</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>                                                   <span class="c1"># refineSeek</span>
            <span class="n">fio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">sB</span><span class="p">)</span>                                                         <span class="c1"># refineSeek</span>
            <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">fio</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                <span class="c1"># refineSeek</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">repeatF</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">fio</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="n">window</span><span class="p">))</span>             <span class="c1"># refineSeek</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seeks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">seeks</span>                                         <span class="c1"># refineSeek</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="ow">or</span> <span class="n">seeks</span><span class="o">.</span><span class="n">fn</span><span class="p">;</span> <span class="n">newSeeks</span> <span class="o">=</span> <span class="p">[</span><span class="n">seeks</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>                          <span class="c1"># refineSeek</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">fio</span><span class="p">):</span>                                                        <span class="c1"># refineSeek</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">fio</span><span class="p">:</span>                                     <span class="c1"># refineSeek</span>
                <span class="k">for</span> <span class="n">seek</span> <span class="ow">in</span> <span class="n">seeks</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>                                         <span class="c1"># refineSeek</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fio</span><span class="p">,</span> <span class="n">seek</span><span class="p">)</span>                                       <span class="c1"># refineSeek</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="n">f</span><span class="p">(</span><span class="n">line</span><span class="p">):</span> <span class="n">seek</span> <span class="o">=</span> <span class="n">splitSeek</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">fio</span><span class="p">,</span> <span class="n">seek</span><span class="p">);</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fio</span><span class="p">,</span> <span class="n">seek</span><span class="p">)</span> <span class="c1"># refineSeek</span>
                    <span class="n">newSeeks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seek</span><span class="p">)</span>                                        <span class="c1"># refineSeek</span>
            <span class="n">newSeeks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seeks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span> <span class="k">return</span> <span class="n">newSeeks</span>                          <span class="c1"># refineSeek</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                  <span class="c1"># refineSeek</span>
            <span class="k">with</span> <span class="n">openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">fio</span><span class="p">:</span> <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">fio</span><span class="p">)</span>                 <span class="c1"># refineSeek</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>                                                 <span class="c1"># refineSeek</span></div>
<div class="viewcode-block" id="refineSeek.injectFn"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.refineSeek.injectFn">[docs]</a>    <span class="k">def</span> <span class="nf">injectFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>                                                      <span class="c1"># refineSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Injects file name dependency, if this is not used right after :class:`splitSeek`&quot;&quot;&quot;</span> <span class="c1"># refineSeek</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span> <span class="k">return</span> <span class="bp">self</span>                                                <span class="c1"># refineSeek</span></div>
<div class="viewcode-block" id="refineSeek.fastq"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.refineSeek.fastq">[docs]</a>    <span class="nd">@classmethod</span>                                                                 <span class="c1"># refineSeek</span>
    <span class="k">def</span> <span class="nf">fastq</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>                                                              <span class="c1"># refineSeek</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Refine fastq file&#39;s seek points&quot;&quot;&quot;</span>                                    <span class="c1"># refineSeek</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;@&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;+&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>       <span class="c1"># refineSeek</span></div></div>
<div class="viewcode-block" id="wget"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.wget">[docs]</a><span class="k">def</span> <span class="nf">wget</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                <span class="c1"># wget</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads a file. Also returns the file name, in case you want to pipe it</span>
<span class="sd">to something else.</span>

<span class="sd">:param url: The url of the file</span>
<span class="sd">:param fileName: if None, then tries to infer it from the url</span>
<span class="sd">:param mkdir: whether to make the directory leading up to the file or not&quot;&quot;&quot;</span>     <span class="c1"># wget</span>
    <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                           <span class="c1"># wget</span>
    <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span> <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="c1"># wget</span>
    <span class="k">if</span> <span class="n">mkdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                                <span class="c1"># wget</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span> <span class="k">return</span> <span class="n">fileName</span>              <span class="c1"># wget</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>                                                          <span class="c1"># wget</span></div>
<div class="viewcode-block" id="ls"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.ls">[docs]</a><span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="n">folder</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                                         <span class="c1"># ls</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List every file and folder inside the specified folder.</span>
<span class="sd">Example::</span>

<span class="sd">    # returns List[str]</span>
<span class="sd">    ls(&quot;/home&quot;)</span>
<span class="sd">    # same as above</span>
<span class="sd">    &quot;/home&quot; | ls()</span>
<span class="sd">    # only outputs files, not folders</span>
<span class="sd">    ls(&quot;/home&quot;) | filt(os.path.isfile)</span>

<span class="sd">This can handle things that are not plain folders. For example,</span>
<span class="sd">it can handle zip file whereby it will list out all the files contained</span>
<span class="sd">within a particular .zip::</span>

<span class="sd">    ls(&quot;abc.zip&quot;)</span>

<span class="sd">Then, you can use :meth:`cat` as usual, like this::</span>

<span class="sd">    ls(&quot;abc.zip&quot;) | item() | cat()</span>

<span class="sd">Pretty nice!</span>

<span class="sd">.. admonition:: Custom datatype</span>

<span class="sd">    It is possible to build objects that can interoperate with this cli,</span>
<span class="sd">    like this::</span>

<span class="sd">        class sql:</span>
<span class="sd">            def __init__(self): ...</span>
<span class="sd">            def _ls(self): return [&quot;something&quot;, &quot;here&quot;]</span>

<span class="sd">    ls() will identify that what&#39;s inputted is not a string, and will try</span>
<span class="sd">    to execute the object&#39;s &quot;_ls()&quot; method, so you can just simply implement</span>
<span class="sd">    it in your classes</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># ls</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">_ls</span><span class="p">()</span>                                              <span class="c1"># ls</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">folder</span> <span class="o">|</span> <span class="n">_ls</span><span class="p">()</span>                                                  <span class="c1"># ls</span></div>
<span class="k">class</span> <span class="nc">_ls</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                              <span class="c1"># _ls</span>
    <span class="k">def</span> <span class="nf">_typehint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="n">tList</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>                         <span class="c1"># _ls</span>
    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>                                                 <span class="c1"># _ls</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>                                                <span class="c1"># _ls</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>                       <span class="c1"># _ls</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>                                             <span class="c1"># _ls</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>                                         <span class="c1"># _ls</span>
                    <span class="k">if</span> <span class="n">cat</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">eB</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="c1"># list subfiles in a zip file # _ls</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">ZipWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">infolist</span><span class="p">()]</span> <span class="c1"># _ls</span>
                    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is a file, not a folder, so can&#39;t list child directories&quot;</span><span class="p">)</span> <span class="c1"># _ls</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>    <span class="c1"># _ls</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>                                                      <span class="c1"># _ls</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">_ls</span><span class="p">()</span>                                                  <span class="c1"># _ls</span>
<span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;whether to mute extra outputs from clis or not&quot;</span><span class="p">)</span> <span class="c1"># _ls</span>
<span class="n">newline</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                                               <span class="c1"># _ls</span>
<span class="k">class</span> <span class="nc">lazySt</span><span class="p">:</span>                                                                    <span class="c1"># lazySt</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span><span class="nb">bool</span><span class="p">):</span>                                           <span class="c1"># lazySt</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts byte stream into lazy text/byte stream, with nice __repr__.&quot;&quot;&quot;</span> <span class="c1"># lazySt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">;</span>                                          <span class="c1"># lazySt</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># lazySt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>                                                            <span class="c1"># lazySt</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                          <span class="c1"># lazySt</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                        <span class="c1"># lazySt</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>                                         <span class="c1"># lazySt</span>
                <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                                 <span class="c1"># lazySt</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># lazySt</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                          <span class="c1"># lazySt</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>                                        <span class="c1"># lazySt</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>                                         <span class="c1"># lazySt</span>
                <span class="k">yield</span> <span class="n">line</span>                                                       <span class="c1"># lazySt</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">stdout</span><span class="p">();</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span>                           <span class="c1"># lazySt</span>
<span class="k">def</span> <span class="nf">executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>                                        <span class="c1"># executeCmd</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs a command, and returns stdout and stderr streams&quot;&quot;&quot;</span>                  <span class="c1"># executeCmd</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span> <span class="c1"># executeCmd</span>
    <span class="k">if</span> <span class="n">inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                                          <span class="c1"># executeCmd</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span> <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">inp</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">inp</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="c1"># executeCmd</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># executeCmd</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">inp</span><span class="p">:</span>                                                        <span class="c1"># executeCmd</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span> <span class="n">e</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>                   <span class="c1"># executeCmd</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>                      <span class="c1"># executeCmd</span>
                <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="p">);</span> <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                           <span class="c1"># executeCmd</span>
    <span class="n">p</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">lazySt</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">text</span><span class="p">),</span> <span class="n">lazySt</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>    <span class="c1"># executeCmd</span>
<span class="k">def</span> <span class="nf">printStderr</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>                                                            <span class="c1"># printStderr</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>                                             <span class="c1"># printStderr</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="n">err</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>                                                 <span class="c1"># printStderr</span>
        <span class="k">if</span> <span class="n">it</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="n">it</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error encountered:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">k1lib</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">txt</span><span class="o">.</span><span class="n">red</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">stdout</span><span class="p">()</span> <span class="c1"># printStderr</span>
<div class="viewcode-block" id="requireCli"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.requireCli">[docs]</a><span class="k">def</span> <span class="nf">requireCli</span><span class="p">(</span><span class="n">cliTool</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>                                                     <span class="c1"># requireCli</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Searches for a particular cli tool (eg. &quot;ls&quot;), throws ImportError if not</span>
<span class="sd">found, else do nothing&quot;&quot;&quot;</span>                                                        <span class="c1"># requireCli</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">(</span><span class="n">cliTool</span><span class="p">);</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">a</span><span class="p">;</span>                                                  <span class="c1"># requireCli</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;Can&#39;t find cli tool </span><span class="si">{</span><span class="n">cliTool</span><span class="si">}</span><span class="s2">. Please install it first.&quot;&quot;&quot;</span><span class="p">)</span> <span class="c1"># requireCli</span></div>
<div class="viewcode-block" id="cmd"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.cmd">[docs]</a><span class="k">class</span> <span class="nc">cmd</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                              <span class="c1"># cmd</span>
<div class="viewcode-block" id="cmd.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.cmd.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># 0: return (stdout, stderr). 1: return stdout, 2: return stderr # cmd</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs a command, and returns the output line by line. Can pipe in some</span>
<span class="sd">inputs. If no inputs then have to pipe in :data:`None`. Example::</span>

<span class="sd">    # return detailed list of files</span>
<span class="sd">    None | cmd(&quot;ls -la&quot;)</span>
<span class="sd">    # return list of files that ends with &quot;ipynb&quot;</span>
<span class="sd">    None | cmd(&quot;ls -la&quot;) | cmd(&#39;grep ipynb$&#39;)</span>

<span class="sd">It might be tiresome to pipe in :data:`None` all the time. So, you can use &quot;&gt;&quot;</span>
<span class="sd">operator to yield values right away::</span>

<span class="sd">    # prints out first 10 lines of list of files</span>
<span class="sd">    cmd(&quot;ls -la&quot;) &gt; headOut()</span>

<span class="sd">If you&#39;re using Jupyter notebook/lab, then if you were to display a :class:`cmd`</span>
<span class="sd">object, it will print out the outputs. So, a single command ``cmd(&quot;mkdir&quot;)``</span>
<span class="sd">displayed at the end of a cell is enough to trigger creating the directory.</span>

<span class="sd">Reminder that &quot;&gt;&quot; operator in here sort of has a different meaning to that of</span>
<span class="sd">:class:`~k1lib.cli.init.BaseCli`. So you kinda have to becareful about this::</span>

<span class="sd">    # returns a serial cli, cmd not executed</span>
<span class="sd">    cmd(&quot;ls -la&quot;) | deref()</span>
<span class="sd">    # executes cmd with no input stream and pipes output to deref</span>
<span class="sd">    cmd(&quot;ls -la&quot;) &gt; deref()</span>
<span class="sd">    # returns a serial cli</span>
<span class="sd">    cmd(&quot;ls -la&quot;) &gt; grep(&quot;txt&quot;) &gt; headOut()</span>
<span class="sd">    # executes pipeline</span>
<span class="sd">    cmd(&quot;ls -la&quot;) &gt; grep(&quot;txt&quot;) | headOut()</span>

<span class="sd">General advice is, right ater a :class:`cmd`, use &quot;&gt;&quot;, and use &quot;|&quot; everywhere else.</span>

<span class="sd">Let&#39;s see a few more exotic examples. File ``a.sh``:</span>

<span class="sd">.. code-block:: bash</span>

<span class="sd">    #!/bin/bash</span>

<span class="sd">    echo 1; sleep 0.5</span>
<span class="sd">    echo This message goes to stderr &gt;&amp;2</span>
<span class="sd">    echo 2; sleep 0.5</span>
<span class="sd">    echo $(&lt;/dev/stdin)</span>
<span class="sd">    sleep 0.5; echo 3</span>

<span class="sd">Examples::</span>

<span class="sd">    # returns [b&#39;1\\n&#39;, b&#39;2\\n&#39;, b&#39;45\\n&#39;, b&#39;3\\n&#39;] and prints out the error message</span>
<span class="sd">    &quot;45&quot; | cmd(&quot;./a.sh&quot;, text=False) | deref()</span>
<span class="sd">    # returns [b&#39;This message goes to stderr\\n&#39;]</span>
<span class="sd">    &quot;45&quot; | cmd(&quot;./a.sh&quot;, mode=2, text=False) | deref()</span>
<span class="sd">    # returns [[b&#39;1\\n&#39;, b&#39;2\\n&#39;, b&#39;45\\n&#39;, b&#39;3\\n&#39;], [b&#39;This message goes to stderr\\n&#39;]]</span>
<span class="sd">    &quot;45&quot; | cmd(&quot;./a.sh&quot;, mode=0, text=False) | deref()</span>

<span class="sd">Performance-wise, stdout and stderr will yield values right away as soon</span>
<span class="sd">as the process outputs it, so you get real time feedback. However, this will</span>
<span class="sd">convert the entire input into a :class:`bytes` object, and not feed it bit by</span>
<span class="sd">bit lazily, so if you have a humongous input, it might slow you down a little.</span>

<span class="sd">Also, because stdout and stderr yield values right away, it means that if you</span>
<span class="sd">want the operation to be blocking until finished, you have to consume the output::</span>

<span class="sd">    None | cmd(&quot;mkdir abc&quot;)</span>
<span class="sd">    # might fail, because this might get executed before the previous line</span>
<span class="sd">    None | cmd(&quot;echo a&gt;abc/rg.txt&quot;)</span>

<span class="sd">    None | cmd(&quot;mkdir abc&quot;) | ignore()</span>
<span class="sd">    # will succeed, because this will be guaranteed to execute after the previous line</span>
<span class="sd">    None | cmd(&quot;echo a&gt;abc/rg.txt&quot;)</span>

<span class="sd">Settings:</span>
<span class="sd">- cli.quiet: if True, won&#39;t display errors in mode 1</span>

<span class="sd">:param mode: if 0, returns ``(stdout, stderr)``. If 1, returns ``stdout`` and prints</span>
<span class="sd">    ``stderr`` if there are any errors. If 2, returns ``stderr``</span>
<span class="sd">:param text: whether to decode the outputs into :class:`str` or return raw :class:`bytes`</span>
<span class="sd">:param block: whether to wait for the task to finish before returning to Python or not&quot;&quot;&quot;</span> <span class="c1"># cmd</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>                     <span class="c1"># cmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">RunOnce</span><span class="p">()</span>          <span class="c1"># cmd</span></div>
    <span class="k">def</span> <span class="nf">_typehint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignored</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                           <span class="c1"># cmd</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tIter</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="n">tIter</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>                            <span class="c1"># cmd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">tCollection</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>                              <span class="c1"># cmd</span>
        <span class="k">return</span> <span class="n">t</span>                                                                 <span class="c1"># cmd</span>
<div class="viewcode-block" id="cmd.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.cmd.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span> <span class="c1"># cmd</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pipes in lines of input, or if there&#39;s nothing to</span>
<span class="sd">pass, then pass None&quot;&quot;&quot;</span>                                                          <span class="c1"># cmd</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span><span class="o">.</span><span class="n">done</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">executeCmd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">);</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="c1"># cmd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">:</span>                                                           <span class="c1"># cmd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span>                                    <span class="c1"># cmd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span>                                    <span class="c1"># cmd</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>                                <span class="c1"># cmd</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                                          <span class="c1"># cmd</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">printStderr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>       <span class="c1"># cmd</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>                                                      <span class="c1"># cmd</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span>                                          <span class="c1"># cmd</span></div>
    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span> <span class="o">|</span> <span class="bp">self</span> <span class="o">|</span> <span class="n">it</span>                                <span class="c1"># cmd</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># cmd</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span> <span class="o">|</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>                                          <span class="c1"># cmd</span></div>
<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.walk">[docs]</a><span class="k">class</span> <span class="nc">walk</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                             <span class="c1"># walk</span>
<div class="viewcode-block" id="walk.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.walk.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                                                <span class="c1"># walk</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively get all files inside a dictionary.</span>
<span class="sd">Example::</span>

<span class="sd">    # prints out first 10 files</span>
<span class="sd">    &quot;.&quot; | walk() | headOut()&quot;&quot;&quot;</span>                                                  <span class="c1"># walk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>                                                     <span class="c1"># walk</span></div>
<div class="viewcode-block" id="walk.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.walk.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>                                                     <span class="c1"># walk</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">e</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinStreams</span><span class="p">()</span> <span class="c1"># walk</span></div></div>
<div class="viewcode-block" id="urlPath"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.urlPath">[docs]</a><span class="k">def</span> <span class="nf">urlPath</span><span class="p">(</span><span class="n">base</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                                           <span class="c1"># urlPath</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translates from a url to a file path.</span>
<span class="sd">Example::</span>

<span class="sd">    base = &quot;~/ssd/some/other/path&quot;</span>
<span class="sd">    url = &quot;http://example.com/some/path/to/file.txt&quot;</span>
<span class="sd">    url | urlPath(base) # returns &quot;~/ssd/some/other/path/example_com/some/path/to/file.txt&quot;</span>
<span class="sd">    url | urlPath(base, False) # returns &quot;~/ssd/some/other/path/some/path/to/file.txt&quot;</span>

<span class="sd">:param base: base directory you want the files to be in&quot;&quot;&quot;</span>                       <span class="c1"># urlPath</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>                                                    <span class="c1"># urlPath</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>                                                              <span class="c1"># urlPath</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>                                           <span class="c1"># urlPath</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="k">if</span> <span class="n">host</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>                <span class="c1"># urlPath</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">a</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>        <span class="c1"># urlPath</span>
    <span class="k">return</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>                                                         <span class="c1"># urlPath</span></div>
<span class="kn">import</span> <span class="nn">bz2</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">zlib</span>                                                           <span class="c1"># urlPath</span>
<div class="viewcode-block" id="kzip"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kzip">[docs]</a><span class="k">class</span> <span class="nc">kzip</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                             <span class="c1"># kzip</span>
<div class="viewcode-block" id="kzip.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kzip.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;gz&quot;</span><span class="p">):</span>                                                <span class="c1"># kzip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementally compresses a stream of data using gzip or bzip2.</span>
<span class="sd">Example::</span>

<span class="sd">    data = range(100) | apply(lambda x: str(x).encode()) | deref() # list of bytes</span>
<span class="sd">    data | kzip() | deref() # returns list of bytes</span>
<span class="sd">    range(100) | apply(str) | kzip() | deref() # returns list of bytes, demonstrating piping iterator of string works</span>

<span class="sd">Quick reminder that if you pass in bytes iterator then it will be compressed as-is.</span>
<span class="sd">But if you pass in string iterator then it will append a new line character to each</span>
<span class="sd">string and then compress it. This is more intuitive, and it makes the style consistent</span>
<span class="sd">with :class:`~k1lib.cli.output.file`.</span>

<span class="sd">Passing in single string or byte is ok too::</span>

<span class="sd">    &quot;0123456789&quot; | kzip()  # returns gz bytes</span>
<span class="sd">    b&quot;0123456789&quot; | kzip() # returns gz bytes, exact same pattern as above</span>

<span class="sd">Why &quot;kzip&quot; and not just &quot;zip&quot;? Because &quot;zip&quot; is a builtin python keyword.</span>

<span class="sd">See also: :class:`kunzip`</span>

<span class="sd">:param fmt: desired compressed format. Currently only supports &quot;gz&quot; or &quot;bz2&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># kzip</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>                                                     <span class="c1"># kzip</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;gzip&quot;</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span>                                         <span class="c1"># kzip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compressobj</span><span class="p">(</span><span class="n">wbits</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>                                  <span class="c1"># kzip</span>
        <span class="k">elif</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;bzip2&quot;</span> <span class="ow">or</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;bz2&quot;</span><span class="p">:</span>                                     <span class="c1"># kzip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Compressor</span><span class="p">()</span>                                         <span class="c1"># kzip</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File type </span><span class="si">{</span><span class="n">fmt</span><span class="si">}</span><span class="s2"> not supported. Specify either &#39;gz&#39; or &#39;bz2&#39;&quot;</span><span class="p">)</span> <span class="c1"># kzip</span></div>
<div class="viewcode-block" id="kzip.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kzip.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>                                                       <span class="c1"># kzip</span>
        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span>                                                               <span class="c1"># kzip</span>
        <span class="k">def</span> <span class="nf">gen</span><span class="p">():</span>                                                               <span class="c1"># kzip</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>                                                         <span class="c1"># kzip</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">e</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>                     <span class="c1"># kzip</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>                                              <span class="c1"># kzip</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span> <span class="k">yield</span> <span class="n">res</span>                                                <span class="c1"># kzip</span>
            <span class="k">try</span><span class="p">:</span>                                                                 <span class="c1"># kzip</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>                                                  <span class="c1"># kzip</span>
                <span class="k">if</span> <span class="n">res</span><span class="p">:</span> <span class="k">yield</span> <span class="n">res</span>                                                <span class="c1"># kzip</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>                                                         <span class="c1"># kzip</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="n">it</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>                                 <span class="c1"># kzip</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">o</span><span class="o">.</span><span class="n">flush</span><span class="p">()]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">filt</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span> <span class="c1"># kzip</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">gen</span><span class="p">()</span>                                                       <span class="c1"># kzip</span></div></div>
<span class="k">class</span> <span class="nc">decompressobj</span><span class="p">:</span> <span class="c1"># .gz or .bz2 file                                          # decompressobj</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Why not just use zlib.decompressobj() directly? I encountered a strange bug when trying</span>
<span class="sd">to decompress CommonCrawl&#39;s gzip files, posted on Stack Overflow and got help from none</span>
<span class="sd">other than Mark Adler, creator of gzip and zlib. That guy&#39;s super active on Stack Overflow.</span>
<span class="sd">Anyway, this code here is a modified version of his code. Here&#39;s the discussion:</span>
<span class="sd">https://stackoverflow.com/questions/76452480/pythons-zlib-doesnt-work-on-commoncrawl-file</span>
<span class="sd">&quot;&quot;&quot;</span>                                                                              <span class="c1"># decompressobj</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">gz</span> <span class="o">=</span> <span class="n">gz</span>                                    <span class="c1"># decompressobj</span>
    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>                                                       <span class="c1"># decompressobj</span>
        <span class="n">gz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gz</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="n">o</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="o">|</span><span class="mi">32</span><span class="p">)</span> <span class="k">if</span> <span class="n">gz</span> <span class="k">else</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Decompressor</span><span class="p">()</span> <span class="c1"># decompressobj</span>
        <span class="k">for</span> <span class="n">got</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>                                                           <span class="c1"># decompressobj</span>
            <span class="k">yield</span> <span class="n">o</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">got</span><span class="p">);</span> <span class="n">left</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>                           <span class="c1"># decompressobj</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">eof</span><span class="p">:</span> <span class="n">left</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">unused_data</span><span class="p">;</span> <span class="n">o</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompressobj</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">MAX_WBITS</span><span class="o">|</span><span class="mi">32</span><span class="p">)</span> <span class="k">if</span> <span class="n">gz</span> <span class="k">else</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2Decompressor</span><span class="p">()</span> <span class="c1"># decompressobj</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">got</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>                           <span class="c1"># decompressobj</span>
<span class="n">stream_unzip</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;stream_unzip&quot;</span><span class="p">)</span>                                         <span class="c1"># decompressobj</span>
<span class="k">class</span> <span class="nc">decompressobjZip</span><span class="p">:</span> <span class="c1"># .zip files                                             # decompressobjZip</span>
    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>                                                       <span class="c1"># decompressobjZip</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stream_unzip</span><span class="o">.</span><span class="n">stream_unzip</span><span class="p">(</span><span class="n">it</span><span class="p">):</span> <span class="k">yield from</span> <span class="n">c</span><span class="p">;</span> <span class="k">return</span>       <span class="c1"># decompressobjZip</span>
<div class="viewcode-block" id="kunzip"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kunzip">[docs]</a><span class="k">class</span> <span class="nc">kunzip</span><span class="p">(</span><span class="n">BaseCli</span><span class="p">):</span>                                                           <span class="c1"># kunzip</span>
<div class="viewcode-block" id="kunzip.__init__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kunzip.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>                                              <span class="c1"># kunzip</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementally decompress a stream of data using gzip or bzip2.</span>
<span class="sd">Example::</span>

<span class="sd">    # returns an iterator of bytes. cat() command can shorten to cat(&quot;someFile.gz&quot;, False, True)</span>
<span class="sd">    cat(&quot;someFile.gz&quot;, text=False, chunks=True) | unzip()</span>
<span class="sd">    # incrementally fetches remote file, then incrementally unzips it</span>
<span class="sd">    cat(&quot;https://example.com/someFile.gz&quot;, False, True) | unzip()</span>

<span class="sd">    data = range(100) | apply(lambda x: str(x).encode()) | deref() # list of bytes</span>
<span class="sd">    data | kzip() | unzip() | deref() # returns original data in list of bytes. May split the bytes at different positions though</span>

<span class="sd">How does it know which algorithm to pick to decompress? It looks at the</span>
<span class="sd">first few bytes of the file for its magic number. Also, if you&#39;re expecting</span>
<span class="sd">a text file after decompression, you can do this to get the lines directly::</span>

<span class="sd">    # returns iterator of strings</span>
<span class="sd">    cat(&quot;https://example.com/someFile.gz&quot;, False, True) | unzip(True)</span>

<span class="sd">One more thing. If you&#39;re planning to use this to download whole files, you might</span>
<span class="sd">want to tune the chunk size in :data:`~k1lib.settings`.cli.cat.chunkSize as</span>
<span class="sd">it might speed things up considerably to raise it. Or may be you should just</span>
<span class="sd">use wget instead =))</span>

<span class="sd">More examples of the different styles to use this cli::</span>

<span class="sd">    [&quot;abc&quot;] | kzip() | unzip(True) | deref() # returns [&quot;abc&quot;]</span>
<span class="sd">     &quot;abc&quot;  | kzip() | unzip(True)           # returns  &quot;abc&quot;</span>
<span class="sd">     &quot;abc&quot;  | kzip() | unzip()               # returns b&quot;abc&quot;</span>

<span class="sd">See also: :class:`kzip`.</span>

<span class="sd">.. admonition:: Reading files directly</span>

<span class="sd">    The original purpose of this cli is to incrementally decompress a byte stream.</span>
<span class="sd">    But a lot of time, that byte stream is coming from a file, and typing out</span>
<span class="sd">    ``cat(fn, False, True)`` to generate a byte stream to feed into this cli is</span>
<span class="sd">    tedious, so instead, you can pipe in the file name and this will just unzips</span>
<span class="sd">    it and return the string/byte stream to you::</span>

<span class="sd">        &quot;abc.gz&quot;  | unzip() # returns string iterator</span>
<span class="sd">        &quot;abc.bz2&quot; | unzip() # same</span>
<span class="sd">        &quot;abc.zip&quot; | unzip() # returns string iterator from the first subfile only. All subsequent subfiles are ignored</span>

<span class="sd">.. admonition:: .zip files</span>

<span class="sd">    This can also work with subfiles within .zip files, like this::</span>

<span class="sd">        &quot;abc.zip&quot; | unzip()                   # unzips the first subfile</span>
<span class="sd">        &quot;abc.zip&quot; | ls()                      # lists out all subfiles</span>
<span class="sd">        &quot;abc.zip&quot; | ls() | rItem(2) | unzip() # unzips the 3rd subfile</span>

<span class="sd">:param text: whether to yield string lines or bytes&quot;&quot;&quot;</span>                           <span class="c1"># kunzip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>                                                         <span class="c1"># kunzip</span></div>
<div class="viewcode-block" id="kunzip.__ror__"><a class="viewcode-back" href="../../../cli/index.html#k1lib.cli.inp.kunzip.__ror__">[docs]</a>    <span class="k">def</span> <span class="fm">__ror__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">):</span>                                                       <span class="c1"># kunzip</span>
        <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">it</span><span class="p">):</span> <span class="c1"># generates a stream of bytes                               # kunzip</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">);</span> <span class="n">e</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>                                          <span class="c1"># kunzip</span>
            <span class="k">if</span> <span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x1f\x8b</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">o</span> <span class="o">=</span> <span class="n">decompressobj</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># .gz               # kunzip</span>
            <span class="k">elif</span> <span class="n">e</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;BZh&quot;</span><span class="p">:</span> <span class="n">o</span> <span class="o">=</span> <span class="n">decompressobj</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>    <span class="c1"># .bz2             # kunzip</span>
            <span class="k">elif</span> <span class="n">e</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">o</span> <span class="o">=</span> <span class="n">decompressobjZip</span><span class="p">()</span>      <span class="c1"># .zip              # kunzip</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t infer the file type (whether gz or bz2) of this file&quot;</span><span class="p">)</span> <span class="c1"># kunzip</span>
            <span class="k">yield from</span> <span class="p">[[</span><span class="n">e</span><span class="p">],</span> <span class="n">it</span><span class="p">]</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinStreams</span><span class="p">()</span> <span class="o">|</span> <span class="n">o</span>                         <span class="c1"># kunzip</span>
        <span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>                                                           <span class="c1"># kunzip</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">cat</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">kunzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="c1"># special case for reading file names directly # kunzip</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">ZipWrapper</span><span class="p">):</span> <span class="k">return</span> <span class="n">it</span> <span class="o">|</span> <span class="n">cat</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># special case for .zip subfile # kunzip</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span> <span class="n">single</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">it</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span><span class="p">]</span>                       <span class="c1"># kunzip</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>                                                            <span class="c1"># kunzip</span>
            <span class="k">def</span> <span class="nf">gen2</span><span class="p">(</span><span class="n">it</span><span class="p">):</span> <span class="c1"># generates a stream of strings                        # kunzip</span>
                <span class="n">last</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span> <span class="c1"># last split is probably not the right line boundary, so gotta do this # kunzip</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>                                                <span class="c1"># kunzip</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">last</span> <span class="o">+</span> <span class="n">e</span><span class="p">;</span> <span class="n">splits</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>                        <span class="c1"># kunzip</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>                 <span class="c1"># kunzip</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                                            <span class="c1"># kunzip</span>
                <span class="k">yield</span> <span class="n">last</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>                                              <span class="c1"># kunzip</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">gen2</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>                                                       <span class="c1"># kunzip</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">res</span> <span class="o">=</span> <span class="n">gen</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>                                                      <span class="c1"># kunzip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">single</span><span class="p">:</span> <span class="k">return</span> <span class="n">res</span>                                                <span class="c1"># kunzip</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>              <span class="c1"># kunzip</span></div></div>
<span class="n">unzip</span> <span class="o">=</span> <span class="n">kunzip</span>                                                                   <span class="c1"># kunzip</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Quang Ho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>