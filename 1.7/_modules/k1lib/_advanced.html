

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>k1lib._advanced &mdash; k1lib  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            k1lib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../base.html">Base module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli/index.html">k1lib.cli module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../callbacks/index.html">k1lib.callbacks module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../k1a.html">k1lib._k1a module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../k1ui.html">k1lib.k1ui module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../eqn.html">k1lib.eqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fmt.html">k1lib.fmt module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../graphEqn.html">k1lib.graphEqn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imports.html">k1lib.imports module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mo.html">k1lib.mo module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kast.html">k1lib.kast module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kcom.html">k1lib.kcom module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../knn.html">k1lib.knn module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kop.html">k1lib.kop module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kws.html">k1lib.kws module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../p5.html">k1lib.p5 module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schedule.html">k1lib.schedule module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../selector.html">k1lib.selector module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../selen.html">k1lib.selen module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serpent.html">k1lib.serpent module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serve.html">k1lib.serve module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../viz.html">k1lib.viz module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../zircon.html">k1lib.zircon module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../monkey.html">Monkey patched classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelogs.html">Changelogs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">k1lib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">k1lib._advanced</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for k1lib._advanced</h1><div class="highlight"><pre>
<span></span><span class="c1"># AUTOGENERATED FILE! PLEASE DON&#39;T EDIT HERE. EDIT THE SOURCE NOTEBOOKS INSTEAD</span>
<span class="kn">import</span> <span class="nn">k1lib</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">struct</span><span class="o">,</span> <span class="nn">collections</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">contextlib</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">functools</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">random</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">k1lib.cli</span> <span class="k">as</span> <span class="nn">cli</span><span class="p">;</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k1lib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;aes_encrypt&quot;</span><span class="p">,</span> <span class="s2">&quot;aes_decrypt&quot;</span><span class="p">,</span> <span class="s2">&quot;aes_encrypt_json&quot;</span><span class="p">,</span> <span class="s2">&quot;aes_decrypt_json&quot;</span><span class="p">,</span> <span class="s2">&quot;tempObj&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeSeries&quot;</span><span class="p">,</span> <span class="s2">&quot;speed&quot;</span><span class="p">,</span> <span class="s2">&quot;compileCExt&quot;</span><span class="p">]</span>
<span class="n">_logObj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loaded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;logMsgs&quot;</span><span class="p">:</span> <span class="n">deque</span><span class="p">(),</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<span class="k">def</span> <span class="nf">_thTarget</span><span class="p">():</span>                                                                 <span class="c1"># _thTarget</span>
    <span class="kn">import</span> <span class="nn">asyncio</span><span class="o">,</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">json</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">k1lib</span> <span class="kn">import</span> <span class="n">kws</span>                          <span class="c1"># _thTarget</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>                                                            <span class="c1"># _thTarget</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">kws</span><span class="o">.</span><span class="n">WsClient</span><span class="p">(</span><span class="s2">&quot;wss://ws.logs.mlexps.com/_k1_ingest&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span>    <span class="c1"># _thTarget</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                          <span class="c1"># _thTarget</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_logObj</span><span class="p">[</span><span class="s2">&quot;logMsgs&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>       <span class="c1"># _thTarget</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">_logObj</span><span class="p">[</span><span class="s2">&quot;logMsgs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">popleft</span><span class="p">())</span>                <span class="c1"># _thTarget</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>                          <span class="c1"># _thTarget</span>
<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span><span class="s2">&quot;any&quot;</span><span class="p">):</span>                                                    <span class="c1"># log</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logs random debug statements to logs.mlexps.com server.</span>
<span class="sd">Example::</span>

<span class="sd">    k1.log(&quot;ggdrive/topic1&quot;, &quot;some message&quot;)</span>
<span class="sd">    k1.log(&quot;ggdrive/topic1/sub2&quot;, {&quot;some&quot;: &quot;json&quot;, &quot;object&quot;: 2})</span>

<span class="sd">    # I typically do it like this, so that I can filter down only the messages that I want based on severity</span>
<span class="sd">    k1.log(&quot;ggdrive/info&quot;, {&quot;some&quot;: &quot;json&quot;, &quot;object&quot;: 2})</span>
<span class="sd">    k1.log(&quot;ggdrive/error&quot;, {&quot;some&quot;: &quot;json&quot;, &quot;object&quot;: 2})</span>

<span class="sd">Visit the website https://logs.mlexps.com/watch/ggdrive, or</span>
<span class="sd">/watch/ggdrive/topic1, or /watch/ggdrive/topic1/sub2 to view all logs</span>
<span class="sd">coming in.&quot;&quot;&quot;</span>                                                                    <span class="c1"># log</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_logObj</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]:</span> <span class="n">_logObj</span><span class="p">[</span><span class="s2">&quot;loaded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_thTarget</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c1"># log</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>                                   <span class="c1"># log</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>                <span class="c1"># log</span>
    <span class="n">_logObj</span><span class="p">[</span><span class="s2">&quot;logMsgs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>                                   <span class="c1"># log</span>
<span class="k">if</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">startup</span><span class="o">.</span><span class="n">import_optionals</span><span class="p">:</span>                                      <span class="c1"># log</span>
    <span class="k">try</span><span class="p">:</span>                                                                         <span class="c1"># log</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>                                                  <span class="c1"># log</span>
        <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pValue&quot;</span><span class="p">)</span>                                                 <span class="c1"># log</span>
<div class="viewcode-block" id="pValue">
<a class="viewcode-back" href="../../base.html#k1lib.pValue">[docs]</a>
        <span class="k">def</span> <span class="nf">pValue</span><span class="p">(</span><span class="n">zScore</span><span class="p">):</span>                                                      <span class="c1"># log</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;2-sided p value of a particular z score. Requires :mod:`scipy`.&quot;&quot;&quot;</span> <span class="c1"># log</span>
            <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zScore</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span>                                  <span class="c1"># log</span></div>

    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>                                                                 <span class="c1"># log</span>
<span class="k">try</span><span class="p">:</span>                                                                             <span class="c1"># log</span>
    <span class="n">Crypto</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">dep</span><span class="p">(</span><span class="s2">&quot;Crypto&quot;</span><span class="p">,</span> <span class="s2">&quot;pycryptodome&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://pycryptodome.readthedocs.io/en/latest/&quot;</span><span class="p">)</span> <span class="c1"># log</span>
    <span class="k">def</span> <span class="nf">aes_encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">:</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span>                       <span class="c1"># log</span>
    <span class="k">def</span> <span class="nf">aes_decrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">:</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span>                       <span class="c1"># log</span>
    <span class="k">def</span> <span class="nf">aes_encrypt_json</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span>                         <span class="c1"># log</span>
    <span class="k">def</span> <span class="nf">aes_decrypt_json</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="n">Crypto</span><span class="o">.</span><span class="n">Cipher</span>                  <span class="c1"># log</span>
    <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>                                                <span class="c1"># log</span>
    <span class="kn">from</span> <span class="nn">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>                                   <span class="c1"># log</span>
    <span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>                                   <span class="c1"># log</span>
<div class="viewcode-block" id="aes_encrypt">
<a class="viewcode-back" href="../../base.html#k1lib.aes_encrypt">[docs]</a>
    <span class="k">def</span> <span class="nf">aes_encrypt</span><span class="p">(</span><span class="n">plaintext</span><span class="p">:</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>                     <span class="c1"># log</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypts a message using AES.</span>
<span class="sd">Example::</span>

<span class="sd">    res = k1.aes_encrypt(b&quot;some message&quot;) # can return &#39;3HV7PKKQL2DLWQWBBTETQTXNMC4Q6DJ2FSS73A7NCRAX6K4ZZKXQ====&#39;</span>
<span class="sd">    k1.aes_descrypt(res) # returns b&quot;some message&quot;</span>

<span class="sd">After encrypting, this is encoded using base32, ready to be used in urls. This function</span>
<span class="sd">is a convenience function meant for small messages here and there, and is not intended</span>
<span class="sd">for heavy duty encryption.</span>

<span class="sd">The key is automatically generated, and is configurable via ``settings.cred.aes.key``</span>

<span class="sd">See also: :meth:`aes_encrypt_json`</span>

<span class="sd">:param plaintext: plaintext to encrypt</span>
<span class="sd">:param key: 128 bit key, if not specified then will auto generate one on library load at ``settings.cred.aes.key`` &quot;&quot;&quot;</span> <span class="c1"># log</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span> <span class="n">plaintext</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plaintext</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># log</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span> <span class="ow">or</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cred</span><span class="o">.</span><span class="n">aes</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">);</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">))</span> <span class="c1"># log</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">iv</span> <span class="o">+</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="s2">&quot;/_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="s2">&quot;+-&quot;</span><span class="p">)</span> <span class="c1"># log</span></div>

<div class="viewcode-block" id="aes_decrypt">
<a class="viewcode-back" href="../../base.html#k1lib.aes_decrypt">[docs]</a>
    <span class="k">def</span> <span class="nf">aes_decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span><span class="nb">bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>                    <span class="c1"># log</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decrypts a message using AES.</span>
<span class="sd">See :meth:`aes_encrypt` for more information.</span>

<span class="sd">:param ciphertext: ciphertext to decrypt</span>
<span class="sd">:param key: 128 bit key, if not specified then will auto generate one on library load at ``settings.cred.aes.key``&quot;&quot;&quot;</span> <span class="c1"># log</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32decode</span><span class="p">(</span><span class="n">ciphertext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="s2">&quot;-+&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="s2">&quot;_/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">());</span> <span class="n">iv</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="p">[:</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">];</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span> <span class="ow">or</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cred</span><span class="o">.</span><span class="n">aes</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span> <span class="c1"># log</span>
        <span class="k">return</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">[</span><span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">:]),</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span> <span class="c1"># log</span></div>

<div class="viewcode-block" id="aes_encrypt_json">
<a class="viewcode-back" href="../../base.html#k1lib.aes_encrypt_json">[docs]</a>
    <span class="k">def</span> <span class="nf">aes_encrypt_json</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>                                       <span class="c1"># log</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encrypts a Python object using AES.</span>
<span class="sd">Example::</span>

<span class="sd">    a = k1.aes_encrypt_json({&quot;a&quot;: 3})</span>
<span class="sd">    k1.aes_decrypt_json(a) # returns {&quot;a&quot;: 3}</span>

<span class="sd">    k1.aes_decrypt_json(k1.aes_encrypt_json([1, 2, 3])) # returns [1, 2, 3]</span>
<span class="sd">    k1.aes_decrypt_json(k1.aes_encrypt_json(&quot;abc&quot;))     # returns &quot;abc&quot;</span>

<span class="sd">See also: :meth:`aes_encrypt`&quot;&quot;&quot;</span>                                                 <span class="c1"># log</span>
        <span class="k">return</span> <span class="n">aes_encrypt</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>                             <span class="c1"># log</span></div>

<div class="viewcode-block" id="aes_decrypt_json">
<a class="viewcode-back" href="../../base.html#k1lib.aes_decrypt_json">[docs]</a>
    <span class="k">def</span> <span class="nf">aes_decrypt_json</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>                                <span class="c1"># log</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">aes_decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>                      <span class="c1"># log</span></div>

    <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cred</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;aes&quot;</span><span class="p">,</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="n">get_random_bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="s2">&quot;16-byte aes key, used in aes_encrypt() and aes_decrypt()&quot;</span><span class="p">,</span> <span class="n">sensitive</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s2">&quot;anything related to AES block cipher&quot;</span><span class="p">)</span> <span class="c1"># log</span>
<span class="k">except</span><span class="p">:</span> <span class="k">pass</span>                                                                     <span class="c1"># log</span>
<span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;tempObjLifetime&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;Default lifetime in seconds used in k1.tempObj()&quot;</span><span class="p">);</span> <span class="c1"># log</span>
<span class="n">_tempObjs</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">_tempTimeouts</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">_tempObj_autoInc</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;_k1_tempObj_&quot;</span><span class="p">)</span> <span class="c1"># log</span>
<div class="viewcode-block" id="tempObj">
<a class="viewcode-back" href="../../base.html#k1lib.tempObj">[docs]</a>
<span class="k">def</span> <span class="nf">tempObj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>                                                    <span class="c1"># tempObj</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores an object that&#39;s meant to exist for a short amount of time,</span>
<span class="sd">and then will be automatically deleted. Example::</span>

<span class="sd">    key = k1.tempObj(&quot;Suika Ibuki&quot;, 10) # stores some string that will only last for 10 seconds</span>
<span class="sd">    k1.tempObj(key)                     # returns &quot;Suika Ibuki&quot;</span>
<span class="sd">    time.sleep(20)</span>
<span class="sd">    k1.tempObj(key)                     # returns None</span>

<span class="sd">The default timeout value is 60 seconds, configurable in :data:`~k1lib.settings`.tempObjLifetime&quot;&quot;&quot;</span> <span class="c1"># tempObj</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_k1_tempObj_&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="n">_tempObjs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># tempObj</span>
    <span class="k">else</span><span class="p">:</span>                                                                        <span class="c1"># tempObj</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">_tempObj_autoInc</span><span class="p">()</span>                                                   <span class="c1"># tempObj</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">k1lib</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">tempObjLifetime</span>             <span class="c1"># tempObj</span>
        <span class="n">_tempObjs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="n">_tempTimeouts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span> <span class="k">return</span> <span class="n">k</span>     <span class="c1"># tempObj</span></div>

<span class="k">def</span> <span class="nf">tempCleanupThread</span><span class="p">():</span>                                                         <span class="c1"># tempCleanupThread</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>                                                                  <span class="c1"># tempCleanupThread</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>                                                        <span class="c1"># tempCleanupThread</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_tempTimeouts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>                                  <span class="c1"># tempCleanupThread</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">:</span> <span class="k">del</span> <span class="n">_tempObjs</span><span class="p">[</span><span class="n">k</span><span class="p">];</span> <span class="k">del</span> <span class="n">_tempTimeouts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>                   <span class="c1"># tempCleanupThread</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                                                            <span class="c1"># tempCleanupThread</span>
<span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">tempCleanupThread</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>                  <span class="c1"># tempCleanupThread</span>
<span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">;</span> <span class="n">_timeSeriesD</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">_timeSeriesID</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">_timeSeriesAutoInc</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;_k1_ts_&quot;</span><span class="p">);</span> <span class="n">_timeSeriesIdxAutoInc</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">()</span> <span class="c1"># tempCleanupThread</span>
<div class="viewcode-block" id="TimeSeries">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries">[docs]</a>
<span class="k">class</span> <span class="nc">TimeSeries</span><span class="p">:</span>                                                                <span class="c1"># TimeSeries</span>
<div class="viewcode-block" id="TimeSeries.__init__">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storeRaw</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retention</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">7</span><span class="o">*</span><span class="mi">86400</span><span class="p">,</span> <span class="n">coldStore</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Manages time series data, compresses them, back them up on disk if necessary.</span>
<span class="sd">Example::</span>

<span class="sd">    ts1 = k1.TimeSeries(name=&quot;ts1&quot;)</span>
<span class="sd">    ts1.append(3, 4, 5) # do this anywhere you&#39;d like. This saves 1 data point containing 3 floats to the sqlite database</span>

<span class="sd">    for i in range(600): # deposits 600 samples over 1 minute time span</span>
<span class="sd">        ts1.append(random.random(), random.random(), random.random())</span>
<span class="sd">        time.sleep(0.1)</span>

<span class="sd">    ts1.getRaw()  # returns something like [[1737213223.4139452, (3, 4, 5)], ...]</span>
<span class="sd">    ts1.getRate() # returns something like [(1737213313.0752494, 10.066128035852211), ...]</span>
<span class="sd">    ts1.getPert() # returns something like [[1737213568.9260075, [(0.009, 0.07, 0.47, 0.89, 0.99), (0.001, 0.11, 0.56, 0.90, 0.99), (0.0006, 0.08, 0.46, 0.89, 0.99)]], ...]</span>

<span class="sd">For :meth:`getRate`, first number is the timestamp, second is the number of data points/second.</span>
<span class="sd">For :meth:`getPert`, this will return the percentiles of the input data (0%, 10%, 50%, 90%, 100%) for each variable</span>

<span class="sd">Why does this functionality exists? Well, it&#39;s because managing time series usually involves</span>
<span class="sd">a lot of pain. You need to setup a time series database like Prometheus, or Postgresql to be</span>
<span class="sd">extra simple. But setting up all that infrastructure takes a lot of effort, and again, if it&#39;s</span>
<span class="sd">hard, you won&#39;t do it, or will be incentivised not to do it. So this class is meant to be an</span>
<span class="sd">object that manages time series data. It manages it in such a way so that you can spam this</span>
<span class="sd">all over the place and get lots of functionalities right out of the box, without an external</span>
<span class="sd">server. All data is stored in several tables inside a sqlite file. Each time series gets its</span>
<span class="sd">own sqlite file. Some performance numbers to keep in mind:</span>

<span class="sd">- Data write speed: 100k data points/s</span>
<span class="sd">- Data read speed:  400k data points/s</span>
<span class="sd">- Disk space used: 50 bytes/data point for small amounts of variables (say ~3)</span>

<span class="sd">Other features include the ability to auto delete old data so as not to accumulate over time.</span>
<span class="sd">When old data is deleted, there&#39;s also an option to save the deleted data in a separate file</span>
<span class="sd">for cold storage, so that it&#39;s more efficient storage-wise than sqlite, but harder to access.</span>
<span class="sd">Cold storage space used: 14 + nVars * 4. This is 5x smaller than sqlite for 3 variables</span>

<span class="sd">There will be scans every 10 seconds on another thread, that compresses the raw data into a</span>
<span class="sd">usable form. If there&#39;s too few data points (&lt;20 data points), then it will skip that scan</span>
<span class="sd">cycle. Data (refined and raw) will be saved into a sqlite database, stored at the specified</span>
<span class="sd">file name ``fn``. If no file name is specified, then this will create a temp file and turn</span>
<span class="sd">that into a sqlite database.</span>

<span class="sd">For every method, you can also specify an index number::</span>

<span class="sd">    ts1 = k1.TimeSeries(name=&quot;ts1&quot;)</span>
<span class="sd">    ts1.appendIdx(2, 3, 4, 5) # index 2 with 3 values (3, 4, 5)</span>

<span class="sd">    ts1.getRaw(idx=2)  # returns all data points with idx=2, something like [[1737213223.4139452, (3, 4, 5)], ...]</span>
<span class="sd">    ts1.getPert(idx=2) # returns all percentiles with idx=2, something like [[1737213568.9260075, [(0.009, 0.07, 0.47, 0.89, 0.99), (0.001, 0.11, 0.56, 0.90, 0.99), (0.0006, 0.08, 0.46, 0.89, 0.99)]], ...]</span>

<span class="sd">This is useful in situations like when you have lots of sensors for different devices. Then</span>
<span class="sd">each idx can be the device id, and so you can store lots of variables in 1 go for 1 specific</span>
<span class="sd">device. Then you can query the time series later on for 1 specific device only.</span>

<span class="sd">You can get all TimeSeries via :meth:`allData`.</span>

<span class="sd">.. note::</span>

<span class="sd">    Performance details</span>

<span class="sd">    This is a more detailed section going over what actually happens underneath in case you</span>
<span class="sd">    care about performance. Everything is stored in sqlite. If file name is not given, then</span>
<span class="sd">    it still uses sqlite, but in memory instead.</span>

<span class="sd">    When a new .append() happens, no database interaction happens at all. It&#39;s simply just</span>
<span class="sd">    appended to a totally normal, internal list, so &lt;1us. Then there are 2 background</span>
<span class="sd">    threads to help collate and store the data. One is fast (10s scan) and one is slow</span>
<span class="sd">    (60s scan). The fast one distributes new data points to 3 internal stacks, &quot;rawRaw&quot;,</span>
<span class="sd">    &quot;rateRaw&quot; and &quot;pertD&quot;. If rawRaw has any elements, it will be stored in sqlite. If</span>
<span class="sd">    rateRaw has at least 10 elements, it will calculate the rate and store in sqlite. If</span>
<span class="sd">    pertD (indexed by idx) has at least 100 elements, it will calculate percentiles and</span>
<span class="sd">    store in sqlite.</span>

<span class="sd">    This architecture has several ramifications:</span>

<span class="sd">    * Time taken to execute .append() is very fast</span>
<span class="sd">    * If no .append() are called for a long time, no sqlite queries will be executed</span>
<span class="sd">    * If too little .append() are called, data might not show up in rate and percentile views at all</span>
<span class="sd">    * Might have to wait for at least 10 seconds before .getRaw() has the newest data</span>
<span class="sd">    * If python process exited, there may still be data stored in memory that&#39;s not recorded on sqlite yet</span>

<span class="sd">    For the second loop, it grabs all rows from sqlite that was longer than ``retention``</span>
<span class="sd">    seconds ago, compresses them to an efficient binary format, then appends to the cold</span>
<span class="sd">    storage file. My code is not as bulletproof as sqlite, but still works fine. Because</span>
<span class="sd">    the loop is very slow, it shouldn&#39;t affect performance much.</span>

<span class="sd">:param name: just for cosmetic, to remind you what this does</span>
<span class="sd">:param fn: sqlite file name to store this time series data. If not specified, then stores database in memory</span>
<span class="sd">:param storeRaw: whether to store raw data points</span>
<span class="sd">:param retention: seconds before deleting old data point permanently, default 1 week</span>
<span class="sd">:param coldStore: if True, when data points past retention time, it will be</span>
<span class="sd">    packed into a single binary file for cold storage&quot;&quot;&quot;</span>                         <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">coldStore</span> <span class="ow">and</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;If using cold storage, has to specify file name!&quot;</span><span class="p">)</span> <span class="c1"># TODO: ts1 | aS(repr), ts1 | toHtml() # TimeSeries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">_timeSeriesAutoInc</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">_timeSeriesIdxAutoInc</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeRaw</span> <span class="o">=</span> <span class="n">storeRaw</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">retention</span> <span class="o">=</span> <span class="n">retention</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coldStore</span> <span class="o">=</span> <span class="n">coldStore</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbLock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t have forward slash in the name&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_timeSeriesD</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has appeared before. Please use a different name&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rawRaw</span> <span class="o">=</span> <span class="p">[];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rateRaw</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">_timeSeriesD</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_timeSeriesID</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setupDb</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pertD</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[]);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># maps idx -&gt; [time, values] # TimeSeries</span></div>

    <span class="k">def</span> <span class="nf">_setupDb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                          <span class="c1"># TimeSeries</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>                                                             <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.db&quot;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.db&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lite&quot;</span><span class="p">)[</span><span class="s2">&quot;default&quot;</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRaw</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRate</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbPert</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;pert&quot;</span><span class="p">]</span> <span class="c1"># TimeSeries</span>
        <span class="k">else</span><span class="p">:</span>                                                                    <span class="c1"># TimeSeries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span> <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">.db&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lite&quot;</span><span class="p">)[</span><span class="s2">&quot;default&quot;</span><span class="p">];</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE rate (id INTEGER PRIMARY KEY AUTOINCREMENT, time INTEGER, rate REAL);&quot;</span><span class="p">);</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX rate_time ON rate (time);&quot;</span><span class="p">);</span> <span class="c1"># TimeSeries</span>
            <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE raw (id INTEGER PRIMARY KEY AUTOINCREMENT, time INTEGER, idx INTEGER, data BLOB);&quot;</span><span class="p">);</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX raw_time ON raw (time);&quot;</span><span class="p">);</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX raw_idx ON raw (idx);&quot;</span><span class="p">);</span> <span class="c1"># .data is struct.pack(&quot;ffff&quot;, values) # TimeSeries</span>
            <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE pert (id INTEGER PRIMARY KEY AUTOINCREMENT, time INTEGER, idx INTEGER, data BLOB);&quot;</span><span class="p">);</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX pert_time ON pert (time);&quot;</span><span class="p">);</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;CREATE INDEX pert_idx ON pert (idx);&quot;</span><span class="p">);</span> <span class="c1"># .data is struct.pack of [*n*[0, 10, 50, 90, 100]] # TimeSeries</span>
            <span class="k">while</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;pert&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>                 <span class="c1"># TimeSeries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbRaw</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbPert</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;pert&quot;</span><span class="p">];</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRate</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="c1"># TimeSeries</span>
<div class="viewcode-block" id="TimeSeries.allData">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.allData">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">allData</span><span class="p">():</span> <span class="k">return</span> <span class="n">_timeSeriesD</span>                                           <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.allIData">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.allIData">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">allIData</span><span class="p">():</span> <span class="k">return</span> <span class="n">_timeSeriesID</span>                                         <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.idxs">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.idxs">[docs]</a>
    <span class="nd">@k1</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ts_idxs&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="s2">&quot;caches k1.TimeSeries idxs, aka all available idx&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;list[int]&quot;</span><span class="p">:</span>                                               <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs all available idxs&quot;&quot;&quot;</span>                                           <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeRaw</span><span class="p">:</span> <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select distinct idx from raw&quot;</span><span class="p">)]</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbPert</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select distinct idx from pert&quot;</span><span class="p">)]</span> <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.append">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span> <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_time</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)]);</span> <span class="k">return</span> <span class="n">values</span> <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.appendIdx">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.appendIdx">[docs]</a>
    <span class="k">def</span> <span class="nf">appendIdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span> <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_time</span><span class="p">(),</span> <span class="n">idx</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">)]);</span> <span class="k">return</span> <span class="n">values</span> <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.getRaw">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.getRaw">[docs]</a>
    <span class="k">def</span> <span class="nf">getRaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span> <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs raw data of this time series. Returns something like ``[[1737213223.4139452, (3, 4, 5)], ...]`` &quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeRaw</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;.storeRaw is False, so all raw data has been deleted&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select time, data from raw where idx = </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>                      <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">startTime</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time &gt;= </span><span class="si">{</span><span class="n">startTime</span><span class="si">}</span><span class="s2">&quot;</span>                           <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">stopTime</span><span class="p">:</span>  <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time &lt;  </span><span class="si">{</span><span class="n">stopTime</span><span class="si">}</span><span class="s2">&quot;</span>                            <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; order by time limit </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>        <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>                                             <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;f&quot;</span><span class="p">;</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>                                   <span class="c1"># TimeSeries</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># fast way, caches &quot;s&quot; computation                                  # TimeSeries</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vs</span><span class="p">)])</span>             <span class="c1"># TimeSeries</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># slow way, in case number of variables are different            # TimeSeries</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">vs</span><span class="p">)])</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">res</span>                                                               <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.getRate">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.getRate">[docs]</a>
    <span class="k">def</span> <span class="nf">getRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>   <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs data ingest rate of this time series. Returns something like ``[(1737213313.0752494, 10.066128035852211), ...]``&quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select time, rate from rate where true&quot;</span>                            <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">startTime</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time &gt;= </span><span class="si">{</span><span class="n">startTime</span><span class="si">}</span><span class="s2">&quot;</span>                           <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">stopTime</span><span class="p">:</span>  <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time  &lt;  </span><span class="si">{</span><span class="n">stopTime</span><span class="si">}</span><span class="s2">&quot;</span>                           <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; order by time limit </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRate</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>       <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">data</span>                                                              <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.getPert">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.getPert">[docs]</a>
    <span class="k">def</span> <span class="nf">getPert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span> <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grabs data percentiles of this time series. Returns something like ``[[1737213568.9260075, [(0.009, 0.07, 0.47, 0.89, 0.99), (0.001, 0.11, 0.56, 0.90, 0.99), (0.0006, 0.08, 0.46, 0.89, 0.99)]], ...]``&quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">_batched</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">5</span><span class="p">)]</span>       <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select time, data from pert where idx = </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>                     <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">startTime</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time &gt;= </span><span class="si">{</span><span class="n">startTime</span><span class="si">}</span><span class="s2">&quot;</span>                           <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">stopTime</span><span class="p">:</span>  <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; and time &lt;  </span><span class="si">{</span><span class="n">stopTime</span><span class="si">}</span><span class="s2">&quot;</span>                            <span class="c1"># TimeSeries</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; order by time limit </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbPert</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>       <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>                                             <span class="c1"># TimeSeries</span>
        <span class="n">nvars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="mi">4</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">nvars</span><span class="o">*</span><span class="s2">&quot;f&quot;</span><span class="p">;</span> <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>                      <span class="c1"># TimeSeries</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># fast way, caches &quot;s&quot; computation                                  # TimeSeries</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">vs</span><span class="p">);</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvars</span><span class="o">//</span><span class="mi">5</span><span class="p">)]])</span> <span class="c1"># TimeSeries</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># slow way, in case number of variables are different between lines # TimeSeries</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="n">vs</span><span class="p">);</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="mi">5</span><span class="p">)]])</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">res</span>                                                               <span class="c1"># TimeSeries</span></div>

    <span class="k">def</span> <span class="nf">_ls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRaw</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>                                 <span class="c1"># TimeSeries</span>
    <span class="nd">@k1</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ts_len&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="s2">&quot;caches k1.TimeSeries lengths&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>                                                           <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">storeRaw</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TimeSeries &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.storeRaw is False, no length available&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select max(id) from raw limit 1;&quot;&quot;&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;TimeSeries name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; fn=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&#39; storeRaw=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storeRaw</span><span class="si">}</span><span class="s2"> retention=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">retention</span><span class="si">}</span><span class="s2"> coldStore=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coldStore</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="c1"># TimeSeries</span>
<div class="viewcode-block" id="TimeSeries.plotRaw">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.plotRaw">[docs]</a>
    <span class="k">def</span> <span class="nf">plotRaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>          <span class="c1"># TimeSeries</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getRaw</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cli</span><span class="o">.</span><span class="n">iden</span><span class="p">()))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">with</span> <span class="n">k1</span><span class="o">.</span><span class="n">mplLock</span><span class="p">:</span>                                                         <span class="c1"># TimeSeries</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;No data available&quot;</span>                        <span class="c1"># TimeSeries</span>
            <span class="k">if</span> <span class="n">dIdx</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="n">data</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">dplot</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">ignore</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">data</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">rItem</span><span class="p">(</span><span class="n">dIdx</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">dplot</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">)</span>     <span class="c1"># TimeSeries</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, idx </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, dIdx </span><span class="si">{</span><span class="n">dIdx</span><span class="si">}</span><span class="s2">, window </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toImg</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">im</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">()</span>                                                 <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.splotRaw">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.splotRaw">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">splotRaw</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>         <span class="c1"># TimeSeries</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">allData</span><span class="p">();</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No TimeSeries with the name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>       <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">plotRaw</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.plotRate">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.plotRate">[docs]</a>
    <span class="k">def</span> <span class="nf">plotRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>                            <span class="c1"># TimeSeries</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getRate</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span> <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cli</span><span class="o">.</span><span class="n">iden</span><span class="p">())</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">with</span> <span class="n">k1</span><span class="o">.</span><span class="n">mplLock</span><span class="p">:</span>                                                         <span class="c1"># TimeSeries</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;No data available&quot;</span>                        <span class="c1"># TimeSeries</span>
            <span class="n">data</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">dplot</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (calls/s)&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, window </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toImg</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">im</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">()</span>                                                 <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.splotRate">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.splotRate">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">splotRate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>                           <span class="c1"># TimeSeries</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">allData</span><span class="p">();</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No TimeSeries with the name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>       <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">plotRate</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                          <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.plotPert">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.plotPert">[docs]</a>
    <span class="k">def</span> <span class="nf">plotPert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>            <span class="c1"># TimeSeries</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getPert</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">dIdx</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toMean</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">window</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cli</span><span class="o">.</span><span class="n">iden</span><span class="p">()))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">with</span> <span class="n">k1</span><span class="o">.</span><span class="n">mplLock</span><span class="p">:</span>                                                         <span class="c1"># TimeSeries</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;No data available&quot;</span>                        <span class="c1"># TimeSeries</span>
            <span class="n">data</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">dplot</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">ignore</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;0%&quot;</span><span class="p">,</span> <span class="s2">&quot;10%&quot;</span><span class="p">,</span> <span class="s2">&quot;50%&quot;</span><span class="p">,</span> <span class="s2">&quot;90%&quot;</span><span class="p">,</span> <span class="s2">&quot;100%&quot;</span><span class="p">]);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percentile &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, idx </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, dIdx </span><span class="si">{</span><span class="n">dIdx</span><span class="si">}</span><span class="s2">, window </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toImg</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">im</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">()</span>                                                 <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.splotPert">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.splotPert">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">splotPert</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>           <span class="c1"># TimeSeries</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">allData</span><span class="p">();</span> <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                       <span class="c1"># TimeSeries</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No TimeSeries with the name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>       <span class="c1"># TimeSeries</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">plotPert</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">stopTime</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>          <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.flask">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.flask">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># TimeSeries</span>
    <span class="k">def</span> <span class="nf">flask</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                                                    <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches a TimeSeries management plane to a flask app.</span>
<span class="sd">Example::</span>

<span class="sd">    app = flask.Flask(__name__)</span>
<span class="sd">    k1.TimeSeries.flask(app)</span>
<span class="sd">    app.run(host=&quot;0.0.0.0&quot;, port=80)</span>

<span class="sd">Then, you can access the route &quot;/k1/ts&quot; to see an overview of all TimeSeries</span>

<span class="sd">:param app: flask app object</span>
<span class="sd">:param kwargs: extra random kwargs that you want to add to ``app.route()`` function&quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="n">bootstrapJs</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">async function dynamicLoad(selector, endpoint, rawHtml=null) { // loads a remote endpoint containing html and put it to the selected element. If .rawHtml is available, then don&#39;t send any request, and just use that html directly</span>
<span class="s2">    const elem = document.querySelector(selector); elem.innerHTML = rawHtml ? rawHtml : (await (await fetch(endpoint)).text());</span>
<span class="s2">    await new Promise(r =&gt; setTimeout(r, 100)); let currentScript = &quot;&quot;;</span>
<span class="s2">    try { for (const script of elem.getElementsByTagName(&quot;script&quot;)) { currentScript = script.innerHTML; eval(script.innerHTML); }</span>
<span class="s2">    } catch (e) { console.log(`Error encountered: `, e, e.stack, currentScript); }</span>
<span class="s2">}&quot;&quot;&quot;</span><span class="p">;</span> <span class="n">bootstrapHtml</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;head&gt;</span>
<span class="s2">    &lt;meta charset=&quot;UTF-8&quot;&gt;&lt;title&gt;DHCP low level server&lt;/title&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span>
<span class="s2">    &lt;link href=&quot;https://static.aigu.vn/daisyui.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;</span>
<span class="s2">    &lt;style&gt;</span>
<span class="s2">        h1 </span><span class="se">{{</span><span class="s2"> font-size: 2.25rem !important; line-height: 2.5rem !important; </span><span class="se">}}</span>
<span class="s2">        h2 </span><span class="se">{{</span><span class="s2"> font-size: 1.5rem !important; line-height: 2rem !important; margin: 10px 0px !important; </span><span class="se">}}</span>
<span class="s2">        h3 </span><span class="se">{{</span><span class="s2"> font-size: 1.125rem !important; line-height: 1.75rem !important; margin: 6px 0px !important; </span><span class="se">}}</span>
<span class="s2">        textarea </span><span class="se">{{</span><span class="s2"> border: 1px solid; padding: 8px 12px !important; border-radius: 10px !important; </span><span class="se">}}</span>
<span class="s2">        body </span><span class="se">{{</span><span class="s2"> padding: 12px; </span><span class="se">}}</span>
<span class="s2">    &lt;/style&gt;&lt;script&gt;</span><span class="si">{</span><span class="n">bootstrapJs</span><span class="si">}</span><span class="s2">&lt;/script&gt;</span>
<span class="s2">&lt;/head&gt;&quot;&quot;&quot;</span><span class="p">;</span> <span class="n">tss</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">allData</span><span class="p">()</span>                                        <span class="c1"># TimeSeries</span>
        <span class="c1"># time series stuff                                                      # TimeSeries</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/ts&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                                           <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">ts_index</span><span class="p">():</span>                                                          <span class="c1"># TimeSeries</span>
            <span class="n">pre</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">_jsDAuto</span><span class="p">();</span> <span class="n">ui1</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">:</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">storeRaw</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">retention</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">coldStore</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">tryout</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="nb">len</span><span class="p">))])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">toJsFunc</span><span class="p">(</span><span class="s2">&quot;term&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{term}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">Table</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">,</span> <span class="s2">&quot;storeRaw&quot;</span><span class="p">,</span> <span class="s2">&quot;retention&quot;</span><span class="p">,</span> <span class="s2">&quot;coldStore&quot;</span><span class="p">,</span> <span class="s2">&quot;#hits&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">onclickFName</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_select&quot;</span><span class="p">,</span> <span class="n">selectable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sortF</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">interface</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">()</span> <span class="c1"># TimeSeries</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="n">bootstrapHtml</span><span class="si">}</span><span class="s2">&lt;h1&gt;TimeSeries&lt;/h1&gt;&lt;div style=&quot;overflow-x: auto; margin-top: 12px&quot;&gt;</span><span class="si">{</span><span class="n">ui1</span><span class="si">}</span><span class="s2">&lt;/div&gt;&lt;div id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_details&quot;&gt;&lt;/div&gt;</span>
<span class="s2">    &lt;script&gt;</span><span class="se">\n</span><span class="s2">function </span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_select(row, i, e) </span><span class="se">{{</span><span class="s2"> dynamicLoad(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_details&quot;, `/k1/ts/$</span><span class="se">{{</span><span class="s2">row[0]</span><span class="se">}}</span><span class="s2">/fragment`); </span><span class="se">}}</span><span class="s2">&lt;/script&gt;&quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/ts/&lt;name&gt;/fragment&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                           <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">ts_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>                                                       <span class="c1"># TimeSeries</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">tss</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>                                              <span class="c1"># TimeSeries</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;No TimeSeries &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; found&quot;</span>                 <span class="c1"># TimeSeries</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">idxs</span><span class="p">();</span> <span class="n">pre</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">_jsDAuto</span><span class="p">();</span> <span class="n">ui1</span> <span class="o">=</span> <span class="n">idxs</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">toJsFunc</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{idx}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">sortF</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">interface</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">();</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;h2&gt;TimeSeries &#39;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&lt;/h2&gt;&lt;div style=&quot;border: 1px solid black; padding: 8px&quot;&gt;</span><span class="si">{</span><span class="n">ui1</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;div style=&quot;display: grid; grid-template-columns: auto auto; row-gap: 8px; column-gap: 8px; align-items: center; margin-top: 12px; width: fit-content&quot;&gt;</span>
<span class="s2">    &lt;div&gt;idx: &lt;/div&gt;&lt;input id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_idx&quot; class=&quot;input input-bordered&quot; value=&quot;0&quot; /&gt;</span>
<span class="s2">    &lt;div&gt;dIdx: &lt;/div&gt;&lt;input id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_dIdx&quot; class=&quot;input input-bordered&quot; value=&quot;0&quot; /&gt;</span>
<span class="s2">    &lt;div&gt;timeStr: &lt;/div&gt;&lt;input id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_timeStr&quot; class=&quot;input input-bordered&quot; value=&quot;1 day&quot; /&gt;</span>
<span class="s2">    &lt;div&gt;window: &lt;/div&gt;&lt;input id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_window&quot; class=&quot;input input-bordered&quot; value=&quot;1&quot; /&gt;</span>
<span class="s2">&lt;/div&gt;&lt;button id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_graphBtn&quot; class=&quot;btn&quot; style=&quot;margin-top: 8px&quot;&gt;Graph&lt;/button&gt;&lt;div id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsRaw&quot;&gt;&lt;/div&gt;&lt;div id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsRate&quot;&gt;&lt;/div&gt;&lt;div id=&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsPert&quot;&gt;&lt;/div&gt;</span>
<span class="s2">&lt;script&gt;</span>
<span class="s2">    (async () =&gt; </span><span class="se">{{</span>
<span class="s2">        let dS = (x) =&gt; document.querySelector(x); dS(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_graphBtn&quot;).onclick = async () =&gt; </span><span class="se">{{</span>
<span class="s2">            let idx  = dS(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_idx&quot;).value; let dIdx = dS(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_dIdx&quot;).value; let window = dS(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_window&quot;).value; let timeStr = dS(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_timeStr&quot;).value;</span>
<span class="s2">            dynamicLoad(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsRaw&quot;,  `/k1/ts/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/fragment/$</span><span class="se">{{</span><span class="s2">idx</span><span class="se">}}</span><span class="s2">/raw/$</span><span class="se">{{</span><span class="s2">dIdx</span><span class="se">}}</span><span class="s2">/$</span><span class="se">{{</span><span class="s2">window</span><span class="se">}}</span><span class="s2">/$</span><span class="se">{{</span><span class="s2">timeStr</span><span class="se">}}</span><span class="s2">`);</span>
<span class="s2">            dynamicLoad(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsRate&quot;, `/k1/ts/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/fragment/0/rate/0/$</span><span class="se">{{</span><span class="s2">window</span><span class="se">}}</span><span class="s2">/$</span><span class="se">{{</span><span class="s2">timeStr</span><span class="se">}}</span><span class="s2">`);</span>
<span class="s2">            if (dIdx !== &quot;all&quot;) dynamicLoad(&quot;#</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_detailsPert&quot;, `/k1/ts/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/fragment/$</span><span class="se">{{</span><span class="s2">idx</span><span class="se">}}</span><span class="s2">/pert/$</span><span class="se">{{</span><span class="s2">dIdx</span><span class="se">}}</span><span class="s2">/$</span><span class="se">{{</span><span class="s2">window</span><span class="se">}}</span><span class="s2">/$</span><span class="se">{{</span><span class="s2">timeStr</span><span class="se">}}</span><span class="s2">`);</span>
<span class="s2">        </span><span class="se">}}</span>
<span class="s2">    </span><span class="se">}}</span><span class="s2">)();</span>
<span class="s2">&lt;/script&gt;&quot;&quot;&quot;</span>                                                                     <span class="c1"># TimeSeries</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/ts/&lt;name&gt;/fragment/&lt;int:idx&gt;/raw/&lt;dIdx&gt;/&lt;int:window&gt;/&lt;timeStr&gt;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">ts_raw</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dIdx</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">timeStr</span><span class="p">):</span> <span class="k">return</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">splotRaw</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">k1</span><span class="o">.</span><span class="n">parseTimeStr</span><span class="p">(</span><span class="n">timeStr</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span> <span class="k">if</span> <span class="n">dIdx</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">dIdx</span><span class="p">),</span> <span class="n">window</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/ts/&lt;name&gt;/fragment/0/rate/0/&lt;int:window&gt;/&lt;timeStr&gt;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">ts_rate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">timeStr</span><span class="p">):</span> <span class="k">return</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">splotRate</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">k1</span><span class="o">.</span><span class="n">parseTimeStr</span><span class="p">(</span><span class="n">timeStr</span><span class="p">),</span> <span class="n">window</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/ts/&lt;name&gt;/fragment/&lt;int:idx&gt;/pert/&lt;int:dIdx&gt;/&lt;int:window&gt;/&lt;timeStr&gt;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
        <span class="k">def</span> <span class="nf">ts_pert</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dIdx</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">timeStr</span><span class="p">):</span> <span class="k">return</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="o">.</span><span class="n">splotPert</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">k1</span><span class="o">.</span><span class="n">parseTimeStr</span><span class="p">(</span><span class="n">timeStr</span><span class="p">),</span> <span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span> <span class="k">if</span> <span class="n">dIdx</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">dIdx</span><span class="p">),</span> <span class="n">window</span><span class="p">)</span> <span class="c1"># TimeSeries</span></div>

<div class="viewcode-block" id="TimeSeries.dummyLoad">
<a class="viewcode-back" href="../../base.html#k1lib.TimeSeries.dummyLoad">[docs]</a>
    <span class="k">def</span> <span class="nf">dummyLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>                                    <span class="c1"># TimeSeries</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulates a dummy load on this time series. Read source of</span>
<span class="sd">this method to understand what it does.</span>

<span class="sd">:param niter: number of iterations</span>
<span class="sd">:param frac: fraction of new random numbers and extra time to wait. 0 for more deterministic, 1 for more chaotic&quot;&quot;&quot;</span> <span class="c1"># TimeSeries</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">();</span> <span class="n">b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">();</span> <span class="n">c</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>            <span class="c1"># TimeSeries</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">tee</span><span class="p">()</span><span class="o">.</span><span class="n">crt</span><span class="p">():</span>                                 <span class="c1"># TimeSeries</span>
            <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">frac</span><span class="p">;</span> <span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">frac</span><span class="p">;</span> <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">frac</span> <span class="c1"># TimeSeries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getRaw</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="n">frac</span><span class="p">)</span> <span class="c1"># TimeSeries</span></div>
</div>

<span class="nd">@k1</span><span class="o">.</span><span class="n">cron</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delayedStart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ts_main&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="s2">&quot;k1.TimeSeries fast scan thread&quot;</span><span class="p">)</span> <span class="c1"># TimeSeries</span>
<span class="k">def</span> <span class="nf">_timeSeriesThread</span><span class="p">():</span>                                                         <span class="c1"># _timeSeriesThread</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_timeSeriesD</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>                                         <span class="c1"># _timeSeriesThread</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span> <span class="k">continue</span>                                         <span class="c1"># _timeSeriesThread</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="c1"># raw format: [time, idx, values, pack values]         # _timeSeriesThread</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_raw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># transfer new raw data to other buffers to be processed later # _timeSeriesThread</span>
            <span class="n">_raw</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_raw</span><span class="p">;</span> <span class="n">ts</span><span class="o">.</span><span class="n">_raw</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rateRaw</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_raw</span><span class="p">);</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rawRaw</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_raw</span><span class="p">)</span> <span class="c1"># _timeSeriesThread</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">vs</span><span class="p">,</span><span class="n">hvs</span> <span class="ow">in</span> <span class="n">_raw</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">_pertD</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">vs</span><span class="p">])</span>             <span class="c1"># _timeSeriesThread</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_rateRaw</span><span class="p">)</span>                                                     <span class="c1"># _timeSeriesThread</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c1"># at least 10 data points before collating, or 60 seconds passed and no more data # _timeSeriesThread</span>
            <span class="n">_rateRaw</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rateRaw</span><span class="p">;</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rateRaw</span> <span class="o">=</span> <span class="p">[]</span>                             <span class="c1"># _timeSeriesThread</span>
            <span class="n">_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rateRaw</span><span class="p">);</span> <span class="n">_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rateRaw</span><span class="p">);</span> <span class="n">deltaT</span> <span class="o">=</span> <span class="n">_max</span> <span class="o">-</span> <span class="n">_min</span> <span class="c1"># _timeSeriesThread</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_dbRate</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">_min</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">_rateRaw</span><span class="p">)</span><span class="o">/</span><span class="n">deltaT</span><span class="p">)</span>              <span class="c1"># _timeSeriesThread</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tvs</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_pertD</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>                                 <span class="c1"># _timeSeriesThread</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>                                                   <span class="c1"># _timeSeriesThread</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">_pertD</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvs</span><span class="p">);</span> <span class="n">data</span> <span class="o">=</span> <span class="n">tvs</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">T</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">vs</span><span class="p">:</span> <span class="p">[</span><span class="n">vs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vs</span><span class="p">[</span><span class="n">n</span><span class="o">//</span><span class="mi">10</span><span class="p">],</span> <span class="n">vs</span><span class="p">[</span><span class="n">n</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">vs</span><span class="p">[</span><span class="mi">9</span><span class="o">*</span><span class="n">n</span><span class="o">//</span><span class="mi">10</span><span class="p">],</span> <span class="n">vs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">joinSt</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">aS</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="c1"># _timeSeriesThread</span>
                <span class="n">ts</span><span class="o">.</span><span class="n">_dbPert</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">tvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="o">*</span><span class="n">data</span><span class="p">))</span> <span class="c1"># _timeSeriesThread</span>
        <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">storeRaw</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">_rawRaw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                                  <span class="c1"># _timeSeriesThread</span>
            <span class="n">rr</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rawRaw</span><span class="p">;</span> <span class="n">ts</span><span class="o">.</span><span class="n">_rawRaw</span> <span class="o">=</span> <span class="p">[]</span>                                     <span class="c1"># _timeSeriesThread</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;INSERT INTO raw ( time, idx, data ) VALUES &quot;&quot;&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">, ?)&quot;</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">vs</span><span class="p">,</span><span class="n">hvs</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">),</span> <span class="o">*</span><span class="p">[</span><span class="n">hvs</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">vs</span><span class="p">,</span><span class="n">hvs</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">])</span> <span class="c1"># _timeSeriesThread</span>
<span class="nd">@k1</span><span class="o">.</span><span class="n">cron</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">delayedStart</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ts_retention&quot;</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="s2">&quot;k1.TimeSeries slow scan thread for retention control&quot;</span><span class="p">)</span> <span class="c1"># _timeSeriesThread</span>
<span class="k">def</span> <span class="nf">_timeSeriesRetentionThread</span><span class="p">():</span> <span class="c1"># scans to see whether there&#39;s old outdated data in sqlite, and delete them and store in cold storage # _timeSeriesRetentionThread</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_timeSeriesD</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>                                         <span class="c1"># _timeSeriesRetentionThread</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ts</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span> <span class="k">continue</span>                                         <span class="c1"># _timeSeriesRetentionThread</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">();</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;select time from raw order by time limit 1&quot;</span><span class="p">)</span> <span class="c1"># _timeSeriesRetentionThread</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>                                              <span class="c1"># _timeSeriesRetentionThread</span>
        <span class="n">beginTime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                                                   <span class="c1"># _timeSeriesRetentionThread</span>
        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">beginTime</span> <span class="o">&gt;</span> <span class="n">ts</span><span class="o">.</span><span class="n">retention</span><span class="p">:</span>                                       <span class="c1"># _timeSeriesRetentionThread</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">retention</span> <span class="c1"># timestamp to slice off                      # _timeSeriesRetentionThread</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">coldStore</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">_dbRaw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;select time, idx, data from raw where time &lt; </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> order by time&quot;</span><span class="p">)</span> <span class="c1"># _timeSeriesRetentionThread</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">_dbRaw</span> <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete from raw  where time &lt; </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">ts</span><span class="o">.</span><span class="n">_dbPert</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete from pert where time &lt; </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">ts</span><span class="o">.</span><span class="n">_dbRate</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delete from rate where time &lt; </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># _timeSeriesRetentionThread</span>
            <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">coldStore</span><span class="p">:</span> <span class="n">data</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">data</span><span class="p">:</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;di&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cli</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ts</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">.cold&quot;</span><span class="p">)</span> <span class="c1"># _timeSeriesRetentionThread</span>
<span class="n">_speedAutoInc</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">AutoIncrement</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;_k1_speed_&quot;</span><span class="p">);</span> <span class="n">_speedData</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Dict[idx -&gt; {name, mod, fn, raw, refined}] # _timeSeriesRetentionThread</span>
<div class="viewcode-block" id="speed">
<a class="viewcode-back" href="../../base.html#k1lib.speed">[docs]</a>
<span class="k">class</span> <span class="nc">speed</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">BaseCli</span><span class="p">):</span>                                                        <span class="c1"># speed</span>
<div class="viewcode-block" id="speed.__init__">
<a class="viewcode-back" href="../../base.html#k1lib.speed.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coldStore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>          <span class="c1"># speed</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracks and benchmarks certain functions, and monitor them through time</span>
<span class="sd">with reports in order to deploy them absolutely everywhere. Example::</span>

<span class="sd">    @k1.speed(name=&quot;some func description&quot;)</span>
<span class="sd">    def f(x):</span>
<span class="sd">        return x*3</span>

<span class="sd">You can get a list of all speed k1.TimeSeries objects via ``k1.TimeSeries.allData``</span>

<span class="sd">:param name: optional name to show up in :meth:`allData`</span>
<span class="sd">:param fn: file name. If specified, will store speed data in sqlite database</span>
<span class="sd">    at this path, else store in memory</span>
<span class="sd">:param docs: optional docs to show up in :meth:`allData`</span>
<span class="sd">:param coldStore: if True, stores old speed data in condensed binary file. See more at :class:`TimeSeries`&quot;&quot;&quot;</span> <span class="c1"># speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">_speedAutoInc</span><span class="p">();</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">docs</span> <span class="o">=</span> <span class="n">docs</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">coldStore</span> <span class="o">=</span> <span class="n">coldStore</span> <span class="c1"># speed</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Can&#39;t have forward slash in the name&quot;</span><span class="p">)</span> <span class="c1"># speed</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>                                                       <span class="c1"># speed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_speedData</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has appeared before. Please use a different name&quot;</span><span class="p">)</span> <span class="c1"># speed</span>
        <span class="n">_speedData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span> <span class="n">k1</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;speed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">,</span> <span class="n">coldStore</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coldStore</span><span class="p">)}</span> <span class="c1"># speed</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;ts&quot;</span><span class="p">];</span> <span class="n">_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>                                   <span class="c1"># speed</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="n">beginTime</span> <span class="o">=</span> <span class="n">_time</span><span class="p">();</span> <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">beginTime</span><span class="p">;</span> <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span> <span class="k">return</span> <span class="n">res</span> <span class="c1"># speed</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span> <span class="k">return</span> <span class="n">wrapper</span>                     <span class="c1"># speed</span>
<div class="viewcode-block" id="speed.allData">
<a class="viewcode-back" href="../../base.html#k1lib.speed.allData">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># speed</span>
    <span class="k">def</span> <span class="nf">allData</span><span class="p">():</span> <span class="k">return</span> <span class="n">_speedData</span>                                             <span class="c1"># speed</span></div>

<div class="viewcode-block" id="speed.flask">
<a class="viewcode-back" href="../../base.html#k1lib.speed.flask">[docs]</a>
    <span class="nd">@staticmethod</span>                                                                <span class="c1"># speed</span>
    <span class="k">def</span> <span class="nf">flask</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                                                    <span class="c1"># speed</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attaches a speed management plane to a flask app.</span>
<span class="sd">Example::</span>

<span class="sd">    app = flask.Flask(__name__)</span>
<span class="sd">    k1.speed.flask(app)</span>
<span class="sd">    app.run(host=&quot;0.0.0.0&quot;, port=80)</span>

<span class="sd">Then, you can access the route &quot;/k1/speed&quot; to see an overview of all speed</span>
<span class="sd">benchmarks. However, doing ``k1.TimeSeries.flask(app)`` and access at &quot;/k1/ts&quot;</span>
<span class="sd">would be more beneficial, as that contains all the graphs and data</span>

<span class="sd">:param app: flask app object</span>
<span class="sd">:param kwargs: extra random kwargs that you want to add to ``app.route()`` function&quot;&quot;&quot;</span> <span class="c1"># speed</span>
        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/k1/speed&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                                        <span class="c1"># speed</span>
        <span class="k">def</span> <span class="nf">index</span><span class="p">():</span>                                                             <span class="c1"># speed</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">speed</span><span class="o">.</span><span class="n">allData</span><span class="p">();</span> <span class="n">ui1</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">|</span> <span class="o">~</span><span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">:</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">]),</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">]])</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">deref</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">toJsFunc</span><span class="p">(</span><span class="s2">&quot;term&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{term}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">k1</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">Table</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;func&#39;s name&quot;</span><span class="p">,</span> <span class="s2">&quot;func&#39;s file name&quot;</span><span class="p">,</span> <span class="s2">&quot;TimeSeries name&quot;</span><span class="p">,</span> <span class="s2">&quot;docs&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">sortF</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">op</span><span class="p">()</span><span class="o">.</span><span class="n">interface</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">toHtml</span><span class="p">()</span> <span class="c1"># speed</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;h1&gt;Speed&lt;/h1&gt;&lt;div style=&quot;overflow-x: auto&quot;&gt;</span><span class="si">{</span><span class="n">ui1</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;&quot;&quot;</span> <span class="c1"># speed</span></div>
</div>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>                                                       <span class="c1"># speed</span>
<span class="k">def</span> <span class="nf">idenContext</span><span class="p">():</span> <span class="k">yield</span> <span class="kc">True</span>                                                    <span class="c1"># idenContext</span>
<span class="n">_cextMods</span> <span class="o">=</span> <span class="p">{};</span> <span class="n">k1</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;cExt&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="o">.</span><span class="n">Settings</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;includes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;fstream&quot;</span><span class="p">,</span> <span class="s2">&quot;iostream&quot;</span><span class="p">,</span> <span class="s2">&quot;sstream&quot;</span><span class="p">,</span> <span class="s2">&quot;mutex&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span> <span class="s2">&quot;cmath&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">],</span> <span class="s2">&quot;header files to include&quot;</span><span class="p">),</span> <span class="s2">&quot;k1.compileCExt()-related settings&quot;</span><span class="p">);</span> <span class="c1"># idenContext</span>
<div class="viewcode-block" id="compileCExt">
<a class="viewcode-back" href="../../base.html#k1lib.compileCExt">[docs]</a>
<span class="k">def</span> <span class="nf">compileCExt</span><span class="p">(</span><span class="n">cppCode</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>                             <span class="c1"># compileCExt</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Conveniently compiles a python C extension module and returns it.</span>
<span class="sd">Example::</span>

<span class="sd">    mod = k1.compileCExt(\&quot;\&quot;\&quot;</span>
<span class="sd">        // pure math func, simple data types</span>
<span class="sd">        double func1(double x) { for (int i = 0; i &lt; 1000000; i++) x = std::cos(x); return x; }</span>
<span class="sd">        // takes in array</span>
<span class="sd">        double func2(std::vector&lt;double&gt;&amp; arr) { double sum = 0; for (auto v : arr) sum += v; return sum; }</span>
<span class="sd">        // returns array</span>
<span class="sd">        std::vector&lt;int&gt; func3(int x, int n) { std::vector&lt;int&gt; ans; for (int i = 0; i &lt; n; i++) ans.push_back(x+i); return ans; }</span>
<span class="sd">        // nested arrays</span>
<span class="sd">        std::vector&lt;std::vector&lt;int&gt;&gt; func4(int x, int n) {</span>
<span class="sd">            std::vector&lt;std::vector&lt;int&gt;&gt; ans; std::vector&lt;int&gt; ans1, ans2;</span>
<span class="sd">            for (int i = 0; i &lt; n; i++) ans1.push_back(x+i);</span>
<span class="sd">            for (int i = 0; i &lt; n; i++) ans2.push_back(x+i*2);</span>
<span class="sd">            ans.push_back(ans1); ans.push_back(ans2); return ans;</span>
<span class="sd">        }</span>
<span class="sd">        // complex string manipulation, splitting things like &quot;A,3\\nB,4&quot;, std::vector&lt;std::pair&lt;std::string, int&gt;&gt;</span>
<span class="sd">        std::vector&lt;std::pair&lt;std::string, int&gt;&gt; func5(std::string text) {</span>
<span class="sd">            std::vector&lt;std::pair&lt;std::string, int&gt;&gt; ans; std::string line;</span>
<span class="sd">            std::istringstream f(text); std::pair&lt;std::string, int&gt; pair;</span>
<span class="sd">            while (std::getline(f, line)) {</span>
<span class="sd">                int pos = line.find(&quot;,&quot;); pair.first = line.substr(0, pos);</span>
<span class="sd">                pair.second = std::stoi(line.substr(pos+1)); ans.push_back(pair);</span>
<span class="sd">            } return ans;</span>
<span class="sd">        }</span>

<span class="sd">        PYBIND11_MODULE(genM1, m) {</span>
<span class="sd">            m.def(&quot;func1&quot;, &amp;func1); m.def(&quot;func2&quot;, &amp;func2); m.def(&quot;func3&quot;, &amp;func3);</span>
<span class="sd">            m.def(&quot;func4&quot;, &amp;func4); m.def(&quot;func5&quot;, &amp;func5);</span>
<span class="sd">    }\&quot;\&quot;\&quot;, &quot;genM1&quot;, verbose=True) # this takes around 15s to run. Yes it&#39;s slow, but it works</span>

<span class="sd">    # python-equivalent functions</span>
<span class="sd">    def func1(x):</span>
<span class="sd">        for i in range(1000000): x = math.cos(x)</span>
<span class="sd">        return x</span>
<span class="sd">    def func2(arr): return sum(arr)</span>
<span class="sd">    def func3(x, n): return [x+i for i in range(n)]</span>
<span class="sd">    def func4(x, n): return [[x+i for i in range(n)], [x+i*2 for i in range(n)]]</span>
<span class="sd">    def func5(s): return [(x, int(y)) for x,y in [x.split(&quot;,&quot;) for x in s.split(&quot;\\n&quot;)]]</span>

<span class="sd">    mod.func1(3)     # 22.8 ms  1.83 ms, 7.6x faster</span>
<span class="sd">    func1(3)         # 174 ms  24.1 ms</span>

<span class="sd">    x = list(range(100))</span>
<span class="sd">    mod.func2(x)     # 7.25 s  761 ns, 3.1x slower</span>
<span class="sd">    func2(x)         # 2.33 s  299 ns</span>

<span class="sd">    mod.func3(3, 10) # 1.16 s  97 ns, 1.2x slower</span>
<span class="sd">    func3(3, 10)     # 946 ns  128 ns</span>

<span class="sd">    mod.func4(3, 10) # 2.23 s  188 ns, 1.25x faster</span>
<span class="sd">    func4(3, 10)     # 2.78 s  292 ns</span>

<span class="sd">    s = &quot;A,3\\nB,4\\nC,5\\nD,6\\nE,7\\nF,8\\nG,9&quot;</span>
<span class="sd">    mod.func5(s)     # 4.5 s  286 ns, 1.07x faster</span>
<span class="sd">    func5(s)         # 4.81 s  866 ns</span>

<span class="sd">Behind the scenes, this function generates a C source file, compiles it into a</span>
<span class="sd">python C extension module, then loads it in the current interpreter session. So</span>
<span class="sd">purpose of this is to very quickly drop down to C whenever the need arises.</span>
<span class="sd">Solutions like Cython is neat and all, but it&#39;s quite awkward to code in, and</span>
<span class="sd">doesn&#39;t have the full power of C++. Meanwhile, doing it like this gives you full</span>
<span class="sd">C++ features, as well as an easy python binding interface via pybind11.</span>

<span class="sd">Several header files are included by default, so you don&#39;t have to include them, like</span>
<span class="sd">&lt;string&gt;, &lt;fstream&gt;, etc. A list of them are in ``settings.cExt.includes``. You can</span>
<span class="sd">get a dict of all compiled modules via ``k1.compileCExt.mods()``</span>

<span class="sd">Also, as you can see from the tiny benchmark results, it&#39;s not always faster to use</span>
<span class="sd">the C version, if input and output translation operations takes longer than the</span>
<span class="sd">function itself. So although there&#39;s a lot of potential for speedups, you have to</span>
<span class="sd">be really careful about this, or else you risk slowing it down and wasting a bunch</span>
<span class="sd">of time.</span>

<span class="sd">:param cppCode: C++ source code. Common headers are included</span>
<span class="sd">:param moduleName: name of the module&quot;&quot;&quot;</span>                                         <span class="c1"># compileCExt</span>
    <span class="c1"># code mostly written by ChatGPT 4o. Verified to work tho                    # compileCExt</span>
    <span class="kn">import</span> <span class="nn">pybind11</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span><span class="p">;</span> <span class="kn">from</span> <span class="nn">setuptools.command.build_ext</span> <span class="kn">import</span> <span class="n">build_ext</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">importlib.util</span><span class="p">;</span> <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span> <span class="c1"># compileCExt</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;temp_dir: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="n">incls</span> <span class="o">=</span> <span class="n">k1</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">cExt</span><span class="o">.</span><span class="n">includes</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;#include &lt;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># compileCExt</span>
    <span class="n">cpp_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;#include &lt;pybind11/pybind11.h&gt;</span><span class="se">\n</span><span class="s2">#include &lt;pybind11/stl.h&gt;</span><span class="se">\n</span><span class="s2">namespace py = pybind11;</span><span class="se">\n</span><span class="si">{</span><span class="n">incls</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">cppCode</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">moduleName</span><span class="si">}</span><span class="s2">.cpp&quot;</span><span class="p">))</span> <span class="c1"># compileCExt</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="n">cpp_file</span><span class="p">],</span> <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">pybind11</span><span class="o">.</span><span class="n">get_include</span><span class="p">()],</span> <span class="n">language</span><span class="o">=</span><span class="s2">&quot;c++&quot;</span><span class="p">,</span> <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-O3&quot;</span><span class="p">,</span> <span class="s2">&quot;-std=c++17&quot;</span><span class="p">])]</span> <span class="c1"># compileCExt</span>
    <span class="k">class</span> <span class="nc">BuildExt</span><span class="p">(</span><span class="n">build_ext</span><span class="p">):</span>                                                   <span class="c1"># compileCExt</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="n">build_ext</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>                                       <span class="c1"># compileCExt</span>
        <span class="k">def</span> <span class="nf">build_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span> <span class="n">ext_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ext_fullpath</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">name</span><span class="p">);</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ext_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">build_ext</span><span class="o">.</span><span class="n">build_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span> <span class="c1"># compileCExt</span>
    <span class="k">with</span> <span class="p">(</span><span class="n">idenContext</span><span class="p">()</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">k1</span><span class="o">.</span><span class="n">captureStdout</span><span class="p">()):</span>                     <span class="c1"># compileCExt</span>
        <span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">moduleName</span><span class="p">,</span> <span class="n">ext_modules</span><span class="o">=</span><span class="n">ext_modules</span><span class="p">,</span> <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;build_ext&quot;</span><span class="p">:</span> <span class="n">BuildExt</span><span class="p">},</span> <span class="n">script_args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;build_ext&quot;</span><span class="p">,</span> <span class="s2">&quot;--inplace&quot;</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;build_ext&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;build_lib&quot;</span><span class="p">:</span> <span class="n">temp_dir</span><span class="p">}});</span> <span class="n">so_file</span> <span class="o">=</span> <span class="n">temp_dir</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="s2">&quot;cpython&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">cli</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="c1"># compileCExt</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span> <span class="n">so_file</span><span class="p">);</span> <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">);</span> <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">);</span> <span class="n">_cextMods</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span> <span class="k">return</span> <span class="n">module</span> <span class="c1"># compileCExt</span></div>

<span class="n">compileCExt</span><span class="o">.</span><span class="n">mods</span> <span class="o">=</span> <span class="n">_cextMods</span>                                                     <span class="c1"># compileCExt</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Quang Ho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>